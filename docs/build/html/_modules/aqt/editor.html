

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>aqt.editor &mdash; Anki  documentation</title>
  

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />

  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/language_data.js"></script>
        <script async="async" kind="hypothesis" src="https://hypothes.is/embed.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home" alt="Documentation Home"> Anki
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../anki.html">anki package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../anki.importing.html">anki.importing package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../aqt.html">aqt package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../genhooks_gui.html">genhooks_gui module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tools.html">tools package</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Anki</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
          <li><a href="../aqt.html">aqt</a> &raquo;</li>
        
      <li>aqt.editor</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for aqt.editor</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="c1"># Copyright: Ankitects Pty Ltd and contributors</span>
<span class="c1"># License: GNU AGPL, version 3 or later; http://www.gnu.org/licenses/agpl.html</span>
<span class="kn">import</span> <span class="nn">base64</span>
<span class="kn">import</span> <span class="nn">html</span>
<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">mimetypes</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">urllib.error</span>
<span class="kn">import</span> <span class="nn">urllib.parse</span>
<span class="kn">import</span> <span class="nn">urllib.request</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Tuple</span>

<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">from</span> <span class="nn">bs4</span> <span class="kn">import</span> <span class="n">BeautifulSoup</span>

<span class="kn">import</span> <span class="nn">aqt</span>
<span class="kn">import</span> <span class="nn">aqt.sound</span>
<span class="kn">from</span> <span class="nn">anki.cards</span> <span class="kn">import</span> <span class="n">Card</span>
<span class="kn">from</span> <span class="nn">anki.hooks</span> <span class="kn">import</span> <span class="n">runFilter</span>
<span class="kn">from</span> <span class="nn">anki.httpclient</span> <span class="kn">import</span> <span class="n">HttpClient</span>
<span class="kn">from</span> <span class="nn">anki.lang</span> <span class="kn">import</span> <span class="n">_</span>
<span class="kn">from</span> <span class="nn">anki.notes</span> <span class="kn">import</span> <span class="n">Note</span>
<span class="kn">from</span> <span class="nn">anki.utils</span> <span class="kn">import</span> <span class="n">checksum</span><span class="p">,</span> <span class="n">isLin</span><span class="p">,</span> <span class="n">isWin</span><span class="p">,</span> <span class="n">namedtmp</span><span class="p">,</span> <span class="n">stripHTMLMedia</span>
<span class="kn">from</span> <span class="nn">aqt</span> <span class="kn">import</span> <span class="n">AnkiQt</span><span class="p">,</span> <span class="n">gui_hooks</span>
<span class="kn">from</span> <span class="nn">aqt.qt</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">aqt.sound</span> <span class="kn">import</span> <span class="n">av_player</span><span class="p">,</span> <span class="n">getAudio</span>
<span class="kn">from</span> <span class="nn">aqt.theme</span> <span class="kn">import</span> <span class="n">theme_manager</span>
<span class="kn">from</span> <span class="nn">aqt.utils</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">getFile</span><span class="p">,</span>
    <span class="n">openHelp</span><span class="p">,</span>
    <span class="n">qtMenuShortcutWorkaround</span><span class="p">,</span>
    <span class="n">restoreGeom</span><span class="p">,</span>
    <span class="n">saveGeom</span><span class="p">,</span>
    <span class="n">shortcut</span><span class="p">,</span>
    <span class="n">showInfo</span><span class="p">,</span>
    <span class="n">showWarning</span><span class="p">,</span>
    <span class="n">tooltip</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">aqt.webview</span> <span class="kn">import</span> <span class="n">AnkiWebView</span>

<span class="n">pics</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;jpg&quot;</span><span class="p">,</span> <span class="s2">&quot;jpeg&quot;</span><span class="p">,</span> <span class="s2">&quot;png&quot;</span><span class="p">,</span> <span class="s2">&quot;tif&quot;</span><span class="p">,</span> <span class="s2">&quot;tiff&quot;</span><span class="p">,</span> <span class="s2">&quot;gif&quot;</span><span class="p">,</span> <span class="s2">&quot;svg&quot;</span><span class="p">,</span> <span class="s2">&quot;webp&quot;</span><span class="p">)</span>
<span class="n">audio</span> <span class="o">=</span> <span class="p">(</span>
    <span class="s2">&quot;wav&quot;</span><span class="p">,</span>
    <span class="s2">&quot;mp3&quot;</span><span class="p">,</span>
    <span class="s2">&quot;ogg&quot;</span><span class="p">,</span>
    <span class="s2">&quot;flac&quot;</span><span class="p">,</span>
    <span class="s2">&quot;mp4&quot;</span><span class="p">,</span>
    <span class="s2">&quot;swf&quot;</span><span class="p">,</span>
    <span class="s2">&quot;mov&quot;</span><span class="p">,</span>
    <span class="s2">&quot;mpeg&quot;</span><span class="p">,</span>
    <span class="s2">&quot;mkv&quot;</span><span class="p">,</span>
    <span class="s2">&quot;m4a&quot;</span><span class="p">,</span>
    <span class="s2">&quot;3gp&quot;</span><span class="p">,</span>
    <span class="s2">&quot;spx&quot;</span><span class="p">,</span>
    <span class="s2">&quot;oga&quot;</span><span class="p">,</span>
    <span class="s2">&quot;webm&quot;</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">_html</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">&lt;style&gt;</span>
<span class="s2">html { background: </span><span class="si">%s</span><span class="s2">; }</span>
<span class="s2">#topbutsOuter { background: </span><span class="si">%s</span><span class="s2">; }</span>
<span class="s2">&lt;/style&gt;</span>
<span class="s2">&lt;div id=&quot;topbutsOuter&quot;&gt;</span>
<span class="s2">    &lt;div id=&quot;topbuts&quot; class=&quot;clearfix&quot;&gt;</span>
<span class="si">%s</span><span class="s2"></span>
<span class="s2">    &lt;/div&gt;</span>
<span class="s2">&lt;/div&gt;</span>
<span class="s2">&lt;div id=&quot;fields&quot;&gt;</span>
<span class="s2">&lt;/div&gt;</span>
<span class="s2">&lt;div id=&quot;dupes&quot; style=&quot;display:none;&quot;&gt;</span>
<span class="s2">    &lt;a href=&quot;#&quot; onclick=&quot;pycmd(&#39;dupes&#39;);return false;&quot;&gt;</span>
<span class="si">%s</span><span class="s2"></span>
<span class="s2">    &lt;/a&gt;</span>
<span class="s2">&lt;/div&gt;</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="c1"># caller is responsible for resetting note on reset</span>
<div class="viewcode-block" id="Editor"><a class="viewcode-back" href="../../aqt.html#aqt.editor.Editor">[docs]</a><span class="k">class</span> <span class="nc">Editor</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mw</span><span class="p">:</span> <span class="n">AnkiQt</span><span class="p">,</span> <span class="n">widget</span><span class="p">,</span> <span class="n">parentWindow</span><span class="p">,</span> <span class="n">addMode</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mw</span> <span class="o">=</span> <span class="n">mw</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">widget</span> <span class="o">=</span> <span class="n">widget</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parentWindow</span> <span class="o">=</span> <span class="n">parentWindow</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">note</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Note</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addMode</span> <span class="o">=</span> <span class="n">addMode</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">currentField</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># current card, for card layout</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">card</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Card</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setupOuter</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setupWeb</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setupShortcuts</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setupTags</span><span class="p">()</span>
        <span class="n">gui_hooks</span><span class="o">.</span><span class="n">editor_did_init</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="c1"># Initial setup</span>
    <span class="c1">############################################################</span>

<div class="viewcode-block" id="Editor.setupOuter"><a class="viewcode-back" href="../../aqt.html#aqt.editor.Editor.setupOuter">[docs]</a>    <span class="k">def</span> <span class="nf">setupOuter</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">l</span> <span class="o">=</span> <span class="n">QVBoxLayout</span><span class="p">()</span>
        <span class="n">l</span><span class="o">.</span><span class="n">setContentsMargins</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">l</span><span class="o">.</span><span class="n">setSpacing</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">widget</span><span class="o">.</span><span class="n">setLayout</span><span class="p">(</span><span class="n">l</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">outerLayout</span> <span class="o">=</span> <span class="n">l</span></div>

<div class="viewcode-block" id="Editor.setupWeb"><a class="viewcode-back" href="../../aqt.html#aqt.editor.Editor.setupWeb">[docs]</a>    <span class="k">def</span> <span class="nf">setupWeb</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">web</span> <span class="o">=</span> <span class="n">EditorWebView</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">widget</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">allowDrops</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">set_bridge_command</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">onBridgeCmd</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">outerLayout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">web</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="n">righttopbtns</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_addButton</span><span class="p">(</span><span class="s2">&quot;text_bold&quot;</span><span class="p">,</span> <span class="s2">&quot;bold&quot;</span><span class="p">,</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Bold text (Ctrl+B)&quot;</span><span class="p">),</span> <span class="nb">id</span><span class="o">=</span><span class="s2">&quot;bold&quot;</span><span class="p">),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_addButton</span><span class="p">(</span>
                <span class="s2">&quot;text_italic&quot;</span><span class="p">,</span> <span class="s2">&quot;italic&quot;</span><span class="p">,</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Italic text (Ctrl+I)&quot;</span><span class="p">),</span> <span class="nb">id</span><span class="o">=</span><span class="s2">&quot;italic&quot;</span>
            <span class="p">),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_addButton</span><span class="p">(</span>
                <span class="s2">&quot;text_under&quot;</span><span class="p">,</span> <span class="s2">&quot;underline&quot;</span><span class="p">,</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Underline text (Ctrl+U)&quot;</span><span class="p">),</span> <span class="nb">id</span><span class="o">=</span><span class="s2">&quot;underline&quot;</span>
            <span class="p">),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_addButton</span><span class="p">(</span>
                <span class="s2">&quot;text_super&quot;</span><span class="p">,</span> <span class="s2">&quot;super&quot;</span><span class="p">,</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Superscript (Ctrl++)&quot;</span><span class="p">),</span> <span class="nb">id</span><span class="o">=</span><span class="s2">&quot;superscript&quot;</span>
            <span class="p">),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_addButton</span><span class="p">(</span><span class="s2">&quot;text_sub&quot;</span><span class="p">,</span> <span class="s2">&quot;sub&quot;</span><span class="p">,</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Subscript (Ctrl+=)&quot;</span><span class="p">),</span> <span class="nb">id</span><span class="o">=</span><span class="s2">&quot;subscript&quot;</span><span class="p">),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_addButton</span><span class="p">(</span><span class="s2">&quot;text_clear&quot;</span><span class="p">,</span> <span class="s2">&quot;clear&quot;</span><span class="p">,</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Remove formatting (Ctrl+R)&quot;</span><span class="p">)),</span>
        <span class="p">]</span>
        <span class="c1"># The color selection buttons do not use an icon so the HTML must be specified manually</span>
        <span class="n">tip</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Set foreground colour (F7)&quot;</span><span class="p">)</span>
        <span class="n">righttopbtns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="sd">&quot;&quot;&quot; &lt;button tabindex=-1</span>
<span class="sd">                        class=linkb</span>
<span class="sd">                        title=&quot;{}&quot;</span>
<span class="sd">                        type=&quot;button&quot;</span>
<span class="sd">                        onclick=&quot;pycmd(&#39;colour&#39;); return false;&quot;</span>
<span class="sd">                &gt;</span>
<span class="sd">                    &lt;div id=forecolor</span>
<span class="sd">                         style=&quot;display:inline-block; background: #000;border-radius: 5px;&quot;</span>
<span class="sd">                         class=topbut</span>
<span class="sd">                    &gt;</span>
<span class="sd">                    &lt;/div&gt;</span>
<span class="sd">                &lt;/button&gt;&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">tip</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="n">tip</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Change colour (F8)&quot;</span><span class="p">)</span>
        <span class="n">righttopbtns</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="sd">&quot;&quot;&quot;&lt;button tabindex=-1</span>
<span class="sd">                        class=linkb</span>
<span class="sd">                        title=&quot;{}&quot;</span>
<span class="sd">                        type=&quot;button&quot;</span>
<span class="sd">                        onclick=&quot;pycmd(&#39;changeCol&#39;);return false;&quot;</span>
<span class="sd">                &gt;</span>
<span class="sd">                    &lt;div style=&quot;display:inline-block; border-radius: 5px;&quot;</span>
<span class="sd">                         class=&quot;topbut rainbow&quot;</span>
<span class="sd">                    &gt;</span>
<span class="sd">                    &lt;/div&gt;</span>
<span class="sd">                &lt;/button&gt;&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">tip</span>
                <span class="p">),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_addButton</span><span class="p">(</span>
                    <span class="s2">&quot;text_cloze&quot;</span><span class="p">,</span> <span class="s2">&quot;cloze&quot;</span><span class="p">,</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Cloze deletion (Ctrl+Shift+C)&quot;</span><span class="p">)</span>
                <span class="p">),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_addButton</span><span class="p">(</span>
                    <span class="s2">&quot;paperclip&quot;</span><span class="p">,</span> <span class="s2">&quot;attach&quot;</span><span class="p">,</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Attach pictures/audio/video (F3)&quot;</span><span class="p">)</span>
                <span class="p">),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_addButton</span><span class="p">(</span><span class="s2">&quot;media-record&quot;</span><span class="p">,</span> <span class="s2">&quot;record&quot;</span><span class="p">,</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Record audio (F5)&quot;</span><span class="p">)),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_addButton</span><span class="p">(</span><span class="s2">&quot;more&quot;</span><span class="p">,</span> <span class="s2">&quot;more&quot;</span><span class="p">),</span>
            <span class="p">]</span>
        <span class="p">)</span>
        <span class="n">gui_hooks</span><span class="o">.</span><span class="n">editor_did_init_buttons</span><span class="p">(</span><span class="n">righttopbtns</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
        <span class="c1"># legacy filter</span>
        <span class="n">righttopbtns</span> <span class="o">=</span> <span class="n">runFilter</span><span class="p">(</span><span class="s2">&quot;setupEditorButtons&quot;</span><span class="p">,</span> <span class="n">righttopbtns</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
        <span class="n">topbuts</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            &lt;div id=&quot;topbutsleft&quot; style=&quot;float:left;&quot;&gt;</span>
<span class="s2">                &lt;button title=&#39;</span><span class="si">%(fldsTitle)s</span><span class="s2">&#39; onclick=&quot;pycmd(&#39;fields&#39;)&quot;&gt;</span><span class="si">%(flds)s</span><span class="s2">...&lt;/button&gt;</span>
<span class="s2">                &lt;button title=&#39;</span><span class="si">%(cardsTitle)s</span><span class="s2">&#39; onclick=&quot;pycmd(&#39;cards&#39;)&quot;&gt;</span><span class="si">%(cards)s</span><span class="s2">...&lt;/button&gt;</span>
<span class="s2">            &lt;/div&gt;</span>
<span class="s2">            &lt;div id=&quot;topbutsright&quot; style=&quot;float:right;&quot;&gt;</span>
<span class="s2">                </span><span class="si">%(rightbts)s</span><span class="s2"></span>
<span class="s2">            &lt;/div&gt;</span>
<span class="s2">        &quot;&quot;&quot;</span> <span class="o">%</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="n">flds</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;Fields&quot;</span><span class="p">),</span>
            <span class="n">cards</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;Cards&quot;</span><span class="p">),</span>
            <span class="n">rightbts</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">righttopbtns</span><span class="p">),</span>
            <span class="n">fldsTitle</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;Customize Fields&quot;</span><span class="p">),</span>
            <span class="n">cardsTitle</span><span class="o">=</span><span class="n">shortcut</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;Customize Card Templates (Ctrl+L)&quot;</span><span class="p">)),</span>
        <span class="p">)</span>
        <span class="n">bgcol</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mw</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">palette</span><span class="p">()</span><span class="o">.</span><span class="n">window</span><span class="p">()</span><span class="o">.</span><span class="n">color</span><span class="p">()</span><span class="o">.</span><span class="n">name</span><span class="p">()</span>  <span class="c1"># type: ignore</span>
        <span class="c1"># then load page</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">stdHtml</span><span class="p">(</span>
            <span class="n">_html</span> <span class="o">%</span> <span class="p">(</span><span class="n">bgcol</span><span class="p">,</span> <span class="n">bgcol</span><span class="p">,</span> <span class="n">topbuts</span><span class="p">,</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Show Duplicates&quot;</span><span class="p">)),</span>
            <span class="n">css</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;editor.css&quot;</span><span class="p">],</span>
            <span class="n">js</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;jquery.js&quot;</span><span class="p">,</span> <span class="s2">&quot;editor.js&quot;</span><span class="p">],</span>
            <span class="n">context</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
        <span class="p">)</span></div>

    <span class="c1"># Top buttons</span>
    <span class="c1">######################################################################</span>

<div class="viewcode-block" id="Editor.resourceToData"><a class="viewcode-back" href="../../aqt.html#aqt.editor.Editor.resourceToData">[docs]</a>    <span class="k">def</span> <span class="nf">resourceToData</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Convert a file (specified by a path) into a data URI.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">FileNotFoundError</span>
        <span class="n">mime</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">mimetypes</span><span class="o">.</span><span class="n">guess_type</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">fp</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
            <span class="n">data64</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base64</span><span class="o">.</span><span class="n">encodebytes</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">splitlines</span><span class="p">())</span>
            <span class="k">return</span> <span class="s2">&quot;data:</span><span class="si">%s</span><span class="s2">;base64,</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">mime</span><span class="p">,</span> <span class="n">data64</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;ascii&quot;</span><span class="p">))</span></div>

<div class="viewcode-block" id="Editor.addButton"><a class="viewcode-back" href="../../aqt.html#aqt.editor.Editor.addButton">[docs]</a>    <span class="k">def</span> <span class="nf">addButton</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">icon</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">cmd</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">func</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="s2">&quot;Editor&quot;</span><span class="p">],</span> <span class="kc">None</span><span class="p">],</span>
        <span class="n">tip</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="n">label</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="nb">id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">toggleable</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">keys</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">disables</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Assign func to bridge cmd, register shortcut, return button&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">func</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_links</span><span class="p">[</span><span class="n">cmd</span><span class="p">]</span> <span class="o">=</span> <span class="n">func</span>
        <span class="k">if</span> <span class="n">keys</span><span class="p">:</span>
            <span class="n">QShortcut</span><span class="p">(</span>  <span class="c1"># type: ignore</span>
                <span class="n">QKeySequence</span><span class="p">(</span><span class="n">keys</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">widget</span><span class="p">,</span> <span class="n">activated</span><span class="o">=</span><span class="k">lambda</span> <span class="n">s</span><span class="o">=</span><span class="bp">self</span><span class="p">:</span> <span class="n">func</span><span class="p">(</span><span class="n">s</span><span class="p">),</span>
            <span class="p">)</span>
        <span class="n">btn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_addButton</span><span class="p">(</span>
            <span class="n">icon</span><span class="p">,</span>
            <span class="n">cmd</span><span class="p">,</span>
            <span class="n">tip</span><span class="o">=</span><span class="n">tip</span><span class="p">,</span>
            <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span>
            <span class="nb">id</span><span class="o">=</span><span class="nb">id</span><span class="p">,</span>
            <span class="n">toggleable</span><span class="o">=</span><span class="n">toggleable</span><span class="p">,</span>
            <span class="n">disables</span><span class="o">=</span><span class="n">disables</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">btn</span></div>

    <span class="k">def</span> <span class="nf">_addButton</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">icon</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">cmd</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">tip</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="n">label</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="nb">id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">toggleable</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">disables</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="k">if</span> <span class="n">icon</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">icon</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;qrc:/&quot;</span><span class="p">):</span>
                <span class="n">iconstr</span> <span class="o">=</span> <span class="n">icon</span>
            <span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isabs</span><span class="p">(</span><span class="n">icon</span><span class="p">):</span>
                <span class="n">iconstr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">resourceToData</span><span class="p">(</span><span class="n">icon</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">iconstr</span> <span class="o">=</span> <span class="s2">&quot;/_anki/imgs/</span><span class="si">{}</span><span class="s2">.png&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">icon</span><span class="p">)</span>
            <span class="n">imgelm</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;&lt;img class=topbut src=&quot;</span><span class="si">{}</span><span class="s2">&quot;&gt;&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">iconstr</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">imgelm</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">if</span> <span class="n">label</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">imgelm</span><span class="p">:</span>
            <span class="n">labelelm</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;&lt;span class=blabel&gt;</span><span class="si">{}</span><span class="s2">&lt;/span&gt;&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">label</span> <span class="ow">or</span> <span class="n">cmd</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">labelelm</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">id</span><span class="p">:</span>
            <span class="n">idstr</span> <span class="o">=</span> <span class="s2">&quot;id=</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">idstr</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">if</span> <span class="n">toggleable</span><span class="p">:</span>
            <span class="n">toggleScript</span> <span class="o">=</span> <span class="s2">&quot;toggleEditorButton(this);&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">toggleScript</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="n">tip</span> <span class="o">=</span> <span class="n">shortcut</span><span class="p">(</span><span class="n">tip</span><span class="p">)</span>
        <span class="n">theclass</span> <span class="o">=</span> <span class="s2">&quot;linkb&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">disables</span><span class="p">:</span>
            <span class="n">theclass</span> <span class="o">+=</span> <span class="s2">&quot; perm&quot;</span>
        <span class="k">return</span> <span class="s2">&quot;&quot;&quot; &lt;button tabindex=-1</span>
<span class="s2">                        </span><span class="si">{id}</span><span class="s2"></span>
<span class="s2">                        class=&quot;</span><span class="si">{theclass}</span><span class="s2">&quot;</span>
<span class="s2">                        type=&quot;button&quot;</span>
<span class="s2">                        title=&quot;</span><span class="si">{tip}</span><span class="s2">&quot;</span>
<span class="s2">                        onclick=&quot;pycmd(&#39;</span><span class="si">{cmd}</span><span class="s2">&#39;);</span><span class="si">{togglesc}</span><span class="s2">return false;&quot;</span>
<span class="s2">                &gt;</span>
<span class="s2">                    </span><span class="si">{imgelm}</span><span class="s2"></span>
<span class="s2">                    </span><span class="si">{labelelm}</span><span class="s2"></span>
<span class="s2">                &lt;/button&gt;&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">imgelm</span><span class="o">=</span><span class="n">imgelm</span><span class="p">,</span>
            <span class="n">cmd</span><span class="o">=</span><span class="n">cmd</span><span class="p">,</span>
            <span class="n">tip</span><span class="o">=</span><span class="n">tip</span><span class="p">,</span>
            <span class="n">labelelm</span><span class="o">=</span><span class="n">labelelm</span><span class="p">,</span>
            <span class="nb">id</span><span class="o">=</span><span class="n">idstr</span><span class="p">,</span>
            <span class="n">togglesc</span><span class="o">=</span><span class="n">toggleScript</span><span class="p">,</span>
            <span class="n">theclass</span><span class="o">=</span><span class="n">theclass</span><span class="p">,</span>
        <span class="p">)</span>

<div class="viewcode-block" id="Editor.setupShortcuts"><a class="viewcode-back" href="../../aqt.html#aqt.editor.Editor.setupShortcuts">[docs]</a>    <span class="k">def</span> <span class="nf">setupShortcuts</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># if a third element is provided, enable shortcut even when no field selected</span>
        <span class="n">cuts</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span><span class="s2">&quot;Ctrl+L&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">onCardLayout</span><span class="p">,</span> <span class="kc">True</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;Ctrl+B&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">toggleBold</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;Ctrl+I&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">toggleItalic</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;Ctrl+U&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">toggleUnderline</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;Ctrl++&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">toggleSuper</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;Ctrl+=&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">toggleSub</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;Ctrl+R&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">removeFormat</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;F7&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">onForeground</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;F8&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">onChangeCol</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;Ctrl+Shift+C&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">onCloze</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;Ctrl+Shift+Alt+C&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">onCloze</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;F3&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">onAddMedia</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;F5&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">onRecSound</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;Ctrl+T, T&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">insertLatex</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;Ctrl+T, E&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">insertLatexEqn</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;Ctrl+T, M&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">insertLatexMathEnv</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;Ctrl+M, M&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">insertMathjaxInline</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;Ctrl+M, E&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">insertMathjaxBlock</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;Ctrl+M, C&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">insertMathjaxChemistry</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;Ctrl+Shift+X&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">onHtmlEdit</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;Ctrl+Shift+T&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">onFocusTags</span><span class="p">,</span> <span class="kc">True</span><span class="p">),</span>
        <span class="p">]</span>
        <span class="n">gui_hooks</span><span class="o">.</span><span class="n">editor_did_init_shortcuts</span><span class="p">(</span><span class="n">cuts</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">cuts</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">row</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">keys</span><span class="p">,</span> <span class="n">fn</span> <span class="o">=</span> <span class="n">row</span>  <span class="c1"># pylint: disable=unbalanced-tuple-unpacking</span>
                <span class="n">fn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_addFocusCheck</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">keys</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">row</span>
            <span class="n">QShortcut</span><span class="p">(</span><span class="n">QKeySequence</span><span class="p">(</span><span class="n">keys</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">widget</span><span class="p">,</span> <span class="n">activated</span><span class="o">=</span><span class="n">fn</span><span class="p">)</span>  <span class="c1"># type: ignore</span></div>

    <span class="k">def</span> <span class="nf">_addFocusCheck</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fn</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">checkFocus</span><span class="p">():</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">currentField</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span>
            <span class="n">fn</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">checkFocus</span>

<div class="viewcode-block" id="Editor.onFields"><a class="viewcode-back" href="../../aqt.html#aqt.editor.Editor.onFields">[docs]</a>    <span class="k">def</span> <span class="nf">onFields</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">saveNow</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_onFields</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_onFields</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">aqt.fields</span> <span class="kn">import</span> <span class="n">FieldDialog</span>

        <span class="n">FieldDialog</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mw</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">note</span><span class="o">.</span><span class="n">model</span><span class="p">(),</span> <span class="n">parent</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">parentWindow</span><span class="p">)</span>

<div class="viewcode-block" id="Editor.onCardLayout"><a class="viewcode-back" href="../../aqt.html#aqt.editor.Editor.onCardLayout">[docs]</a>    <span class="k">def</span> <span class="nf">onCardLayout</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">saveNow</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_onCardLayout</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_onCardLayout</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">aqt.clayout</span> <span class="kn">import</span> <span class="n">CardLayout</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">card</span><span class="p">:</span>
            <span class="nb">ord</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">card</span><span class="o">.</span><span class="n">ord</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">ord</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">CardLayout</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mw</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">note</span><span class="p">,</span>
            <span class="nb">ord</span><span class="o">=</span><span class="nb">ord</span><span class="p">,</span>
            <span class="n">parent</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">parentWindow</span><span class="p">,</span>
            <span class="n">fill_empty</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">addMode</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">isWin</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parentWindow</span><span class="o">.</span><span class="n">activateWindow</span><span class="p">()</span>

    <span class="c1"># JS-&gt;Python bridge</span>
    <span class="c1">######################################################################</span>

<div class="viewcode-block" id="Editor.onBridgeCmd"><a class="viewcode-back" href="../../aqt.html#aqt.editor.Editor.onBridgeCmd">[docs]</a>    <span class="k">def</span> <span class="nf">onBridgeCmd</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cmd</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">note</span><span class="p">:</span>
            <span class="c1"># shutdown</span>
            <span class="k">return</span>
        <span class="c1"># focus lost or key/button pressed?</span>
        <span class="k">if</span> <span class="n">cmd</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;blur&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">cmd</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;key&quot;</span><span class="p">):</span>
            <span class="p">(</span><span class="nb">type</span><span class="p">,</span> <span class="nb">ord</span><span class="p">,</span> <span class="n">nid</span><span class="p">,</span> <span class="n">txt</span><span class="p">)</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
            <span class="nb">ord</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">ord</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">nid</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">nid</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="n">nid</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="n">nid</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">note</span><span class="o">.</span><span class="n">id</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;ignored late blur&quot;</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="n">txt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mungeHTML</span><span class="p">(</span><span class="n">txt</span><span class="p">)</span>
            <span class="c1"># misbehaving apps may include a null byte in the text</span>
            <span class="n">txt</span> <span class="o">=</span> <span class="n">txt</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\x00</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="c1"># reverse the url quoting we added to get images to display</span>
            <span class="n">txt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mw</span><span class="o">.</span><span class="n">col</span><span class="o">.</span><span class="n">media</span><span class="o">.</span><span class="n">escapeImages</span><span class="p">(</span><span class="n">txt</span><span class="p">,</span> <span class="n">unescape</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">note</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="nb">ord</span><span class="p">]</span> <span class="o">=</span> <span class="n">txt</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">addMode</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">note</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mw</span><span class="o">.</span><span class="n">requireReset</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">type</span> <span class="o">==</span> <span class="s2">&quot;blur&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">currentField</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="c1"># run any filters</span>
                <span class="k">if</span> <span class="n">gui_hooks</span><span class="o">.</span><span class="n">editor_did_unfocus_field</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">note</span><span class="p">,</span> <span class="nb">ord</span><span class="p">):</span>
                    <span class="c1"># something updated the note; update it after a subsequent focus</span>
                    <span class="c1"># event has had time to fire</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">mw</span><span class="o">.</span><span class="n">progress</span><span class="o">.</span><span class="n">timer</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">loadNoteKeepingFocus</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">checkValid</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">gui_hooks</span><span class="o">.</span><span class="n">editor_did_fire_typing_timer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">note</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">checkValid</span><span class="p">()</span>
        <span class="c1"># focused into field?</span>
        <span class="k">elif</span> <span class="n">cmd</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;focus&quot;</span><span class="p">):</span>
            <span class="p">(</span><span class="nb">type</span><span class="p">,</span> <span class="n">num</span><span class="p">)</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">currentField</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">num</span><span class="p">)</span>
            <span class="n">gui_hooks</span><span class="o">.</span><span class="n">editor_did_focus_field</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">note</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">currentField</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">cmd</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_links</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_links</span><span class="p">[</span><span class="n">cmd</span><span class="p">](</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;uncaught cmd&quot;</span><span class="p">,</span> <span class="n">cmd</span><span class="p">)</span></div>

<div class="viewcode-block" id="Editor.mungeHTML"><a class="viewcode-back" href="../../aqt.html#aqt.editor.Editor.mungeHTML">[docs]</a>    <span class="k">def</span> <span class="nf">mungeHTML</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">txt</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">txt</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;&lt;br&gt;&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&quot;</span><span class="p">):</span>
            <span class="k">return</span> <span class="s2">&quot;&quot;</span>
        <span class="k">return</span> <span class="n">txt</span></div>

    <span class="c1"># Setting/unsetting the current note</span>
    <span class="c1">######################################################################</span>

<div class="viewcode-block" id="Editor.setNote"><a class="viewcode-back" href="../../aqt.html#aqt.editor.Editor.setNote">[docs]</a>    <span class="k">def</span> <span class="nf">setNote</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">note</span><span class="p">,</span> <span class="n">hide</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">focusTo</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="s2">&quot;Make NOTE the current note.&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">note</span> <span class="o">=</span> <span class="n">note</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">currentField</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">note</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">loadNote</span><span class="p">(</span><span class="n">focusTo</span><span class="o">=</span><span class="n">focusTo</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hideCompleters</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">hide</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">widget</span><span class="o">.</span><span class="n">hide</span><span class="p">()</span></div>

<div class="viewcode-block" id="Editor.loadNoteKeepingFocus"><a class="viewcode-back" href="../../aqt.html#aqt.editor.Editor.loadNoteKeepingFocus">[docs]</a>    <span class="k">def</span> <span class="nf">loadNoteKeepingFocus</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loadNote</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">currentField</span><span class="p">)</span></div>

<div class="viewcode-block" id="Editor.loadNote"><a class="viewcode-back" href="../../aqt.html#aqt.editor.Editor.loadNote">[docs]</a>    <span class="k">def</span> <span class="nf">loadNote</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">focusTo</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">note</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">data</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span><span class="n">fld</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mw</span><span class="o">.</span><span class="n">col</span><span class="o">.</span><span class="n">media</span><span class="o">.</span><span class="n">escapeImages</span><span class="p">(</span><span class="n">val</span><span class="p">))</span> <span class="k">for</span> <span class="n">fld</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">note</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
        <span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">widget</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">updateTags</span><span class="p">()</span>

        <span class="k">def</span> <span class="nf">oncallback</span><span class="p">(</span><span class="n">arg</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">note</span><span class="p">:</span>
                <span class="k">return</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">setupForegroundButton</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">checkValid</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">focusTo</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">setFocus</span><span class="p">()</span>
            <span class="n">gui_hooks</span><span class="o">.</span><span class="n">editor_did_load_note</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="n">js</span> <span class="o">=</span> <span class="s2">&quot;setFields(</span><span class="si">%s</span><span class="s2">); setFonts(</span><span class="si">%s</span><span class="s2">); focusField(</span><span class="si">%s</span><span class="s2">); setNoteId(</span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">data</span><span class="p">),</span>
            <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fonts</span><span class="p">()),</span>
            <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">focusTo</span><span class="p">),</span>
            <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">note</span><span class="o">.</span><span class="n">id</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="n">js</span> <span class="o">=</span> <span class="n">gui_hooks</span><span class="o">.</span><span class="n">editor_will_load_note</span><span class="p">(</span><span class="n">js</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">note</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">evalWithCallback</span><span class="p">(</span><span class="n">js</span><span class="p">,</span> <span class="n">oncallback</span><span class="p">)</span></div>

<div class="viewcode-block" id="Editor.fonts"><a class="viewcode-back" href="../../aqt.html#aqt.editor.Editor.fonts">[docs]</a>    <span class="k">def</span> <span class="nf">fonts</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]]:</span>
        <span class="k">return</span> <span class="p">[</span>
            <span class="p">(</span><span class="n">gui_hooks</span><span class="o">.</span><span class="n">editor_will_use_font_for_field</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="s2">&quot;font&quot;</span><span class="p">]),</span> <span class="n">f</span><span class="p">[</span><span class="s2">&quot;size&quot;</span><span class="p">],</span> <span class="n">f</span><span class="p">[</span><span class="s2">&quot;rtl&quot;</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">note</span><span class="o">.</span><span class="n">model</span><span class="p">()[</span><span class="s2">&quot;flds&quot;</span><span class="p">]</span>
        <span class="p">]</span></div>

<div class="viewcode-block" id="Editor.saveNow"><a class="viewcode-back" href="../../aqt.html#aqt.editor.Editor.saveNow">[docs]</a>    <span class="k">def</span> <span class="nf">saveNow</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">callback</span><span class="p">,</span> <span class="n">keepFocus</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="s2">&quot;Save unsaved edits then call callback().&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">note</span><span class="p">:</span>
            <span class="c1"># calling code may not expect the callback to fire immediately</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mw</span><span class="o">.</span><span class="n">progress</span><span class="o">.</span><span class="n">timer</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">callback</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">saveTags</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">evalWithCallback</span><span class="p">(</span><span class="s2">&quot;saveNow(</span><span class="si">%d</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="n">keepFocus</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">res</span><span class="p">:</span> <span class="n">callback</span><span class="p">())</span></div>

<div class="viewcode-block" id="Editor.checkValid"><a class="viewcode-back" href="../../aqt.html#aqt.editor.Editor.checkValid">[docs]</a>    <span class="k">def</span> <span class="nf">checkValid</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">note</span><span class="o">.</span><span class="n">fields</span><span class="p">)</span>
        <span class="n">err</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">note</span><span class="o">.</span><span class="n">dupeOrEmpty</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">err</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">cols</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;dupe&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="s2">&quot;showDupes();&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="s2">&quot;hideDupes();&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="s2">&quot;setBackgrounds(</span><span class="si">%s</span><span class="s2">);&quot;</span> <span class="o">%</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">cols</span><span class="p">))</span></div>

<div class="viewcode-block" id="Editor.showDupes"><a class="viewcode-back" href="../../aqt.html#aqt.editor.Editor.showDupes">[docs]</a>    <span class="k">def</span> <span class="nf">showDupes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">contents</span> <span class="o">=</span> <span class="n">stripHTMLMedia</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">note</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">browser</span> <span class="o">=</span> <span class="n">aqt</span><span class="o">.</span><span class="n">dialogs</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">&quot;Browser&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mw</span><span class="p">)</span>
        <span class="n">browser</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">searchEdit</span><span class="o">.</span><span class="n">lineEdit</span><span class="p">()</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span>
            <span class="s1">&#39;&quot;dupe:</span><span class="si">%s</span><span class="s1">,</span><span class="si">%s</span><span class="s1">&quot;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">note</span><span class="o">.</span><span class="n">model</span><span class="p">()[</span><span class="s2">&quot;id&quot;</span><span class="p">],</span> <span class="n">contents</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">browser</span><span class="o">.</span><span class="n">onSearchActivated</span><span class="p">()</span></div>

<div class="viewcode-block" id="Editor.fieldsAreBlank"><a class="viewcode-back" href="../../aqt.html#aqt.editor.Editor.fieldsAreBlank">[docs]</a>    <span class="k">def</span> <span class="nf">fieldsAreBlank</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">previousNote</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">note</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="n">m</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">note</span><span class="o">.</span><span class="n">model</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">c</span><span class="p">,</span> <span class="n">f</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">note</span><span class="o">.</span><span class="n">fields</span><span class="p">):</span>
            <span class="n">f</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&lt;br&gt;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="n">notChangedvalues</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt;br&gt;&quot;</span><span class="p">}</span>
            <span class="k">if</span> <span class="n">previousNote</span> <span class="ow">and</span> <span class="n">m</span><span class="p">[</span><span class="s2">&quot;flds&quot;</span><span class="p">][</span><span class="n">c</span><span class="p">][</span><span class="s2">&quot;sticky&quot;</span><span class="p">]:</span>
                <span class="n">notChangedvalues</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">previousNote</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&lt;br&gt;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
            <span class="k">if</span> <span class="n">f</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">notChangedvalues</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="Editor.cleanup"><a class="viewcode-back" href="../../aqt.html#aqt.editor.Editor.cleanup">[docs]</a>    <span class="k">def</span> <span class="nf">cleanup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setNote</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
        <span class="c1"># prevent any remaining evalWithCallback() events from firing after C++ object deleted</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">web</span> <span class="o">=</span> <span class="kc">None</span></div>

    <span class="c1"># HTML editing</span>
    <span class="c1">######################################################################</span>

<div class="viewcode-block" id="Editor.onHtmlEdit"><a class="viewcode-back" href="../../aqt.html#aqt.editor.Editor.onHtmlEdit">[docs]</a>    <span class="k">def</span> <span class="nf">onHtmlEdit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">field</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">currentField</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">saveNow</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_onHtmlEdit</span><span class="p">(</span><span class="n">field</span><span class="p">))</span></div>

    <span class="k">def</span> <span class="nf">_onHtmlEdit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field</span><span class="p">):</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">QDialog</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">widget</span><span class="p">,</span> <span class="n">Qt</span><span class="o">.</span><span class="n">Window</span><span class="p">)</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">aqt</span><span class="o">.</span><span class="n">forms</span><span class="o">.</span><span class="n">edithtml</span><span class="o">.</span><span class="n">Ui_Dialog</span><span class="p">()</span>
        <span class="n">form</span><span class="o">.</span><span class="n">setupUi</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
        <span class="n">restoreGeom</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="s2">&quot;htmlEditor&quot;</span><span class="p">)</span>
        <span class="n">qconnect</span><span class="p">(</span><span class="n">form</span><span class="o">.</span><span class="n">buttonBox</span><span class="o">.</span><span class="n">helpRequested</span><span class="p">,</span> <span class="k">lambda</span><span class="p">:</span> <span class="n">openHelp</span><span class="p">(</span><span class="s2">&quot;editor&quot;</span><span class="p">))</span>
        <span class="n">form</span><span class="o">.</span><span class="n">textEdit</span><span class="o">.</span><span class="n">setPlainText</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">note</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="n">field</span><span class="p">])</span>
        <span class="n">d</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        <span class="n">form</span><span class="o">.</span><span class="n">textEdit</span><span class="o">.</span><span class="n">moveCursor</span><span class="p">(</span><span class="n">QTextCursor</span><span class="o">.</span><span class="n">End</span><span class="p">)</span>
        <span class="n">d</span><span class="o">.</span><span class="n">exec_</span><span class="p">()</span>
        <span class="n">html</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">textEdit</span><span class="o">.</span><span class="n">toPlainText</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">html</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;&gt;&quot;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="c1"># filter html through beautifulsoup so we can strip out things like a</span>
            <span class="c1"># leading &lt;/div&gt;</span>
            <span class="n">html_escaped</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mw</span><span class="o">.</span><span class="n">col</span><span class="o">.</span><span class="n">media</span><span class="o">.</span><span class="n">escapeImages</span><span class="p">(</span><span class="n">html</span><span class="p">)</span>
            <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">,</span> <span class="ne">UserWarning</span><span class="p">)</span>
                <span class="n">html_escaped</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">BeautifulSoup</span><span class="p">(</span><span class="n">html_escaped</span><span class="p">,</span> <span class="s2">&quot;html.parser&quot;</span><span class="p">))</span>
                <span class="n">html</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mw</span><span class="o">.</span><span class="n">col</span><span class="o">.</span><span class="n">media</span><span class="o">.</span><span class="n">escapeImages</span><span class="p">(</span><span class="n">html_escaped</span><span class="p">,</span> <span class="n">unescape</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">note</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="o">=</span> <span class="n">html</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">addMode</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">note</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loadNote</span><span class="p">(</span><span class="n">focusTo</span><span class="o">=</span><span class="n">field</span><span class="p">)</span>
        <span class="n">saveGeom</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="s2">&quot;htmlEditor&quot;</span><span class="p">)</span>

    <span class="c1"># Tag handling</span>
    <span class="c1">######################################################################</span>

<div class="viewcode-block" id="Editor.setupTags"><a class="viewcode-back" href="../../aqt.html#aqt.editor.Editor.setupTags">[docs]</a>    <span class="k">def</span> <span class="nf">setupTags</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">aqt.tagedit</span>

        <span class="n">g</span> <span class="o">=</span> <span class="n">QGroupBox</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">widget</span><span class="p">)</span>
        <span class="n">g</span><span class="o">.</span><span class="n">setStyleSheet</span><span class="p">(</span><span class="s2">&quot;border: 0&quot;</span><span class="p">)</span>
        <span class="n">tb</span> <span class="o">=</span> <span class="n">QGridLayout</span><span class="p">()</span>
        <span class="n">tb</span><span class="o">.</span><span class="n">setSpacing</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span>
        <span class="n">tb</span><span class="o">.</span><span class="n">setContentsMargins</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>
        <span class="c1"># tags</span>
        <span class="n">l</span> <span class="o">=</span> <span class="n">QLabel</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;Tags&quot;</span><span class="p">))</span>
        <span class="n">tb</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tags</span> <span class="o">=</span> <span class="n">aqt</span><span class="o">.</span><span class="n">tagedit</span><span class="o">.</span><span class="n">TagEdit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">widget</span><span class="p">)</span>
        <span class="n">qconnect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tags</span><span class="o">.</span><span class="n">lostFocus</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">saveTags</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tags</span><span class="o">.</span><span class="n">setToolTip</span><span class="p">(</span><span class="n">shortcut</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;Jump to tags with Ctrl+Shift+T&quot;</span><span class="p">)))</span>
        <span class="n">border</span> <span class="o">=</span> <span class="n">theme_manager</span><span class="o">.</span><span class="n">str_color</span><span class="p">(</span><span class="s2">&quot;border&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tags</span><span class="o">.</span><span class="n">setStyleSheet</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;border: 1px solid </span><span class="si">{border}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">tb</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tags</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">g</span><span class="o">.</span><span class="n">setLayout</span><span class="p">(</span><span class="n">tb</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">outerLayout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">g</span><span class="p">)</span></div>

<div class="viewcode-block" id="Editor.updateTags"><a class="viewcode-back" href="../../aqt.html#aqt.editor.Editor.updateTags">[docs]</a>    <span class="k">def</span> <span class="nf">updateTags</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tags</span><span class="o">.</span><span class="n">col</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mw</span><span class="o">.</span><span class="n">col</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tags</span><span class="o">.</span><span class="n">setCol</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mw</span><span class="o">.</span><span class="n">col</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">tags</span><span class="o">.</span><span class="n">text</span><span class="p">()</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">addMode</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tags</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">note</span><span class="o">.</span><span class="n">stringTags</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span></div>

<div class="viewcode-block" id="Editor.saveTags"><a class="viewcode-back" href="../../aqt.html#aqt.editor.Editor.saveTags">[docs]</a>    <span class="k">def</span> <span class="nf">saveTags</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">note</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">note</span><span class="o">.</span><span class="n">tags</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mw</span><span class="o">.</span><span class="n">col</span><span class="o">.</span><span class="n">tags</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tags</span><span class="o">.</span><span class="n">text</span><span class="p">())</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">addMode</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">note</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="n">gui_hooks</span><span class="o">.</span><span class="n">editor_did_update_tags</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">note</span><span class="p">)</span></div>

<div class="viewcode-block" id="Editor.saveAddModeVars"><a class="viewcode-back" href="../../aqt.html#aqt.editor.Editor.saveAddModeVars">[docs]</a>    <span class="k">def</span> <span class="nf">saveAddModeVars</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">addMode</span><span class="p">:</span>
            <span class="c1"># save tags to model</span>
            <span class="n">m</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">note</span><span class="o">.</span><span class="n">model</span><span class="p">()</span>
            <span class="n">m</span><span class="p">[</span><span class="s2">&quot;tags&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">note</span><span class="o">.</span><span class="n">tags</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mw</span><span class="o">.</span><span class="n">col</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">updateReqs</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div>

<div class="viewcode-block" id="Editor.hideCompleters"><a class="viewcode-back" href="../../aqt.html#aqt.editor.Editor.hideCompleters">[docs]</a>    <span class="k">def</span> <span class="nf">hideCompleters</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tags</span><span class="o">.</span><span class="n">hideCompleter</span><span class="p">()</span></div>

<div class="viewcode-block" id="Editor.onFocusTags"><a class="viewcode-back" href="../../aqt.html#aqt.editor.Editor.onFocusTags">[docs]</a>    <span class="k">def</span> <span class="nf">onFocusTags</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tags</span><span class="o">.</span><span class="n">setFocus</span><span class="p">()</span></div>

    <span class="c1"># Format buttons</span>
    <span class="c1">######################################################################</span>

<div class="viewcode-block" id="Editor.toggleBold"><a class="viewcode-back" href="../../aqt.html#aqt.editor.Editor.toggleBold">[docs]</a>    <span class="k">def</span> <span class="nf">toggleBold</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="s2">&quot;setFormat(&#39;bold&#39;);&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Editor.toggleItalic"><a class="viewcode-back" href="../../aqt.html#aqt.editor.Editor.toggleItalic">[docs]</a>    <span class="k">def</span> <span class="nf">toggleItalic</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="s2">&quot;setFormat(&#39;italic&#39;);&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Editor.toggleUnderline"><a class="viewcode-back" href="../../aqt.html#aqt.editor.Editor.toggleUnderline">[docs]</a>    <span class="k">def</span> <span class="nf">toggleUnderline</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="s2">&quot;setFormat(&#39;underline&#39;);&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Editor.toggleSuper"><a class="viewcode-back" href="../../aqt.html#aqt.editor.Editor.toggleSuper">[docs]</a>    <span class="k">def</span> <span class="nf">toggleSuper</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="s2">&quot;setFormat(&#39;superscript&#39;);&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Editor.toggleSub"><a class="viewcode-back" href="../../aqt.html#aqt.editor.Editor.toggleSub">[docs]</a>    <span class="k">def</span> <span class="nf">toggleSub</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="s2">&quot;setFormat(&#39;subscript&#39;);&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Editor.removeFormat"><a class="viewcode-back" href="../../aqt.html#aqt.editor.Editor.removeFormat">[docs]</a>    <span class="k">def</span> <span class="nf">removeFormat</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="s2">&quot;setFormat(&#39;removeFormat&#39;);&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Editor.onCloze"><a class="viewcode-back" href="../../aqt.html#aqt.editor.Editor.onCloze">[docs]</a>    <span class="k">def</span> <span class="nf">onCloze</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">saveNow</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_onCloze</span><span class="p">,</span> <span class="n">keepFocus</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_onCloze</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># check that the model is set up for cloze deletion</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s2">&quot;{{(.*:)*cloze:&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">note</span><span class="o">.</span><span class="n">model</span><span class="p">()[</span><span class="s2">&quot;tmpls&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;qfmt&quot;</span><span class="p">]):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">addMode</span><span class="p">:</span>
                <span class="n">tooltip</span><span class="p">(</span>
                    <span class="n">_</span><span class="p">(</span>
                        <span class="s2">&quot;Warning, cloze deletions will not work until &quot;</span>
                        <span class="s2">&quot;you switch the type at the top to Cloze.&quot;</span>
                    <span class="p">)</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">showInfo</span><span class="p">(</span>
                    <span class="n">_</span><span class="p">(</span>
                        <span class="sd">&quot;&quot;&quot;\</span>
<span class="sd">To make a cloze deletion on an existing note, you need to change it \</span>
<span class="sd">to a cloze type first, via &#39;Notes&gt;Change Note Type&#39;&quot;&quot;&quot;</span>
                    <span class="p">)</span>
                <span class="p">)</span>
                <span class="k">return</span>
        <span class="c1"># find the highest existing cloze</span>
        <span class="n">highest</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">note</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
            <span class="n">m</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\{\{c(\d+)::&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">m</span><span class="p">:</span>
                <span class="n">highest</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">highest</span><span class="p">,</span> <span class="nb">sorted</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">m</span><span class="p">])[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="c1"># reuse last?</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">mw</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">keyboardModifiers</span><span class="p">()</span> <span class="o">&amp;</span> <span class="n">Qt</span><span class="o">.</span><span class="n">AltModifier</span><span class="p">:</span>
            <span class="n">highest</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="c1"># must start at 1</span>
        <span class="n">highest</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">highest</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="s2">&quot;wrap(&#39;{{c</span><span class="si">%d</span><span class="s2">::&#39;, &#39;}}&#39;);&quot;</span> <span class="o">%</span> <span class="n">highest</span><span class="p">)</span>

    <span class="c1"># Foreground colour</span>
    <span class="c1">######################################################################</span>

<div class="viewcode-block" id="Editor.setupForegroundButton"><a class="viewcode-back" href="../../aqt.html#aqt.editor.Editor.setupForegroundButton">[docs]</a>    <span class="k">def</span> <span class="nf">setupForegroundButton</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fcolour</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mw</span><span class="o">.</span><span class="n">pm</span><span class="o">.</span><span class="n">profile</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;lastColour&quot;</span><span class="p">,</span> <span class="s2">&quot;#00f&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">onColourChanged</span><span class="p">()</span></div>

    <span class="c1"># use last colour</span>
<div class="viewcode-block" id="Editor.onForeground"><a class="viewcode-back" href="../../aqt.html#aqt.editor.Editor.onForeground">[docs]</a>    <span class="k">def</span> <span class="nf">onForeground</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_wrapWithColour</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fcolour</span><span class="p">)</span></div>

    <span class="c1"># choose new colour</span>
<div class="viewcode-block" id="Editor.onChangeCol"><a class="viewcode-back" href="../../aqt.html#aqt.editor.Editor.onChangeCol">[docs]</a>    <span class="k">def</span> <span class="nf">onChangeCol</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">isLin</span><span class="p">:</span>
            <span class="n">new</span> <span class="o">=</span> <span class="n">QColorDialog</span><span class="o">.</span><span class="n">getColor</span><span class="p">(</span>
                <span class="n">QColor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fcolour</span><span class="p">),</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">QColorDialog</span><span class="o">.</span><span class="n">DontUseNativeDialog</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">new</span> <span class="o">=</span> <span class="n">QColorDialog</span><span class="o">.</span><span class="n">getColor</span><span class="p">(</span><span class="n">QColor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fcolour</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
        <span class="c1"># native dialog doesn&#39;t refocus us for some reason</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parentWindow</span><span class="o">.</span><span class="n">activateWindow</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">new</span><span class="o">.</span><span class="n">isValid</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fcolour</span> <span class="o">=</span> <span class="n">new</span><span class="o">.</span><span class="n">name</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">onColourChanged</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_wrapWithColour</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fcolour</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_updateForegroundButton</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="s2">&quot;setFGButton(&#39;</span><span class="si">%s</span><span class="s2">&#39;)&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">fcolour</span><span class="p">)</span>

<div class="viewcode-block" id="Editor.onColourChanged"><a class="viewcode-back" href="../../aqt.html#aqt.editor.Editor.onColourChanged">[docs]</a>    <span class="k">def</span> <span class="nf">onColourChanged</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_updateForegroundButton</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mw</span><span class="o">.</span><span class="n">pm</span><span class="o">.</span><span class="n">profile</span><span class="p">[</span><span class="s2">&quot;lastColour&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fcolour</span></div>

    <span class="k">def</span> <span class="nf">_wrapWithColour</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">colour</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="s2">&quot;setFormat(&#39;forecolor&#39;, &#39;</span><span class="si">%s</span><span class="s2">&#39;)&quot;</span> <span class="o">%</span> <span class="n">colour</span><span class="p">)</span>

    <span class="c1"># Audio/video/images</span>
    <span class="c1">######################################################################</span>

<div class="viewcode-block" id="Editor.onAddMedia"><a class="viewcode-back" href="../../aqt.html#aqt.editor.Editor.onAddMedia">[docs]</a>    <span class="k">def</span> <span class="nf">onAddMedia</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">extension_filter</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="s2">&quot;*.&quot;</span> <span class="o">+</span> <span class="n">extension</span> <span class="k">for</span> <span class="n">extension</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">chain</span><span class="p">(</span><span class="n">pics</span><span class="p">,</span> <span class="n">audio</span><span class="p">))</span>
        <span class="p">)</span>
        <span class="n">key</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Media&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; (&quot;</span> <span class="o">+</span> <span class="n">extension_filter</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span>

        <span class="k">def</span> <span class="nf">accept</span><span class="p">(</span><span class="n">file</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">addMedia</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">canDelete</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">file</span> <span class="o">=</span> <span class="n">getFile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">widget</span><span class="p">,</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Add Media&quot;</span><span class="p">),</span> <span class="n">accept</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s2">&quot;media&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parentWindow</span><span class="o">.</span><span class="n">activateWindow</span><span class="p">()</span></div>

<div class="viewcode-block" id="Editor.addMedia"><a class="viewcode-back" href="../../aqt.html#aqt.editor.Editor.addMedia">[docs]</a>    <span class="k">def</span> <span class="nf">addMedia</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">canDelete</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">html</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_addMedia</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">canDelete</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">showWarning</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="s2">&quot;insertHtmlRemovingInitialBR(</span><span class="si">%s</span><span class="s2">);&quot;</span> <span class="o">%</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">html</span><span class="p">))</span></div>

    <span class="k">def</span> <span class="nf">_addMedia</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">canDelete</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="s2">&quot;Add to media folder and return local img or sound tag.&quot;</span>
        <span class="c1"># copy to media folder</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mw</span><span class="o">.</span><span class="n">col</span><span class="o">.</span><span class="n">media</span><span class="o">.</span><span class="n">addFile</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="c1"># remove original?</span>
        <span class="k">if</span> <span class="n">canDelete</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">mw</span><span class="o">.</span><span class="n">pm</span><span class="o">.</span><span class="n">profile</span><span class="p">[</span><span class="s2">&quot;deleteMedia&quot;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span> <span class="o">!=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">pass</span>
        <span class="c1"># return a local html link</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">fnameToLink</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_addMediaFromData</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fname</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">mw</span><span class="o">.</span><span class="n">col</span><span class="o">.</span><span class="n">media</span><span class="o">.</span><span class="n">writeData</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>

<div class="viewcode-block" id="Editor.onRecSound"><a class="viewcode-back" href="../../aqt.html#aqt.editor.Editor.onRecSound">[docs]</a>    <span class="k">def</span> <span class="nf">onRecSound</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">file</span> <span class="o">=</span> <span class="n">getAudio</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">widget</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">showWarning</span><span class="p">(</span>
                <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Couldn&#39;t record audio. Have you installed &#39;lame&#39;?&quot;</span><span class="p">)</span>
                <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
            <span class="p">)</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">file</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">addMedia</span><span class="p">(</span><span class="n">file</span><span class="p">)</span></div>

    <span class="c1"># Media downloads</span>
    <span class="c1">######################################################################</span>

<div class="viewcode-block" id="Editor.urlToLink"><a class="viewcode-back" href="../../aqt.html#aqt.editor.Editor.urlToLink">[docs]</a>    <span class="k">def</span> <span class="nf">urlToLink</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">urlToFile</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">fname</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">fnameToLink</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span></div>

<div class="viewcode-block" id="Editor.fnameToLink"><a class="viewcode-back" href="../../aqt.html#aqt.editor.Editor.fnameToLink">[docs]</a>    <span class="k">def</span> <span class="nf">fnameToLink</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fname</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">ext</span> <span class="o">=</span> <span class="n">fname</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">ext</span> <span class="ow">in</span> <span class="n">pics</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">parse</span><span class="o">.</span><span class="n">quote</span><span class="p">(</span><span class="n">fname</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf8&quot;</span><span class="p">))</span>
            <span class="k">return</span> <span class="s1">&#39;&lt;img src=&quot;</span><span class="si">%s</span><span class="s1">&quot;&gt;&#39;</span> <span class="o">%</span> <span class="n">name</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">av_player</span><span class="o">.</span><span class="n">play_file</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
            <span class="k">return</span> <span class="s2">&quot;[sound:</span><span class="si">%s</span><span class="s2">]&quot;</span> <span class="o">%</span> <span class="n">fname</span></div>

<div class="viewcode-block" id="Editor.urlToFile"><a class="viewcode-back" href="../../aqt.html#aqt.editor.Editor.urlToFile">[docs]</a>    <span class="k">def</span> <span class="nf">urlToFile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="n">l</span> <span class="o">=</span> <span class="n">url</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">suffix</span> <span class="ow">in</span> <span class="n">pics</span> <span class="o">+</span> <span class="n">audio</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">l</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.&quot;</span> <span class="o">+</span> <span class="n">suffix</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_retrieveURL</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
        <span class="c1"># not a supported type</span>
        <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="Editor.isURL"><a class="viewcode-back" href="../../aqt.html#aqt.editor.Editor.isURL">[docs]</a>    <span class="k">def</span> <span class="nf">isURL</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">s</span><span class="p">):</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="n">s</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;http://&quot;</span><span class="p">)</span>
            <span class="ow">or</span> <span class="n">s</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;https://&quot;</span><span class="p">)</span>
            <span class="ow">or</span> <span class="n">s</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;ftp://&quot;</span><span class="p">)</span>
            <span class="ow">or</span> <span class="n">s</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;file://&quot;</span><span class="p">)</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="Editor.inlinedImageToFilename"><a class="viewcode-back" href="../../aqt.html#aqt.editor.Editor.inlinedImageToFilename">[docs]</a>    <span class="k">def</span> <span class="nf">inlinedImageToFilename</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">txt</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">prefix</span> <span class="o">=</span> <span class="s2">&quot;data:image/&quot;</span>
        <span class="n">suffix</span> <span class="o">=</span> <span class="s2">&quot;;base64,&quot;</span>
        <span class="k">for</span> <span class="n">ext</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;jpg&quot;</span><span class="p">,</span> <span class="s2">&quot;jpeg&quot;</span><span class="p">,</span> <span class="s2">&quot;png&quot;</span><span class="p">,</span> <span class="s2">&quot;gif&quot;</span><span class="p">):</span>
            <span class="n">fullPrefix</span> <span class="o">=</span> <span class="n">prefix</span> <span class="o">+</span> <span class="n">ext</span> <span class="o">+</span> <span class="n">suffix</span>
            <span class="k">if</span> <span class="n">txt</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">fullPrefix</span><span class="p">):</span>
                <span class="n">b64data</span> <span class="o">=</span> <span class="n">txt</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">fullPrefix</span><span class="p">)</span> <span class="p">:]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64decode</span><span class="p">(</span><span class="n">b64data</span><span class="p">,</span> <span class="n">validate</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">ext</span> <span class="o">==</span> <span class="s2">&quot;jpeg&quot;</span><span class="p">:</span>
                    <span class="n">ext</span> <span class="o">=</span> <span class="s2">&quot;jpg&quot;</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_addPastedImage</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="s2">&quot;.&quot;</span> <span class="o">+</span> <span class="n">ext</span><span class="p">)</span>

        <span class="k">return</span> <span class="s2">&quot;&quot;</span></div>

<div class="viewcode-block" id="Editor.inlinedImageToLink"><a class="viewcode-back" href="../../aqt.html#aqt.editor.Editor.inlinedImageToLink">[docs]</a>    <span class="k">def</span> <span class="nf">inlinedImageToLink</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">src</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inlinedImageToFilename</span><span class="p">(</span><span class="n">src</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">fname</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">fnameToLink</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>

        <span class="k">return</span> <span class="s2">&quot;&quot;</span></div>

    <span class="c1"># ext should include dot</span>
    <span class="k">def</span> <span class="nf">_addPastedImage</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">,</span> <span class="n">ext</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="c1"># hash and write</span>
        <span class="n">csum</span> <span class="o">=</span> <span class="n">checksum</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">-</span><span class="si">{}{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;paste&quot;</span><span class="p">,</span> <span class="n">csum</span><span class="p">,</span> <span class="n">ext</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_addMediaFromData</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_retrieveURL</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="s2">&quot;Download file into media folder and return local filename or None.&quot;</span>
        <span class="c1"># urllib doesn&#39;t understand percent-escaped utf8, but requires things like</span>
        <span class="c1"># &#39;#&#39; to be escaped.</span>
        <span class="n">url</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">parse</span><span class="o">.</span><span class="n">unquote</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">url</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;file://&quot;</span><span class="p">):</span>
            <span class="n">url</span> <span class="o">=</span> <span class="n">url</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;%&quot;</span><span class="p">,</span> <span class="s2">&quot;%25&quot;</span><span class="p">)</span>
            <span class="n">url</span> <span class="o">=</span> <span class="n">url</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;#&quot;</span><span class="p">,</span> <span class="s2">&quot;%23&quot;</span><span class="p">)</span>
            <span class="n">local</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">local</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="c1"># fetch it into a temporary folder</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mw</span><span class="o">.</span><span class="n">progress</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="n">immediate</span><span class="o">=</span><span class="ow">not</span> <span class="n">local</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">parentWindow</span><span class="p">)</span>
        <span class="n">content_type</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">error_msg</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">local</span><span class="p">:</span>
                <span class="n">req</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">Request</span><span class="p">(</span>
                    <span class="n">url</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;User-Agent&quot;</span><span class="p">:</span> <span class="s2">&quot;Mozilla/5.0 (compatible; Anki)&quot;</span><span class="p">}</span>
                <span class="p">)</span>
                <span class="k">with</span> <span class="n">urllib</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="n">req</span><span class="p">)</span> <span class="k">as</span> <span class="n">response</span><span class="p">:</span>
                    <span class="n">filecontents</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">HttpClient</span><span class="p">()</span> <span class="k">as</span> <span class="n">client</span><span class="p">:</span>
                    <span class="n">client</span><span class="o">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="mi">30</span>
                    <span class="k">with</span> <span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span> <span class="k">as</span> <span class="n">response</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">!=</span> <span class="mi">200</span><span class="p">:</span>
                            <span class="n">error_msg</span> <span class="o">=</span> <span class="p">(</span>
                                <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Unexpected response code: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">)</span> <span class="o">%</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span>
                            <span class="p">)</span>
                            <span class="k">return</span> <span class="kc">None</span>
                        <span class="n">filecontents</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">content</span>
                        <span class="n">content_type</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;content-type&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="n">urllib</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">URLError</span><span class="p">,</span> <span class="n">requests</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">RequestException</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">error_msg</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;An error occurred while opening </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">)</span> <span class="o">%</span> <span class="n">e</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mw</span><span class="o">.</span><span class="n">progress</span><span class="o">.</span><span class="n">finish</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">error_msg</span><span class="p">:</span>
                <span class="n">showWarning</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>
        <span class="c1"># strip off any query string</span>
        <span class="n">url</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\?.*?$&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">url</span><span class="p">)</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">urllib</span><span class="o">.</span><span class="n">parse</span><span class="o">.</span><span class="n">unquote</span><span class="p">(</span><span class="n">url</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">fname</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
            <span class="n">fname</span> <span class="o">=</span> <span class="s2">&quot;paste&quot;</span>
        <span class="k">if</span> <span class="n">content_type</span><span class="p">:</span>
            <span class="n">fname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mw</span><span class="o">.</span><span class="n">col</span><span class="o">.</span><span class="n">media</span><span class="o">.</span><span class="n">add_extension_based_on_mime</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">content_type</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">mw</span><span class="o">.</span><span class="n">col</span><span class="o">.</span><span class="n">media</span><span class="o">.</span><span class="n">write_data</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">filecontents</span><span class="p">)</span>

    <span class="c1"># Paste/drag&amp;drop</span>
    <span class="c1">######################################################################</span>

    <span class="n">removeTags</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;script&quot;</span><span class="p">,</span> <span class="s2">&quot;iframe&quot;</span><span class="p">,</span> <span class="s2">&quot;object&quot;</span><span class="p">,</span> <span class="s2">&quot;style&quot;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_pastePreFilter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">html</span><span class="p">,</span> <span class="n">internal</span><span class="p">):</span>
        <span class="c1"># https://anki.tenderapp.com/discussions/ankidesktop/39543-anki-is-replacing-the-character-by-when-i-exit-the-html-edit-mode-ctrlshiftx</span>
        <span class="k">if</span> <span class="n">html</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;&gt;&quot;</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">html</span>

        <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">()</span> <span class="k">as</span> <span class="n">w</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">,</span> <span class="ne">UserWarning</span><span class="p">)</span>
            <span class="n">doc</span> <span class="o">=</span> <span class="n">BeautifulSoup</span><span class="p">(</span><span class="n">html</span><span class="p">,</span> <span class="s2">&quot;html.parser&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">internal</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">removeTags</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">doc</span><span class="p">(</span><span class="n">tag</span><span class="p">):</span>
                    <span class="n">node</span><span class="o">.</span><span class="n">decompose</span><span class="p">()</span>

            <span class="c1"># convert p tags to divs</span>
            <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">doc</span><span class="p">(</span><span class="s2">&quot;p&quot;</span><span class="p">):</span>
                <span class="n">node</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;div&quot;</span>

        <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">doc</span><span class="p">(</span><span class="s2">&quot;img&quot;</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">src</span> <span class="o">=</span> <span class="n">tag</span><span class="p">[</span><span class="s2">&quot;src&quot;</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="c1"># for some bizarre reason, mnemosyne removes src elements</span>
                <span class="c1"># from missing media</span>
                <span class="k">continue</span>

            <span class="c1"># in internal pastes, rewrite mediasrv references to relative</span>
            <span class="k">if</span> <span class="n">internal</span><span class="p">:</span>
                <span class="n">m</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;http://127.0.0.1:\d+/(.*)$&quot;</span><span class="p">,</span> <span class="n">src</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">m</span><span class="p">:</span>
                    <span class="n">tag</span><span class="p">[</span><span class="s2">&quot;src&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># in external pastes, download remote media</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">isURL</span><span class="p">(</span><span class="n">src</span><span class="p">):</span>
                    <span class="n">fname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_retrieveURL</span><span class="p">(</span><span class="n">src</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">fname</span><span class="p">:</span>
                        <span class="n">tag</span><span class="p">[</span><span class="s2">&quot;src&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fname</span>
                <span class="k">elif</span> <span class="n">src</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;data:image/&quot;</span><span class="p">):</span>
                    <span class="c1"># and convert inlined data</span>
                    <span class="n">tag</span><span class="p">[</span><span class="s2">&quot;src&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inlinedImageToFilename</span><span class="p">(</span><span class="n">src</span><span class="p">)</span>

        <span class="n">html</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">doc</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">html</span>

<div class="viewcode-block" id="Editor.doPaste"><a class="viewcode-back" href="../../aqt.html#aqt.editor.Editor.doPaste">[docs]</a>    <span class="k">def</span> <span class="nf">doPaste</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">html</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">internal</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">extended</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">html</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pastePreFilter</span><span class="p">(</span><span class="n">html</span><span class="p">,</span> <span class="n">internal</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">extended</span><span class="p">:</span>
            <span class="n">ext</span> <span class="o">=</span> <span class="s2">&quot;true&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ext</span> <span class="o">=</span> <span class="s2">&quot;false&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">eval</span><span class="p">(</span>
            <span class="s2">&quot;pasteHTML(</span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">);&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">html</span><span class="p">),</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">internal</span><span class="p">),</span> <span class="n">ext</span><span class="p">)</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="Editor.doDrop"><a class="viewcode-back" href="../../aqt.html#aqt.editor.Editor.doDrop">[docs]</a>    <span class="k">def</span> <span class="nf">doDrop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">html</span><span class="p">,</span> <span class="n">internal</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">evalWithCallback</span><span class="p">(</span>
            <span class="s2">&quot;makeDropTargetCurrent();&quot;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">_</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">doPaste</span><span class="p">(</span><span class="n">html</span><span class="p">,</span> <span class="n">internal</span><span class="p">)</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="Editor.onPaste"><a class="viewcode-back" href="../../aqt.html#aqt.editor.Editor.onPaste">[docs]</a>    <span class="k">def</span> <span class="nf">onPaste</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">onPaste</span><span class="p">()</span></div>

<div class="viewcode-block" id="Editor.onCutOrCopy"><a class="viewcode-back" href="../../aqt.html#aqt.editor.Editor.onCutOrCopy">[docs]</a>    <span class="k">def</span> <span class="nf">onCutOrCopy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">flagAnkiText</span><span class="p">()</span></div>

    <span class="c1"># Advanced menu</span>
    <span class="c1">######################################################################</span>

<div class="viewcode-block" id="Editor.onAdvanced"><a class="viewcode-back" href="../../aqt.html#aqt.editor.Editor.onAdvanced">[docs]</a>    <span class="k">def</span> <span class="nf">onAdvanced</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">QMenu</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mw</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">text</span><span class="p">,</span> <span class="n">handler</span><span class="p">,</span> <span class="n">shortcut</span> <span class="ow">in</span> <span class="p">(</span>
            <span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;MathJax inline&quot;</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">insertMathjaxInline</span><span class="p">,</span> <span class="s2">&quot;Ctrl+M, M&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;MathJax block&quot;</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">insertMathjaxBlock</span><span class="p">,</span> <span class="s2">&quot;Ctrl+M, E&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;MathJax chemistry&quot;</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">insertMathjaxChemistry</span><span class="p">,</span> <span class="s2">&quot;Ctrl+M, C&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;LaTeX&quot;</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">insertLatex</span><span class="p">,</span> <span class="s2">&quot;Ctrl+T, T&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;LaTeX equation&quot;</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">insertLatexEqn</span><span class="p">,</span> <span class="s2">&quot;Ctrl+T, E&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;LaTeX math env.&quot;</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">insertLatexMathEnv</span><span class="p">,</span> <span class="s2">&quot;Ctrl+T, M&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;Edit HTML&quot;</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">onHtmlEdit</span><span class="p">,</span> <span class="s2">&quot;Ctrl+Shift+X&quot;</span><span class="p">),</span>
        <span class="p">):</span>
            <span class="n">a</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">addAction</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
            <span class="n">qconnect</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">triggered</span><span class="p">,</span> <span class="n">handler</span><span class="p">)</span>
            <span class="n">a</span><span class="o">.</span><span class="n">setShortcut</span><span class="p">(</span><span class="n">QKeySequence</span><span class="p">(</span><span class="n">shortcut</span><span class="p">))</span>

        <span class="n">qtMenuShortcutWorkaround</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>

        <span class="n">m</span><span class="o">.</span><span class="n">exec_</span><span class="p">(</span><span class="n">QCursor</span><span class="o">.</span><span class="n">pos</span><span class="p">())</span></div>

    <span class="c1"># LaTeX</span>
    <span class="c1">######################################################################</span>

<div class="viewcode-block" id="Editor.insertLatex"><a class="viewcode-back" href="../../aqt.html#aqt.editor.Editor.insertLatex">[docs]</a>    <span class="k">def</span> <span class="nf">insertLatex</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="s2">&quot;wrap(&#39;[latex]&#39;, &#39;[/latex]&#39;);&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Editor.insertLatexEqn"><a class="viewcode-back" href="../../aqt.html#aqt.editor.Editor.insertLatexEqn">[docs]</a>    <span class="k">def</span> <span class="nf">insertLatexEqn</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="s2">&quot;wrap(&#39;[$]&#39;, &#39;[/$]&#39;);&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Editor.insertLatexMathEnv"><a class="viewcode-back" href="../../aqt.html#aqt.editor.Editor.insertLatexMathEnv">[docs]</a>    <span class="k">def</span> <span class="nf">insertLatexMathEnv</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="s2">&quot;wrap(&#39;[$$]&#39;, &#39;[/$$]&#39;);&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Editor.insertMathjaxInline"><a class="viewcode-back" href="../../aqt.html#aqt.editor.Editor.insertMathjaxInline">[docs]</a>    <span class="k">def</span> <span class="nf">insertMathjaxInline</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="s2">&quot;wrap(&#39;</span><span class="se">\\\\</span><span class="s2">(&#39;, &#39;</span><span class="se">\\\\</span><span class="s2">)&#39;);&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Editor.insertMathjaxBlock"><a class="viewcode-back" href="../../aqt.html#aqt.editor.Editor.insertMathjaxBlock">[docs]</a>    <span class="k">def</span> <span class="nf">insertMathjaxBlock</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="s2">&quot;wrap(&#39;</span><span class="se">\\\\</span><span class="s2">[&#39;, &#39;</span><span class="se">\\\\</span><span class="s2">]&#39;);&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Editor.insertMathjaxChemistry"><a class="viewcode-back" href="../../aqt.html#aqt.editor.Editor.insertMathjaxChemistry">[docs]</a>    <span class="k">def</span> <span class="nf">insertMathjaxChemistry</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="s2">&quot;wrap(&#39;</span><span class="se">\\\\</span><span class="s2">(</span><span class="se">\\\\</span><span class="s2">ce{&#39;, &#39;}</span><span class="se">\\\\</span><span class="s2">)&#39;);&quot;</span><span class="p">)</span></div>

    <span class="c1"># Links from HTML</span>
    <span class="c1">######################################################################</span>

    <span class="n">_links</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
        <span class="n">fields</span><span class="o">=</span><span class="n">onFields</span><span class="p">,</span>
        <span class="n">cards</span><span class="o">=</span><span class="n">onCardLayout</span><span class="p">,</span>
        <span class="n">bold</span><span class="o">=</span><span class="n">toggleBold</span><span class="p">,</span>
        <span class="n">italic</span><span class="o">=</span><span class="n">toggleItalic</span><span class="p">,</span>
        <span class="n">underline</span><span class="o">=</span><span class="n">toggleUnderline</span><span class="p">,</span>
        <span class="nb">super</span><span class="o">=</span><span class="n">toggleSuper</span><span class="p">,</span>
        <span class="n">sub</span><span class="o">=</span><span class="n">toggleSub</span><span class="p">,</span>
        <span class="n">clear</span><span class="o">=</span><span class="n">removeFormat</span><span class="p">,</span>
        <span class="n">colour</span><span class="o">=</span><span class="n">onForeground</span><span class="p">,</span>
        <span class="n">changeCol</span><span class="o">=</span><span class="n">onChangeCol</span><span class="p">,</span>
        <span class="n">cloze</span><span class="o">=</span><span class="n">onCloze</span><span class="p">,</span>
        <span class="n">attach</span><span class="o">=</span><span class="n">onAddMedia</span><span class="p">,</span>
        <span class="n">record</span><span class="o">=</span><span class="n">onRecSound</span><span class="p">,</span>
        <span class="n">more</span><span class="o">=</span><span class="n">onAdvanced</span><span class="p">,</span>
        <span class="n">dupes</span><span class="o">=</span><span class="n">showDupes</span><span class="p">,</span>
        <span class="n">paste</span><span class="o">=</span><span class="n">onPaste</span><span class="p">,</span>
        <span class="n">cutOrCopy</span><span class="o">=</span><span class="n">onCutOrCopy</span><span class="p">,</span>
    <span class="p">)</span></div>


<span class="c1"># Pasting, drag &amp; drop, and keyboard layouts</span>
<span class="c1">######################################################################</span>


<div class="viewcode-block" id="EditorWebView"><a class="viewcode-back" href="../../aqt.html#aqt.editor.EditorWebView">[docs]</a><span class="k">class</span> <span class="nc">EditorWebView</span><span class="p">(</span><span class="n">AnkiWebView</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="p">,</span> <span class="n">editor</span><span class="p">):</span>
        <span class="n">AnkiWebView</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;editor&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">editor</span> <span class="o">=</span> <span class="n">editor</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">strip</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">editor</span><span class="o">.</span><span class="n">mw</span><span class="o">.</span><span class="n">pm</span><span class="o">.</span><span class="n">profile</span><span class="p">[</span><span class="s2">&quot;stripHTML&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setAcceptDrops</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_markInternal</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">clip</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">editor</span><span class="o">.</span><span class="n">mw</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">clipboard</span><span class="p">()</span>
        <span class="n">qconnect</span><span class="p">(</span><span class="n">clip</span><span class="o">.</span><span class="n">dataChanged</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_onClipboardChange</span><span class="p">)</span>
        <span class="n">gui_hooks</span><span class="o">.</span><span class="n">editor_web_view_did_init</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_onClipboardChange</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_markInternal</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_markInternal</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_flagAnkiText</span><span class="p">()</span>

<div class="viewcode-block" id="EditorWebView.onCut"><a class="viewcode-back" href="../../aqt.html#aqt.editor.EditorWebView.onCut">[docs]</a>    <span class="k">def</span> <span class="nf">onCut</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">triggerPageAction</span><span class="p">(</span><span class="n">QWebEnginePage</span><span class="o">.</span><span class="n">Cut</span><span class="p">)</span></div>

<div class="viewcode-block" id="EditorWebView.onCopy"><a class="viewcode-back" href="../../aqt.html#aqt.editor.EditorWebView.onCopy">[docs]</a>    <span class="k">def</span> <span class="nf">onCopy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">triggerPageAction</span><span class="p">(</span><span class="n">QWebEnginePage</span><span class="o">.</span><span class="n">Copy</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_onPaste</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mode</span><span class="p">:</span> <span class="n">QClipboard</span><span class="o">.</span><span class="n">Mode</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">extended</span> <span class="o">=</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">editor</span><span class="o">.</span><span class="n">mw</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">queryKeyboardModifiers</span><span class="p">()</span> <span class="o">&amp;</span> <span class="n">Qt</span><span class="o">.</span><span class="n">ShiftModifier</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">editor</span><span class="o">.</span><span class="n">mw</span><span class="o">.</span><span class="n">pm</span><span class="o">.</span><span class="n">profile</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;pasteInvert&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
            <span class="n">extended</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">extended</span>
        <span class="n">mime</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">editor</span><span class="o">.</span><span class="n">mw</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">clipboard</span><span class="p">()</span><span class="o">.</span><span class="n">mimeData</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">)</span>
        <span class="n">html</span><span class="p">,</span> <span class="n">internal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_processMime</span><span class="p">(</span><span class="n">mime</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">html</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">editor</span><span class="o">.</span><span class="n">doPaste</span><span class="p">(</span><span class="n">html</span><span class="p">,</span> <span class="n">internal</span><span class="p">,</span> <span class="n">extended</span><span class="p">)</span>

<div class="viewcode-block" id="EditorWebView.onPaste"><a class="viewcode-back" href="../../aqt.html#aqt.editor.EditorWebView.onPaste">[docs]</a>    <span class="k">def</span> <span class="nf">onPaste</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_onPaste</span><span class="p">(</span><span class="n">QClipboard</span><span class="o">.</span><span class="n">Clipboard</span><span class="p">)</span></div>

<div class="viewcode-block" id="EditorWebView.onMiddleClickPaste"><a class="viewcode-back" href="../../aqt.html#aqt.editor.EditorWebView.onMiddleClickPaste">[docs]</a>    <span class="k">def</span> <span class="nf">onMiddleClickPaste</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_onPaste</span><span class="p">(</span><span class="n">QClipboard</span><span class="o">.</span><span class="n">Selection</span><span class="p">)</span></div>

<div class="viewcode-block" id="EditorWebView.dropEvent"><a class="viewcode-back" href="../../aqt.html#aqt.editor.EditorWebView.dropEvent">[docs]</a>    <span class="k">def</span> <span class="nf">dropEvent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">evt</span><span class="p">):</span>
        <span class="n">mime</span> <span class="o">=</span> <span class="n">evt</span><span class="o">.</span><span class="n">mimeData</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">evt</span><span class="o">.</span><span class="n">source</span><span class="p">()</span> <span class="ow">and</span> <span class="n">mime</span><span class="o">.</span><span class="n">hasHtml</span><span class="p">():</span>
            <span class="c1"># don&#39;t filter html from other fields</span>
            <span class="n">html</span><span class="p">,</span> <span class="n">internal</span> <span class="o">=</span> <span class="n">mime</span><span class="o">.</span><span class="n">html</span><span class="p">(),</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">html</span><span class="p">,</span> <span class="n">internal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_processMime</span><span class="p">(</span><span class="n">mime</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">html</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">editor</span><span class="o">.</span><span class="n">doDrop</span><span class="p">(</span><span class="n">html</span><span class="p">,</span> <span class="n">internal</span><span class="p">)</span></div>

    <span class="c1"># returns (html, isInternal)</span>
    <span class="k">def</span> <span class="nf">_processMime</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mime</span><span class="p">:</span> <span class="n">QMimeData</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]:</span>
        <span class="c1"># print(&quot;html=%s image=%s urls=%s txt=%s&quot; % (</span>
        <span class="c1">#     mime.hasHtml(), mime.hasImage(), mime.hasUrls(), mime.hasText()))</span>
        <span class="c1"># print(&quot;html&quot;, mime.html())</span>
        <span class="c1"># print(&quot;urls&quot;, mime.urls())</span>
        <span class="c1"># print(&quot;text&quot;, mime.text())</span>

        <span class="c1"># try various content types in turn</span>
        <span class="n">html</span><span class="p">,</span> <span class="n">internal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_processHtml</span><span class="p">(</span><span class="n">mime</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">html</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">html</span><span class="p">,</span> <span class="n">internal</span>

        <span class="c1"># favour url if it&#39;s a local link</span>
        <span class="k">if</span> <span class="n">mime</span><span class="o">.</span><span class="n">hasUrls</span><span class="p">()</span> <span class="ow">and</span> <span class="n">mime</span><span class="o">.</span><span class="n">urls</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">toString</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;file://&quot;</span><span class="p">):</span>
            <span class="n">types</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_processUrls</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_processImage</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_processText</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">types</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_processImage</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_processUrls</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_processText</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">fn</span> <span class="ow">in</span> <span class="n">types</span><span class="p">:</span>
            <span class="n">html</span> <span class="o">=</span> <span class="n">fn</span><span class="p">(</span><span class="n">mime</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">html</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">html</span><span class="p">,</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">_processUrls</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mime</span><span class="p">:</span> <span class="n">QMimeData</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">mime</span><span class="o">.</span><span class="n">hasUrls</span><span class="p">():</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">buf</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">for</span> <span class="n">qurl</span> <span class="ow">in</span> <span class="n">mime</span><span class="o">.</span><span class="n">urls</span><span class="p">():</span>
            <span class="n">url</span> <span class="o">=</span> <span class="n">qurl</span><span class="o">.</span><span class="n">toString</span><span class="p">()</span>
            <span class="c1"># chrome likes to give us the URL twice with a \n</span>
            <span class="n">url</span> <span class="o">=</span> <span class="n">url</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">buf</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">editor</span><span class="o">.</span><span class="n">urlToLink</span><span class="p">(</span><span class="n">url</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span>

        <span class="k">return</span> <span class="n">buf</span>

    <span class="k">def</span> <span class="nf">_processText</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mime</span><span class="p">:</span> <span class="n">QMimeData</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">mime</span><span class="o">.</span><span class="n">hasText</span><span class="p">():</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">txt</span> <span class="o">=</span> <span class="n">mime</span><span class="o">.</span><span class="n">text</span><span class="p">()</span>

        <span class="c1"># inlined data in base64?</span>
        <span class="k">if</span> <span class="n">txt</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;data:image/&quot;</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">editor</span><span class="o">.</span><span class="n">inlinedImageToLink</span><span class="p">(</span><span class="n">txt</span><span class="p">)</span>

        <span class="c1"># if the user is pasting an image or sound link, convert it to local</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">editor</span><span class="o">.</span><span class="n">isURL</span><span class="p">(</span><span class="n">txt</span><span class="p">):</span>
            <span class="n">url</span> <span class="o">=</span> <span class="n">txt</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\r\n</span><span class="s2">&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">link</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">editor</span><span class="o">.</span><span class="n">urlToLink</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">link</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">link</span>

            <span class="c1"># not media; add it as a normal link if pasting with shift</span>
            <span class="n">link</span> <span class="o">=</span> <span class="s1">&#39;&lt;a href=&quot;</span><span class="si">{}</span><span class="s1">&quot;&gt;</span><span class="si">{}</span><span class="s1">&lt;/a&gt;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">html</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">txt</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">link</span>

        <span class="c1"># normal text; convert it to HTML</span>
        <span class="n">txt</span> <span class="o">=</span> <span class="n">html</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">txt</span><span class="p">)</span>
        <span class="n">txt</span> <span class="o">=</span> <span class="n">txt</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt;br&gt;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span> <span class="o">*</span> <span class="mi">4</span><span class="p">)</span>

        <span class="c1"># if there&#39;s more than one consecutive space,</span>
        <span class="c1"># use non-breaking spaces for the second one on</span>
        <span class="k">def</span> <span class="nf">repl</span><span class="p">(</span><span class="n">match</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="s2">&quot;&amp;nbsp;&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span>

        <span class="n">txt</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">&quot; ( +)&quot;</span><span class="p">,</span> <span class="n">repl</span><span class="p">,</span> <span class="n">txt</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">txt</span>

    <span class="k">def</span> <span class="nf">_processHtml</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mime</span><span class="p">:</span> <span class="n">QMimeData</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="nb">bool</span><span class="p">]:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">mime</span><span class="o">.</span><span class="n">hasHtml</span><span class="p">():</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">False</span>
        <span class="n">html</span> <span class="o">=</span> <span class="n">mime</span><span class="o">.</span><span class="n">html</span><span class="p">()</span>

        <span class="c1"># no filtering required for internal pastes</span>
        <span class="k">if</span> <span class="n">html</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;&lt;!--anki--&gt;&quot;</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">html</span><span class="p">[</span><span class="mi">11</span><span class="p">:],</span> <span class="kc">True</span>

        <span class="k">return</span> <span class="n">html</span><span class="p">,</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">_processImage</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mime</span><span class="p">:</span> <span class="n">QMimeData</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">mime</span><span class="o">.</span><span class="n">hasImage</span><span class="p">():</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="n">im</span> <span class="o">=</span> <span class="n">QImage</span><span class="p">(</span><span class="n">mime</span><span class="o">.</span><span class="n">imageData</span><span class="p">())</span>
        <span class="n">uname</span> <span class="o">=</span> <span class="n">namedtmp</span><span class="p">(</span><span class="s2">&quot;paste&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">editor</span><span class="o">.</span><span class="n">mw</span><span class="o">.</span><span class="n">pm</span><span class="o">.</span><span class="n">profile</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;pastePNG&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
            <span class="n">ext</span> <span class="o">=</span> <span class="s2">&quot;.png&quot;</span>
            <span class="n">im</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">uname</span> <span class="o">+</span> <span class="n">ext</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="mi">50</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ext</span> <span class="o">=</span> <span class="s2">&quot;.jpg&quot;</span>
            <span class="n">im</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">uname</span> <span class="o">+</span> <span class="n">ext</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="mi">80</span><span class="p">)</span>

        <span class="c1"># invalid image?</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">uname</span> <span class="o">+</span> <span class="n">ext</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">editor</span><span class="o">.</span><span class="n">_addPastedImage</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">ext</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">fname</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">editor</span><span class="o">.</span><span class="n">fnameToLink</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

<div class="viewcode-block" id="EditorWebView.flagAnkiText"><a class="viewcode-back" href="../../aqt.html#aqt.editor.EditorWebView.flagAnkiText">[docs]</a>    <span class="k">def</span> <span class="nf">flagAnkiText</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># be ready to adjust when clipboard event fires</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_markInternal</span> <span class="o">=</span> <span class="kc">True</span></div>

    <span class="k">def</span> <span class="nf">_flagAnkiText</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># add a comment in the clipboard html so we can tell text is copied</span>
        <span class="c1"># from us and doesn&#39;t need to be stripped</span>
        <span class="n">clip</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">editor</span><span class="o">.</span><span class="n">mw</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">clipboard</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">isMac</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">clip</span><span class="o">.</span><span class="n">ownsClipboard</span><span class="p">():</span>
            <span class="k">return</span>
        <span class="n">mime</span> <span class="o">=</span> <span class="n">clip</span><span class="o">.</span><span class="n">mimeData</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">mime</span><span class="o">.</span><span class="n">hasHtml</span><span class="p">():</span>
            <span class="k">return</span>
        <span class="n">html</span> <span class="o">=</span> <span class="n">mime</span><span class="o">.</span><span class="n">html</span><span class="p">()</span>
        <span class="n">mime</span><span class="o">.</span><span class="n">setHtml</span><span class="p">(</span><span class="s2">&quot;&lt;!--anki--&gt;&quot;</span> <span class="o">+</span> <span class="n">html</span><span class="p">)</span>
        <span class="n">clip</span><span class="o">.</span><span class="n">setMimeData</span><span class="p">(</span><span class="n">mime</span><span class="p">)</span>

<div class="viewcode-block" id="EditorWebView.contextMenuEvent"><a class="viewcode-back" href="../../aqt.html#aqt.editor.EditorWebView.contextMenuEvent">[docs]</a>    <span class="k">def</span> <span class="nf">contextMenuEvent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">evt</span><span class="p">:</span> <span class="n">QContextMenuEvent</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">QMenu</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">addAction</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;Cut&quot;</span><span class="p">))</span>
        <span class="n">qconnect</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">triggered</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">onCut</span><span class="p">)</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">addAction</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;Copy&quot;</span><span class="p">))</span>
        <span class="n">qconnect</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">triggered</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">onCopy</span><span class="p">)</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">addAction</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;Paste&quot;</span><span class="p">))</span>
        <span class="n">qconnect</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">triggered</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">onPaste</span><span class="p">)</span>
        <span class="n">gui_hooks</span><span class="o">.</span><span class="n">editor_will_show_context_menu</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">m</span><span class="p">)</span>
        <span class="n">m</span><span class="o">.</span><span class="n">popup</span><span class="p">(</span><span class="n">QCursor</span><span class="o">.</span><span class="n">pos</span><span class="p">())</span></div></div>


<span class="c1"># QFont returns &quot;Kozuka Gothic Pro L&quot; but WebEngine expects &quot;Kozuka Gothic Pro Light&quot;</span>
<span class="c1"># - there may be other cases like a trailing &#39;Bold&#39; that need fixing, but will</span>
<span class="c1"># wait for further reports first.</span>
<div class="viewcode-block" id="fontMungeHack"><a class="viewcode-back" href="../../aqt.html#aqt.editor.fontMungeHack">[docs]</a><span class="k">def</span> <span class="nf">fontMungeHack</span><span class="p">(</span><span class="n">font</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">&quot; L$&quot;</span><span class="p">,</span> <span class="s2">&quot; Light&quot;</span><span class="p">,</span> <span class="n">font</span><span class="p">)</span></div>


<span class="n">gui_hooks</span><span class="o">.</span><span class="n">editor_will_use_font_for_field</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fontMungeHack</span><span class="p">)</span>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2020, Abdelrahman Hamdy

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>