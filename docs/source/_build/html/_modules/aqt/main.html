

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>aqt.main &mdash; Anki  documentation</title>
  

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />

  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home" alt="Documentation Home"> Anki
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../anki.html">anki package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../aqt.html">aqt package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../genhooks_gui.html">genhooks_gui module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tools.html">tools package</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Anki</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
          <li><a href="../aqt.html">aqt</a> &raquo;</li>
        
      <li>aqt.main</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for aqt.main</h1><div class="highlight"><pre>
<span></span><span class="c1"># Copyright: Ankitects Pty Ltd and contributors</span>
<span class="c1"># -*- coding: utf-8 -*-</span>
<span class="c1"># License: GNU AGPL, version 3 or later; http://www.gnu.org/licenses/agpl.html</span>

<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">annotations</span>

<span class="kn">import</span> <span class="nn">faulthandler</span>
<span class="kn">import</span> <span class="nn">gc</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">signal</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">weakref</span>
<span class="kn">import</span> <span class="nn">zipfile</span>
<span class="kn">from</span> <span class="nn">argparse</span> <span class="kn">import</span> <span class="n">Namespace</span>
<span class="kn">from</span> <span class="nn">threading</span> <span class="kn">import</span> <span class="n">Thread</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">,</span> <span class="n">Tuple</span>

<span class="kn">import</span> <span class="nn">anki</span>
<span class="kn">import</span> <span class="nn">aqt</span>
<span class="kn">import</span> <span class="nn">aqt.mediasrv</span>
<span class="kn">import</span> <span class="nn">aqt.mpv</span>
<span class="kn">import</span> <span class="nn">aqt.progress</span>
<span class="kn">import</span> <span class="nn">aqt.sound</span>
<span class="kn">import</span> <span class="nn">aqt.stats</span>
<span class="kn">import</span> <span class="nn">aqt.toolbar</span>
<span class="kn">import</span> <span class="nn">aqt.webview</span>
<span class="kn">from</span> <span class="nn">anki</span> <span class="kn">import</span> <span class="n">hooks</span>
<span class="kn">from</span> <span class="nn">anki.collection</span> <span class="kn">import</span> <span class="n">Collection</span>
<span class="kn">from</span> <span class="nn">anki.hooks</span> <span class="kn">import</span> <span class="n">runHook</span>
<span class="kn">from</span> <span class="nn">anki.lang</span> <span class="kn">import</span> <span class="n">_</span><span class="p">,</span> <span class="n">ngettext</span>
<span class="kn">from</span> <span class="nn">anki.rsbackend</span> <span class="kn">import</span> <span class="n">RustBackend</span>
<span class="kn">from</span> <span class="nn">anki.sound</span> <span class="kn">import</span> <span class="n">AVTag</span><span class="p">,</span> <span class="n">SoundOrVideoTag</span>
<span class="kn">from</span> <span class="nn">anki.utils</span> <span class="kn">import</span> <span class="n">devMode</span><span class="p">,</span> <span class="n">ids2str</span><span class="p">,</span> <span class="n">intTime</span><span class="p">,</span> <span class="n">isMac</span><span class="p">,</span> <span class="n">isWin</span><span class="p">,</span> <span class="n">splitFields</span>
<span class="kn">from</span> <span class="nn">aqt</span> <span class="kn">import</span> <span class="n">gui_hooks</span>
<span class="kn">from</span> <span class="nn">aqt.addons</span> <span class="kn">import</span> <span class="n">DownloadLogEntry</span><span class="p">,</span> <span class="n">check_and_prompt_for_updates</span><span class="p">,</span> <span class="n">show_log_to_user</span>
<span class="kn">from</span> <span class="nn">aqt.dbcheck</span> <span class="kn">import</span> <span class="n">check_db</span>
<span class="kn">from</span> <span class="nn">aqt.emptycards</span> <span class="kn">import</span> <span class="n">show_empty_cards</span>
<span class="kn">from</span> <span class="nn">aqt.legacy</span> <span class="kn">import</span> <span class="n">install_pylib_legacy</span>
<span class="kn">from</span> <span class="nn">aqt.mediacheck</span> <span class="kn">import</span> <span class="n">check_media_db</span>
<span class="kn">from</span> <span class="nn">aqt.mediasync</span> <span class="kn">import</span> <span class="n">MediaSyncer</span>
<span class="kn">from</span> <span class="nn">aqt.profiles</span> <span class="kn">import</span> <span class="n">ProfileManager</span> <span class="k">as</span> <span class="n">ProfileManagerType</span>
<span class="kn">from</span> <span class="nn">aqt.qt</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">aqt.qt</span> <span class="kn">import</span> <span class="n">sip</span>
<span class="kn">from</span> <span class="nn">aqt.sync</span> <span class="kn">import</span> <span class="n">sync_collection</span><span class="p">,</span> <span class="n">sync_login</span>
<span class="kn">from</span> <span class="nn">aqt.taskman</span> <span class="kn">import</span> <span class="n">TaskManager</span>
<span class="kn">from</span> <span class="nn">aqt.theme</span> <span class="kn">import</span> <span class="n">theme_manager</span>
<span class="kn">from</span> <span class="nn">aqt.utils</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">TR</span><span class="p">,</span>
    <span class="n">askUser</span><span class="p">,</span>
    <span class="n">checkInvalidFilename</span><span class="p">,</span>
    <span class="n">getFile</span><span class="p">,</span>
    <span class="n">getOnlyText</span><span class="p">,</span>
    <span class="n">openHelp</span><span class="p">,</span>
    <span class="n">openLink</span><span class="p">,</span>
    <span class="n">restoreGeom</span><span class="p">,</span>
    <span class="n">restoreSplitter</span><span class="p">,</span>
    <span class="n">restoreState</span><span class="p">,</span>
    <span class="n">saveGeom</span><span class="p">,</span>
    <span class="n">saveSplitter</span><span class="p">,</span>
    <span class="n">showInfo</span><span class="p">,</span>
    <span class="n">showWarning</span><span class="p">,</span>
    <span class="n">tooltip</span><span class="p">,</span>
    <span class="n">tr</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">install_pylib_legacy</span><span class="p">()</span>


<div class="viewcode-block" id="ResetRequired"><a class="viewcode-back" href="../../aqt.html#aqt.main.ResetRequired">[docs]</a><span class="k">class</span> <span class="nc">ResetRequired</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mw</span><span class="p">:</span> <span class="n">AnkiQt</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mw</span> <span class="o">=</span> <span class="n">mw</span></div>


<div class="viewcode-block" id="AnkiQt"><a class="viewcode-back" href="../../aqt.html#aqt.main.AnkiQt">[docs]</a><span class="k">class</span> <span class="nc">AnkiQt</span><span class="p">(</span><span class="n">QMainWindow</span><span class="p">):</span>
    <span class="n">col</span><span class="p">:</span> <span class="n">Collection</span>
    <span class="n">pm</span><span class="p">:</span> <span class="n">ProfileManagerType</span>
    <span class="n">web</span><span class="p">:</span> <span class="n">aqt</span><span class="o">.</span><span class="n">webview</span><span class="o">.</span><span class="n">AnkiWebView</span>
    <span class="n">bottomWeb</span><span class="p">:</span> <span class="n">aqt</span><span class="o">.</span><span class="n">webview</span><span class="o">.</span><span class="n">AnkiWebView</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">app</span><span class="p">:</span> <span class="n">QApplication</span><span class="p">,</span>
        <span class="n">profileManager</span><span class="p">:</span> <span class="n">ProfileManagerType</span><span class="p">,</span>
        <span class="n">backend</span><span class="p">:</span> <span class="n">RustBackend</span><span class="p">,</span>
        <span class="n">opts</span><span class="p">:</span> <span class="n">Namespace</span><span class="p">,</span>
        <span class="n">args</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">QMainWindow</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">backend</span> <span class="o">=</span> <span class="n">backend</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="s2">&quot;startup&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">opts</span> <span class="o">=</span> <span class="n">opts</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Collection</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">taskman</span> <span class="o">=</span> <span class="n">TaskManager</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">media_syncer</span> <span class="o">=</span> <span class="n">MediaSyncer</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">aqt</span><span class="o">.</span><span class="n">mw</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">app</span> <span class="o">=</span> <span class="n">app</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pm</span> <span class="o">=</span> <span class="n">profileManager</span>
        <span class="c1"># init rest of app</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">safeMode</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">queryKeyboardModifiers</span><span class="p">()</span> <span class="o">&amp;</span> <span class="n">Qt</span><span class="o">.</span><span class="n">ShiftModifier</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">setupUI</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">setupAddons</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">finish_ui_setup</span><span class="p">()</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">showInfo</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;Error during startup:</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">)</span> <span class="o">%</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="c1"># must call this after ui set up</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">safeMode</span><span class="p">:</span>
            <span class="n">tooltip</span><span class="p">(</span>
                <span class="n">_</span><span class="p">(</span>
                    <span class="s2">&quot;Shift key was held down. Skipping automatic &quot;</span>
                    <span class="s2">&quot;syncing and add-on loading.&quot;</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="c1"># were we given a file to import?</span>
        <span class="k">if</span> <span class="n">args</span> <span class="ow">and</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_isAddon</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">onAppMsg</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="c1"># Load profile in a timer so we can let the window finish init and not</span>
        <span class="c1"># close on profile load error.</span>
        <span class="k">if</span> <span class="n">isWin</span><span class="p">:</span>
            <span class="n">fn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">setupProfileAfterWebviewsLoaded</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">setupProfile</span>

        <span class="k">def</span> <span class="nf">on_window_init</span><span class="p">():</span>
            <span class="n">fn</span><span class="p">()</span>
            <span class="n">gui_hooks</span><span class="o">.</span><span class="n">main_window_did_init</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">progress</span><span class="o">.</span><span class="n">timer</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">on_window_init</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="n">requiresCollection</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<div class="viewcode-block" id="AnkiQt.setupUI"><a class="viewcode-back" href="../../aqt.html#aqt.main.AnkiQt.setupUI">[docs]</a>    <span class="k">def</span> <span class="nf">setupUI</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">col</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setupCrashLog</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">disableGC</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setupAppMsg</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setupKeys</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setupThreads</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setupMediaServer</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setupSound</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setupSpellCheck</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setupStyle</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setupMainWindow</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setupSystemSpecific</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setupMenus</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setupProgress</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setupErrorHandler</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setupSignals</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setupAutoUpdate</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setupHooks</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setup_timers</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">updateTitleBar</span><span class="p">()</span>
        <span class="c1"># screens</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setupDeckBrowser</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setupOverview</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setupReviewer</span><span class="p">()</span></div>

<div class="viewcode-block" id="AnkiQt.finish_ui_setup"><a class="viewcode-back" href="../../aqt.html#aqt.main.AnkiQt.finish_ui_setup">[docs]</a>    <span class="k">def</span> <span class="nf">finish_ui_setup</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="s2">&quot;Actions that are deferred until after add-on loading.&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">toolbar</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span></div>

<div class="viewcode-block" id="AnkiQt.setupProfileAfterWebviewsLoaded"><a class="viewcode-back" href="../../aqt.html#aqt.main.AnkiQt.setupProfileAfterWebviewsLoaded">[docs]</a>    <span class="k">def</span> <span class="nf">setupProfileAfterWebviewsLoaded</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">web</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bottomWeb</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">w</span><span class="o">.</span><span class="n">_domDone</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">progress</span><span class="o">.</span><span class="n">timer</span><span class="p">(</span>
                    <span class="mi">10</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">setupProfileAfterWebviewsLoaded</span><span class="p">,</span>
                    <span class="kc">False</span><span class="p">,</span>
                    <span class="n">requiresCollection</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="k">return</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">w</span><span class="o">.</span><span class="n">requiresCol</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">setupProfile</span><span class="p">()</span></div>

<div class="viewcode-block" id="AnkiQt.weakref"><a class="viewcode-back" href="../../aqt.html#aqt.main.AnkiQt.weakref">[docs]</a>    <span class="k">def</span> <span class="nf">weakref</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AnkiQt</span><span class="p">:</span>
        <span class="s2">&quot;Shortcut to create a weak reference that doesn&#39;t break code completion.&quot;</span>
        <span class="k">return</span> <span class="n">weakref</span><span class="o">.</span><span class="n">proxy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>  <span class="c1"># type: ignore</span></div>

    <span class="c1"># Profiles</span>
    <span class="c1">##########################################################################</span>

<div class="viewcode-block" id="AnkiQt.ProfileManager"><a class="viewcode-back" href="../../aqt.html#aqt.main.AnkiQt.ProfileManager">[docs]</a>    <span class="k">class</span> <span class="nc">ProfileManager</span><span class="p">(</span><span class="n">QMainWindow</span><span class="p">):</span>
        <span class="n">onClose</span> <span class="o">=</span> <span class="n">pyqtSignal</span><span class="p">()</span>
        <span class="n">closeFires</span> <span class="o">=</span> <span class="kc">True</span>

<div class="viewcode-block" id="AnkiQt.ProfileManager.closeEvent"><a class="viewcode-back" href="../../aqt.html#aqt.main.AnkiQt.ProfileManager.closeEvent">[docs]</a>        <span class="k">def</span> <span class="nf">closeEvent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">evt</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">closeFires</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">onClose</span><span class="o">.</span><span class="n">emit</span><span class="p">()</span>
            <span class="n">evt</span><span class="o">.</span><span class="n">accept</span><span class="p">()</span></div>

<div class="viewcode-block" id="AnkiQt.ProfileManager.closeWithoutQuitting"><a class="viewcode-back" href="../../aqt.html#aqt.main.AnkiQt.ProfileManager.closeWithoutQuitting">[docs]</a>        <span class="k">def</span> <span class="nf">closeWithoutQuitting</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">closeFires</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">closeFires</span> <span class="o">=</span> <span class="kc">True</span></div></div>

<div class="viewcode-block" id="AnkiQt.setupProfile"><a class="viewcode-back" href="../../aqt.html#aqt.main.AnkiQt.setupProfile">[docs]</a>    <span class="k">def</span> <span class="nf">setupProfile</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pm</span><span class="o">.</span><span class="n">meta</span><span class="p">[</span><span class="s2">&quot;firstRun&quot;</span><span class="p">]:</span>
            <span class="c1"># load the new deck user profile</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pm</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pm</span><span class="o">.</span><span class="n">profiles</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pm</span><span class="o">.</span><span class="n">meta</span><span class="p">[</span><span class="s2">&quot;firstRun&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pm</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">pendingImport</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">restoringBackup</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="c1"># profile not provided on command line?</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">pm</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
            <span class="c1"># if there&#39;s a single profile, load it automatically</span>
            <span class="n">profs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pm</span><span class="o">.</span><span class="n">profiles</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">profs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pm</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">profs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">pm</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">showProfileManager</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">loadProfile</span><span class="p">()</span></div>

<div class="viewcode-block" id="AnkiQt.showProfileManager"><a class="viewcode-back" href="../../aqt.html#aqt.main.AnkiQt.showProfileManager">[docs]</a>    <span class="k">def</span> <span class="nf">showProfileManager</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pm</span><span class="o">.</span><span class="n">profile</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="s2">&quot;profileManager&quot;</span>
        <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">profileDiag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ProfileManager</span><span class="p">()</span>
        <span class="n">f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">profileForm</span> <span class="o">=</span> <span class="n">aqt</span><span class="o">.</span><span class="n">forms</span><span class="o">.</span><span class="n">profiles</span><span class="o">.</span><span class="n">Ui_MainWindow</span><span class="p">()</span>
        <span class="n">f</span><span class="o">.</span><span class="n">setupUi</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
        <span class="n">qconnect</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">login</span><span class="o">.</span><span class="n">clicked</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">onOpenProfile</span><span class="p">)</span>
        <span class="n">qconnect</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">profiles</span><span class="o">.</span><span class="n">itemDoubleClicked</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">onOpenProfile</span><span class="p">)</span>
        <span class="n">qconnect</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">openBackup</span><span class="o">.</span><span class="n">clicked</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">onOpenBackup</span><span class="p">)</span>
        <span class="n">qconnect</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">quit</span><span class="o">.</span><span class="n">clicked</span><span class="p">,</span> <span class="n">d</span><span class="o">.</span><span class="n">close</span><span class="p">)</span>
        <span class="n">qconnect</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">onClose</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cleanupAndExit</span><span class="p">)</span>
        <span class="n">qconnect</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">add</span><span class="o">.</span><span class="n">clicked</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">onAddProfile</span><span class="p">)</span>
        <span class="n">qconnect</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">rename</span><span class="o">.</span><span class="n">clicked</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">onRenameProfile</span><span class="p">)</span>
        <span class="n">qconnect</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">delete_2</span><span class="o">.</span><span class="n">clicked</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">onRemProfile</span><span class="p">)</span>
        <span class="n">qconnect</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">profiles</span><span class="o">.</span><span class="n">currentRowChanged</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">onProfileRowChange</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">statusbar</span><span class="o">.</span><span class="n">setVisible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">qconnect</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">downgrade_button</span><span class="o">.</span><span class="n">clicked</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_on_downgrade</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">downgrade_button</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="n">tr</span><span class="p">(</span><span class="n">TR</span><span class="o">.</span><span class="n">PROFILES_DOWNGRADE_AND_QUIT</span><span class="p">))</span>
        <span class="c1"># enter key opens profile</span>
        <span class="n">QShortcut</span><span class="p">(</span><span class="n">QKeySequence</span><span class="p">(</span><span class="s2">&quot;Return&quot;</span><span class="p">),</span> <span class="n">d</span><span class="p">,</span> <span class="n">activated</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">onOpenProfile</span><span class="p">)</span>  <span class="c1"># type: ignore</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">refreshProfilesList</span><span class="p">()</span>
        <span class="c1"># raise first, for osx testing</span>
        <span class="n">d</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        <span class="n">d</span><span class="o">.</span><span class="n">activateWindow</span><span class="p">()</span>
        <span class="n">d</span><span class="o">.</span><span class="n">raise_</span><span class="p">()</span></div>

<div class="viewcode-block" id="AnkiQt.refreshProfilesList"><a class="viewcode-back" href="../../aqt.html#aqt.main.AnkiQt.refreshProfilesList">[docs]</a>    <span class="k">def</span> <span class="nf">refreshProfilesList</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">profileForm</span>
        <span class="n">f</span><span class="o">.</span><span class="n">profiles</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="n">profs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pm</span><span class="o">.</span><span class="n">profiles</span><span class="p">()</span>
        <span class="n">f</span><span class="o">.</span><span class="n">profiles</span><span class="o">.</span><span class="n">addItems</span><span class="p">(</span><span class="n">profs</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="n">profs</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pm</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">f</span><span class="o">.</span><span class="n">profiles</span><span class="o">.</span><span class="n">setCurrentRow</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span></div>

<div class="viewcode-block" id="AnkiQt.onProfileRowChange"><a class="viewcode-back" href="../../aqt.html#aqt.main.AnkiQt.onProfileRowChange">[docs]</a>    <span class="k">def</span> <span class="nf">onProfileRowChange</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># called on .clear()</span>
            <span class="k">return</span>
        <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pm</span><span class="o">.</span><span class="n">profiles</span><span class="p">()[</span><span class="n">n</span><span class="p">]</span>
        <span class="n">f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">profileForm</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pm</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">name</span><span class="p">)</span></div>

<div class="viewcode-block" id="AnkiQt.openProfile"><a class="viewcode-back" href="../../aqt.html#aqt.main.AnkiQt.openProfile">[docs]</a>    <span class="k">def</span> <span class="nf">openProfile</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pm</span><span class="o">.</span><span class="n">profiles</span><span class="p">()[</span><span class="bp">self</span><span class="o">.</span><span class="n">profileForm</span><span class="o">.</span><span class="n">profiles</span><span class="o">.</span><span class="n">currentRow</span><span class="p">()]</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pm</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">name</span><span class="p">)</span></div>

<div class="viewcode-block" id="AnkiQt.onOpenProfile"><a class="viewcode-back" href="../../aqt.html#aqt.main.AnkiQt.onOpenProfile">[docs]</a>    <span class="k">def</span> <span class="nf">onOpenProfile</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">profileDiag</span><span class="o">.</span><span class="n">hide</span><span class="p">()</span>
        <span class="c1"># code flow is confusing here - if load fails, profile dialog</span>
        <span class="c1"># will be shown again</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loadProfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">profileDiag</span><span class="o">.</span><span class="n">closeWithoutQuitting</span><span class="p">)</span></div>

<div class="viewcode-block" id="AnkiQt.profileNameOk"><a class="viewcode-back" href="../../aqt.html#aqt.main.AnkiQt.profileNameOk">[docs]</a>    <span class="k">def</span> <span class="nf">profileNameOk</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="ow">not</span> <span class="n">checkInvalidFilename</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="ow">and</span> <span class="n">name</span> <span class="o">!=</span> <span class="s2">&quot;addons21&quot;</span></div>

<div class="viewcode-block" id="AnkiQt.onAddProfile"><a class="viewcode-back" href="../../aqt.html#aqt.main.AnkiQt.onAddProfile">[docs]</a>    <span class="k">def</span> <span class="nf">onAddProfile</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">getOnlyText</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;Name:&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">name</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pm</span><span class="o">.</span><span class="n">profiles</span><span class="p">():</span>
                <span class="k">return</span> <span class="n">showWarning</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;Name exists.&quot;</span><span class="p">))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">profileNameOk</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
                <span class="k">return</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pm</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pm</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">refreshProfilesList</span><span class="p">()</span></div>

<div class="viewcode-block" id="AnkiQt.onRenameProfile"><a class="viewcode-back" href="../../aqt.html#aqt.main.AnkiQt.onRenameProfile">[docs]</a>    <span class="k">def</span> <span class="nf">onRenameProfile</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">getOnlyText</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;New name:&quot;</span><span class="p">),</span> <span class="n">default</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pm</span><span class="o">.</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">name</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">pm</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pm</span><span class="o">.</span><span class="n">profiles</span><span class="p">():</span>
            <span class="k">return</span> <span class="n">showWarning</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;Name exists.&quot;</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">profileNameOk</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pm</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">refreshProfilesList</span><span class="p">()</span></div>

<div class="viewcode-block" id="AnkiQt.onRemProfile"><a class="viewcode-back" href="../../aqt.html#aqt.main.AnkiQt.onRemProfile">[docs]</a>    <span class="k">def</span> <span class="nf">onRemProfile</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">profs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pm</span><span class="o">.</span><span class="n">profiles</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">profs</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">showWarning</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;There must be at least one profile.&quot;</span><span class="p">))</span>
        <span class="c1"># sure?</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">askUser</span><span class="p">(</span>
            <span class="n">_</span><span class="p">(</span>
                <span class="sd">&quot;&quot;&quot;\</span>
<span class="sd">All cards, notes, and media for this profile will be deleted. \</span>
<span class="sd">Are you sure?&quot;&quot;&quot;</span>
            <span class="p">),</span>
            <span class="n">msgfunc</span><span class="o">=</span><span class="n">QMessageBox</span><span class="o">.</span><span class="n">warning</span><span class="p">,</span>
            <span class="n">defaultno</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">):</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pm</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pm</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">refreshProfilesList</span><span class="p">()</span></div>

<div class="viewcode-block" id="AnkiQt.onOpenBackup"><a class="viewcode-back" href="../../aqt.html#aqt.main.AnkiQt.onOpenBackup">[docs]</a>    <span class="k">def</span> <span class="nf">onOpenBackup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">askUser</span><span class="p">(</span>
            <span class="n">_</span><span class="p">(</span>
                <span class="sd">&quot;&quot;&quot;\</span>
<span class="sd">Replace your collection with an earlier backup?&quot;&quot;&quot;</span>
            <span class="p">),</span>
            <span class="n">msgfunc</span><span class="o">=</span><span class="n">QMessageBox</span><span class="o">.</span><span class="n">warning</span><span class="p">,</span>
            <span class="n">defaultno</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">):</span>
            <span class="k">return</span>

        <span class="k">def</span> <span class="nf">doOpen</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_openBackup</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

        <span class="n">getFile</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">profileDiag</span><span class="p">,</span>
            <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Revert to backup&quot;</span><span class="p">),</span>
            <span class="n">cb</span><span class="o">=</span><span class="n">doOpen</span><span class="p">,</span>
            <span class="nb">filter</span><span class="o">=</span><span class="s2">&quot;*.colpkg&quot;</span><span class="p">,</span>
            <span class="nb">dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pm</span><span class="o">.</span><span class="n">backupFolder</span><span class="p">(),</span>
        <span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_openBackup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># move the existing collection to the trash, as it may not open</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pm</span><span class="o">.</span><span class="n">trashCollection</span><span class="p">()</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">showWarning</span><span class="p">(</span>
                <span class="n">_</span><span class="p">(</span>
                    <span class="s2">&quot;Unable to move existing file to trash - please try restarting your computer.&quot;</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">pendingImport</span> <span class="o">=</span> <span class="n">path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">restoringBackup</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="n">showInfo</span><span class="p">(</span>
            <span class="n">_</span><span class="p">(</span>
                <span class="sd">&quot;&quot;&quot;\</span>
<span class="sd">Automatic syncing and backups have been disabled while restoring. To enable them again, \</span>
<span class="sd">close the profile or restart Anki.&quot;&quot;&quot;</span>
            <span class="p">)</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">onOpenProfile</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_on_downgrade</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">progress</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="n">profiles</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pm</span><span class="o">.</span><span class="n">profiles</span><span class="p">()</span>

        <span class="k">def</span> <span class="nf">downgrade</span><span class="p">():</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pm</span><span class="o">.</span><span class="n">downgrade</span><span class="p">(</span><span class="n">profiles</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">on_done</span><span class="p">(</span><span class="n">future</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">progress</span><span class="o">.</span><span class="n">finish</span><span class="p">()</span>
            <span class="n">problems</span> <span class="o">=</span> <span class="n">future</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">problems</span><span class="p">:</span>
                <span class="n">showInfo</span><span class="p">(</span><span class="s2">&quot;Profiles can now be opened with an older version of Anki.&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">showWarning</span><span class="p">(</span>
                    <span class="s2">&quot;The following profiles could not be downgraded: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">problems</span><span class="p">)</span>
                    <span class="p">)</span>
                <span class="p">)</span>
                <span class="k">return</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">profileDiag</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">taskman</span><span class="o">.</span><span class="n">run_in_background</span><span class="p">(</span><span class="n">downgrade</span><span class="p">,</span> <span class="n">on_done</span><span class="p">)</span>

<div class="viewcode-block" id="AnkiQt.loadProfile"><a class="viewcode-back" href="../../aqt.html#aqt.main.AnkiQt.loadProfile">[docs]</a>    <span class="k">def</span> <span class="nf">loadProfile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">onsuccess</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">loadCollection</span><span class="p">():</span>
            <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">pm</span><span class="o">.</span><span class="n">apply_profile_options</span><span class="p">()</span>

        <span class="c1"># show main window</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pm</span><span class="o">.</span><span class="n">profile</span><span class="p">[</span><span class="s2">&quot;mainWindowState&quot;</span><span class="p">]:</span>
            <span class="n">restoreGeom</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;mainWindow&quot;</span><span class="p">)</span>
            <span class="n">restoreState</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;mainWindow&quot;</span><span class="p">)</span>
        <span class="c1"># titlebar</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setWindowTitle</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pm</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot; - Anki&quot;</span><span class="p">)</span>
        <span class="c1"># show and raise window for osx</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">activateWindow</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">raise_</span><span class="p">()</span>

        <span class="c1"># import pending?</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pendingImport</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_isAddon</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pendingImport</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">installAddon</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pendingImport</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">handleImport</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pendingImport</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pendingImport</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">gui_hooks</span><span class="o">.</span><span class="n">profile_did_open</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">onsuccess</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">onsuccess</span> <span class="o">=</span> <span class="k">lambda</span><span class="p">:</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">maybe_auto_sync_on_open_close</span><span class="p">(</span><span class="n">onsuccess</span><span class="p">)</span></div>

<div class="viewcode-block" id="AnkiQt.unloadProfile"><a class="viewcode-back" href="../../aqt.html#aqt.main.AnkiQt.unloadProfile">[docs]</a>    <span class="k">def</span> <span class="nf">unloadProfile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">onsuccess</span><span class="p">:</span> <span class="n">Callable</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">def</span> <span class="nf">callback</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_unloadProfile</span><span class="p">()</span>
            <span class="n">onsuccess</span><span class="p">()</span>

        <span class="n">gui_hooks</span><span class="o">.</span><span class="n">profile_will_close</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">unloadCollection</span><span class="p">(</span><span class="n">callback</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_unloadProfile</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pm</span><span class="o">.</span><span class="n">profile</span><span class="p">[</span><span class="s2">&quot;mainWindowGeom&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">saveGeometry</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pm</span><span class="o">.</span><span class="n">profile</span><span class="p">[</span><span class="s2">&quot;mainWindowState&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">saveState</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pm</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hide</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">restoringBackup</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># at this point there should be no windows left</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_checkForUnclosedWidgets</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_checkForUnclosedWidgets</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">topLevelWidgets</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">w</span><span class="o">.</span><span class="n">isVisible</span><span class="p">():</span>
                <span class="c1"># windows with this property are safe to close immediately</span>
                <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="s2">&quot;silentlyClose&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
                    <span class="n">w</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Window should have been closed: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">w</span><span class="p">))</span>

<div class="viewcode-block" id="AnkiQt.unloadProfileAndExit"><a class="viewcode-back" href="../../aqt.html#aqt.main.AnkiQt.unloadProfileAndExit">[docs]</a>    <span class="k">def</span> <span class="nf">unloadProfileAndExit</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">unloadProfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cleanupAndExit</span><span class="p">)</span></div>

<div class="viewcode-block" id="AnkiQt.unloadProfileAndShowProfileManager"><a class="viewcode-back" href="../../aqt.html#aqt.main.AnkiQt.unloadProfileAndShowProfileManager">[docs]</a>    <span class="k">def</span> <span class="nf">unloadProfileAndShowProfileManager</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">unloadProfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">showProfileManager</span><span class="p">)</span></div>

<div class="viewcode-block" id="AnkiQt.cleanupAndExit"><a class="viewcode-back" href="../../aqt.html#aqt.main.AnkiQt.cleanupAndExit">[docs]</a>    <span class="k">def</span> <span class="nf">cleanupAndExit</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">errorHandler</span><span class="o">.</span><span class="n">unload</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mediaServer</span><span class="o">.</span><span class="n">shutdown</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span></div>

    <span class="c1"># Sound/video</span>
    <span class="c1">##########################################################################</span>

<div class="viewcode-block" id="AnkiQt.setupSound"><a class="viewcode-back" href="../../aqt.html#aqt.main.AnkiQt.setupSound">[docs]</a>    <span class="k">def</span> <span class="nf">setupSound</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">aqt</span><span class="o">.</span><span class="n">sound</span><span class="o">.</span><span class="n">setup_audio</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">taskman</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pm</span><span class="o">.</span><span class="n">base</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_add_play_buttons</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="s2">&quot;Return card text with play buttons added, or stripped.&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pm</span><span class="o">.</span><span class="n">profile</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;showPlayButtons&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">aqt</span><span class="o">.</span><span class="n">sound</span><span class="o">.</span><span class="n">av_refs_to_play_icons</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">anki</span><span class="o">.</span><span class="n">sound</span><span class="o">.</span><span class="n">strip_av_refs</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>

<div class="viewcode-block" id="AnkiQt.prepare_card_text_for_display"><a class="viewcode-back" href="../../aqt.html#aqt.main.AnkiQt.prepare_card_text_for_display">[docs]</a>    <span class="k">def</span> <span class="nf">prepare_card_text_for_display</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">text</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="o">.</span><span class="n">media</span><span class="o">.</span><span class="n">escapeImages</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
        <span class="n">text</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_add_play_buttons</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">text</span></div>

    <span class="c1"># Collection load/unload</span>
    <span class="c1">##########################################################################</span>

<div class="viewcode-block" id="AnkiQt.loadCollection"><a class="viewcode-back" href="../../aqt.html#aqt.main.AnkiQt.loadCollection">[docs]</a>    <span class="k">def</span> <span class="nf">loadCollection</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_loadCollection</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;FileTooNew&quot;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">):</span>
                <span class="n">showWarning</span><span class="p">(</span>
                    <span class="s2">&quot;This profile requires a newer version of Anki to open. Did you forget to use the Downgrade button prior to switching Anki versions?&quot;</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">showWarning</span><span class="p">(</span>
                    <span class="n">tr</span><span class="p">(</span><span class="n">TR</span><span class="o">.</span><span class="n">ERRORS_UNABLE_OPEN_COLLECTION</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
                <span class="p">)</span>
            <span class="c1"># clean up open collection if possible</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">backend</span><span class="o">.</span><span class="n">close_collection</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;unable to close collection:&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">col</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="c1"># return to profile manager</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hide</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">showProfileManager</span><span class="p">()</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="c1"># make sure we don&#39;t get into an inconsistent state if an add-on</span>
        <span class="c1"># has broken the deck browser or the did_load hook</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">maybeEnableUndo</span><span class="p">()</span>
            <span class="n">gui_hooks</span><span class="o">.</span><span class="n">collection_did_load</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">moveToState</span><span class="p">(</span><span class="s2">&quot;deckBrowser&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="c1"># dump error to stderr so it gets picked up by errors.py</span>
            <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>

        <span class="k">return</span> <span class="kc">True</span></div>

    <span class="k">def</span> <span class="nf">_loadCollection</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">cpath</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pm</span><span class="o">.</span><span class="n">collectionPath</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">col</span> <span class="o">=</span> <span class="n">Collection</span><span class="p">(</span><span class="n">cpath</span><span class="p">,</span> <span class="n">backend</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">backend</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

<div class="viewcode-block" id="AnkiQt.reopen"><a class="viewcode-back" href="../../aqt.html#aqt.main.AnkiQt.reopen">[docs]</a>    <span class="k">def</span> <span class="nf">reopen</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="o">.</span><span class="n">reopen</span><span class="p">()</span></div>

<div class="viewcode-block" id="AnkiQt.unloadCollection"><a class="viewcode-back" href="../../aqt.html#aqt.main.AnkiQt.unloadCollection">[docs]</a>    <span class="k">def</span> <span class="nf">unloadCollection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">onsuccess</span><span class="p">:</span> <span class="n">Callable</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">def</span> <span class="nf">after_media_sync</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_unloadCollection</span><span class="p">()</span>
            <span class="n">onsuccess</span><span class="p">()</span>

        <span class="k">def</span> <span class="nf">after_sync</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">media_syncer</span><span class="o">.</span><span class="n">show_diag_until_finished</span><span class="p">(</span><span class="n">after_media_sync</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">before_sync</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">maybe_auto_sync_on_open_close</span><span class="p">(</span><span class="n">after_sync</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">closeAllWindows</span><span class="p">(</span><span class="n">before_sync</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_unloadCollection</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">restoringBackup</span><span class="p">:</span>
            <span class="n">label</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Closing...&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">label</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Backing Up...&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">progress</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">)</span>
        <span class="n">corrupt</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">maybeOptimize</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">devMode</span><span class="p">:</span>
                <span class="n">corrupt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">scalar</span><span class="p">(</span><span class="s2">&quot;pragma quick_check&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="s2">&quot;ok&quot;</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">corrupt</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">downgrade</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="n">corrupt</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">col</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">progress</span><span class="o">.</span><span class="n">finish</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">corrupt</span><span class="p">:</span>
            <span class="n">showWarning</span><span class="p">(</span>
                <span class="n">_</span><span class="p">(</span>
                    <span class="s2">&quot;Your collection file appears to be corrupt. </span><span class="se">\</span>
<span class="s2">This can happen when the file is copied or moved while Anki is open, or </span><span class="se">\</span>
<span class="s2">when the collection is stored on a network or cloud drive. If problems </span><span class="se">\</span>
<span class="s2">persist after restarting your computer, please open an automatic backup </span><span class="se">\</span>
<span class="s2">from the profile screen.&quot;</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">corrupt</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">restoringBackup</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">backup</span><span class="p">()</span>

    <span class="c1"># Backup and auto-optimize</span>
    <span class="c1">##########################################################################</span>

<div class="viewcode-block" id="AnkiQt.BackupThread"><a class="viewcode-back" href="../../aqt.html#aqt.main.AnkiQt.BackupThread">[docs]</a>    <span class="k">class</span> <span class="nc">BackupThread</span><span class="p">(</span><span class="n">Thread</span><span class="p">):</span>
        <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
            <span class="n">Thread</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">path</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">data</span>
            <span class="c1"># create the file in calling thread to ensure the same</span>
            <span class="c1"># file is not created twice</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
                <span class="k">pass</span>

<div class="viewcode-block" id="AnkiQt.BackupThread.run"><a class="viewcode-back" href="../../aqt.html#aqt.main.AnkiQt.BackupThread.run">[docs]</a>        <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="n">z</span> <span class="o">=</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">ZipFile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">ZIP_DEFLATED</span><span class="p">)</span>
            <span class="n">z</span><span class="o">.</span><span class="n">writestr</span><span class="p">(</span><span class="s2">&quot;collection.anki2&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
            <span class="n">z</span><span class="o">.</span><span class="n">writestr</span><span class="p">(</span><span class="s2">&quot;media&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">z</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div></div>

<div class="viewcode-block" id="AnkiQt.backup"><a class="viewcode-back" href="../../aqt.html#aqt.main.AnkiQt.backup">[docs]</a>    <span class="k">def</span> <span class="nf">backup</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">nbacks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pm</span><span class="o">.</span><span class="n">profile</span><span class="p">[</span><span class="s2">&quot;numBackups&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">nbacks</span> <span class="ow">or</span> <span class="n">devMode</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="nb">dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pm</span><span class="o">.</span><span class="n">backupFolder</span><span class="p">()</span>
        <span class="n">path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pm</span><span class="o">.</span><span class="n">collectionPath</span><span class="p">()</span>

        <span class="c1"># do backup</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span>
            <span class="s2">&quot;backup-%Y-%m-</span><span class="si">%d</span><span class="s2">-%H.%M.%S.colpkg&quot;</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">localtime</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span>
        <span class="p">)</span>
        <span class="n">newpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">dir</span><span class="p">,</span> <span class="n">fname</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">BackupThread</span><span class="p">(</span><span class="n">newpath</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

        <span class="c1"># find existing backups</span>
        <span class="n">backups</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="nb">dir</span><span class="p">):</span>
            <span class="c1"># only look for new-style format</span>
            <span class="n">m</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;backup-\d</span><span class="si">{4}</span><span class="s2">-\d</span><span class="si">{2}</span><span class="s2">-.+.colpkg&quot;</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">m</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">backups</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
        <span class="n">backups</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>

        <span class="c1"># remove old ones</span>
        <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">backups</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">nbacks</span><span class="p">:</span>
            <span class="n">fname</span> <span class="o">=</span> <span class="n">backups</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">dir</span><span class="p">,</span> <span class="n">fname</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="n">gui_hooks</span><span class="o">.</span><span class="n">backup_did_complete</span><span class="p">()</span></div>

<div class="viewcode-block" id="AnkiQt.maybeOptimize"><a class="viewcode-back" href="../../aqt.html#aqt.main.AnkiQt.maybeOptimize">[docs]</a>    <span class="k">def</span> <span class="nf">maybeOptimize</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># have two weeks passed?</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">intTime</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">pm</span><span class="o">.</span><span class="n">profile</span><span class="p">[</span><span class="s2">&quot;lastOptimize&quot;</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">86400</span> <span class="o">*</span> <span class="mi">14</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">progress</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;Optimizing...&quot;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="o">.</span><span class="n">optimize</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pm</span><span class="o">.</span><span class="n">profile</span><span class="p">[</span><span class="s2">&quot;lastOptimize&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">intTime</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pm</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">progress</span><span class="o">.</span><span class="n">finish</span><span class="p">()</span></div>

    <span class="c1"># State machine</span>
    <span class="c1">##########################################################################</span>

<div class="viewcode-block" id="AnkiQt.moveToState"><a class="viewcode-back" href="../../aqt.html#aqt.main.AnkiQt.moveToState">[docs]</a>    <span class="k">def</span> <span class="nf">moveToState</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># print(&quot;-&gt; move from&quot;, self.state, &quot;to&quot;, state)</span>
        <span class="n">oldState</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="ow">or</span> <span class="s2">&quot;dummy&quot;</span>
        <span class="n">cleanup</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">oldState</span> <span class="o">+</span> <span class="s2">&quot;Cleanup&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cleanup</span><span class="p">:</span>
            <span class="c1"># pylint: disable=not-callable</span>
            <span class="n">cleanup</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clearStateShortcuts</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">state</span>
        <span class="n">gui_hooks</span><span class="o">.</span><span class="n">state_will_change</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">oldState</span><span class="p">)</span>
        <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">state</span> <span class="o">+</span> <span class="s2">&quot;State&quot;</span><span class="p">)(</span><span class="n">oldState</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">state</span> <span class="o">!=</span> <span class="s2">&quot;resetRequired&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bottomWeb</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        <span class="n">gui_hooks</span><span class="o">.</span><span class="n">state_did_change</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">oldState</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_deckBrowserState</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">oldState</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">maybe_check_for_addon_updates</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">deckBrowser</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_selectedDeck</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="n">did</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="o">.</span><span class="n">decks</span><span class="o">.</span><span class="n">selected</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="o">.</span><span class="n">decks</span><span class="o">.</span><span class="n">nameOrNone</span><span class="p">(</span><span class="n">did</span><span class="p">):</span>
            <span class="n">showInfo</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;Please select a deck.&quot;</span><span class="p">))</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="o">.</span><span class="n">decks</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">did</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_overviewState</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">oldState</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_selectedDeck</span><span class="p">():</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">moveToState</span><span class="p">(</span><span class="s2">&quot;deckBrowser&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">overview</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_reviewState</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">oldState</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reviewer</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_reviewCleanup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">newState</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">newState</span> <span class="o">!=</span> <span class="s2">&quot;resetRequired&quot;</span> <span class="ow">and</span> <span class="n">newState</span> <span class="o">!=</span> <span class="s2">&quot;review&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reviewer</span><span class="o">.</span><span class="n">cleanup</span><span class="p">()</span>

    <span class="c1"># Resetting state</span>
    <span class="c1">##########################################################################</span>

<div class="viewcode-block" id="AnkiQt.reset"><a class="viewcode-back" href="../../aqt.html#aqt.main.AnkiQt.reset">[docs]</a>    <span class="k">def</span> <span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">guiOnly</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="s2">&quot;Called for non-trivial edits. Rebuilds queue and updates UI.&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">guiOnly</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
            <span class="n">gui_hooks</span><span class="o">.</span><span class="n">state_did_reset</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">maybeEnableUndo</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">moveToState</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">)</span></div>

<div class="viewcode-block" id="AnkiQt.requireReset"><a class="viewcode-back" href="../../aqt.html#aqt.main.AnkiQt.requireReset">[docs]</a>    <span class="k">def</span> <span class="nf">requireReset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">modal</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="s2">&quot;Signal queue needs to be rebuilt when edits are finished or by user.&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">autosave</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">resetModal</span> <span class="o">=</span> <span class="n">modal</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">interactiveState</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">moveToState</span><span class="p">(</span><span class="s2">&quot;resetRequired&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="AnkiQt.interactiveState"><a class="viewcode-back" href="../../aqt.html#aqt.main.AnkiQt.interactiveState">[docs]</a>    <span class="k">def</span> <span class="nf">interactiveState</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s2">&quot;True if not in profile manager, syncing, etc.&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;overview&quot;</span><span class="p">,</span> <span class="s2">&quot;review&quot;</span><span class="p">,</span> <span class="s2">&quot;deckBrowser&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="AnkiQt.maybeReset"><a class="viewcode-back" href="../../aqt.html#aqt.main.AnkiQt.maybeReset">[docs]</a>    <span class="k">def</span> <span class="nf">maybeReset</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">autosave</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="s2">&quot;resetRequired&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">returnState</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span></div>

<div class="viewcode-block" id="AnkiQt.delayedMaybeReset"><a class="viewcode-back" href="../../aqt.html#aqt.main.AnkiQt.delayedMaybeReset">[docs]</a>    <span class="k">def</span> <span class="nf">delayedMaybeReset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># if we redraw the page in a button click event it will often crash on</span>
        <span class="c1"># windows</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">progress</span><span class="o">.</span><span class="n">timer</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">maybeReset</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_resetRequiredState</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">oldState</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">oldState</span> <span class="o">!=</span> <span class="s2">&quot;resetRequired&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">returnState</span> <span class="o">=</span> <span class="n">oldState</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">resetModal</span><span class="p">:</span>
            <span class="c1"># we don&#39;t have to change the webview, as we have a covering window</span>
            <span class="k">return</span>
        <span class="n">web_context</span> <span class="o">=</span> <span class="n">ResetRequired</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">set_bridge_command</span><span class="p">(</span><span class="k">lambda</span> <span class="n">url</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">delayedMaybeReset</span><span class="p">(),</span> <span class="n">web_context</span><span class="p">)</span>
        <span class="n">i</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Waiting for editing to finish.&quot;</span><span class="p">)</span>
        <span class="n">b</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">button</span><span class="p">(</span><span class="s2">&quot;refresh&quot;</span><span class="p">,</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Resume Now&quot;</span><span class="p">),</span> <span class="nb">id</span><span class="o">=</span><span class="s2">&quot;resume&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">stdHtml</span><span class="p">(</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">&lt;center&gt;&lt;div style=&quot;height: 100%%&quot;&gt;</span>
<span class="sd">&lt;div style=&quot;position:relative; vertical-align: middle;&quot;&gt;</span>
<span class="sd">%s&lt;br&gt;&lt;br&gt;</span>
<span class="sd">%s&lt;/div&gt;&lt;/div&gt;&lt;/center&gt;</span>
<span class="sd">&lt;script&gt;$(&#39;#resume&#39;).focus()&lt;/script&gt;</span>
<span class="sd">&quot;&quot;&quot;</span>
            <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">b</span><span class="p">),</span>
            <span class="n">context</span><span class="o">=</span><span class="n">web_context</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bottomWeb</span><span class="o">.</span><span class="n">hide</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">setFocus</span><span class="p">()</span>

    <span class="c1"># HTML helpers</span>
    <span class="c1">##########################################################################</span>

<div class="viewcode-block" id="AnkiQt.button"><a class="viewcode-back" href="../../aqt.html#aqt.main.AnkiQt.button">[docs]</a>    <span class="k">def</span> <span class="nf">button</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">link</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">class_</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="nb">id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="n">extra</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">class_</span> <span class="o">=</span> <span class="s2">&quot;but &quot;</span> <span class="o">+</span> <span class="n">class_</span>
        <span class="k">if</span> <span class="n">key</span><span class="p">:</span>
            <span class="n">key</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Shortcut key: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">)</span> <span class="o">%</span> <span class="n">key</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">key</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">return</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">&lt;button id=&quot;</span><span class="si">%s</span><span class="s2">&quot; class=&quot;</span><span class="si">%s</span><span class="s2">&quot; onclick=&quot;pycmd(&#39;</span><span class="si">%s</span><span class="s2">&#39;);return false;&quot;</span>
<span class="s2">title=&quot;</span><span class="si">%s</span><span class="s2">&quot; </span><span class="si">%s</span><span class="s2">&gt;</span><span class="si">%s</span><span class="s2">&lt;/button&gt;&quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="nb">id</span><span class="p">,</span>
            <span class="n">class_</span><span class="p">,</span>
            <span class="n">link</span><span class="p">,</span>
            <span class="n">key</span><span class="p">,</span>
            <span class="n">extra</span><span class="p">,</span>
            <span class="n">name</span><span class="p">,</span>
        <span class="p">)</span></div>

    <span class="c1"># Main window setup</span>
    <span class="c1">##########################################################################</span>

<div class="viewcode-block" id="AnkiQt.setupMainWindow"><a class="viewcode-back" href="../../aqt.html#aqt.main.AnkiQt.setupMainWindow">[docs]</a>    <span class="k">def</span> <span class="nf">setupMainWindow</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># main window</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">form</span> <span class="o">=</span> <span class="n">aqt</span><span class="o">.</span><span class="n">forms</span><span class="o">.</span><span class="n">main</span><span class="o">.</span><span class="n">Ui_MainWindow</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">setupUi</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="c1"># toolbar</span>
        <span class="n">tweb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">toolbarWeb</span> <span class="o">=</span> <span class="n">aqt</span><span class="o">.</span><span class="n">webview</span><span class="o">.</span><span class="n">AnkiWebView</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s2">&quot;top toolbar&quot;</span><span class="p">)</span>
        <span class="n">tweb</span><span class="o">.</span><span class="n">setFocusPolicy</span><span class="p">(</span><span class="n">Qt</span><span class="o">.</span><span class="n">WheelFocus</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">toolbar</span> <span class="o">=</span> <span class="n">aqt</span><span class="o">.</span><span class="n">toolbar</span><span class="o">.</span><span class="n">Toolbar</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tweb</span><span class="p">)</span>
        <span class="c1"># main area</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">web</span> <span class="o">=</span> <span class="n">aqt</span><span class="o">.</span><span class="n">webview</span><span class="o">.</span><span class="n">AnkiWebView</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s2">&quot;main webview&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">setFocusPolicy</span><span class="p">(</span><span class="n">Qt</span><span class="o">.</span><span class="n">WheelFocus</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">setMinimumWidth</span><span class="p">(</span><span class="mi">400</span><span class="p">)</span>
        <span class="c1"># bottom area</span>
        <span class="n">sweb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bottomWeb</span> <span class="o">=</span> <span class="n">aqt</span><span class="o">.</span><span class="n">webview</span><span class="o">.</span><span class="n">AnkiWebView</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s2">&quot;bottom toolbar&quot;</span><span class="p">)</span>
        <span class="n">sweb</span><span class="o">.</span><span class="n">setFocusPolicy</span><span class="p">(</span><span class="n">Qt</span><span class="o">.</span><span class="n">WheelFocus</span><span class="p">)</span>
        <span class="c1"># add in a layout</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mainLayout</span> <span class="o">=</span> <span class="n">QVBoxLayout</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mainLayout</span><span class="o">.</span><span class="n">setContentsMargins</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mainLayout</span><span class="o">.</span><span class="n">setSpacing</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mainLayout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">tweb</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mainLayout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">web</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mainLayout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">sweb</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">centralwidget</span><span class="o">.</span><span class="n">setLayout</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mainLayout</span><span class="p">)</span>

        <span class="c1"># force webengine processes to load before cwd is changed</span>
        <span class="k">if</span> <span class="n">isWin</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">web</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bottomWeb</span><span class="p">:</span>
                <span class="n">o</span><span class="o">.</span><span class="n">requiresCol</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">o</span><span class="o">.</span><span class="n">_domReady</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">o</span><span class="o">.</span><span class="n">_page</span><span class="o">.</span><span class="n">setContent</span><span class="p">(</span><span class="nb">bytes</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;ascii&quot;</span><span class="p">))</span></div>

<div class="viewcode-block" id="AnkiQt.closeAllWindows"><a class="viewcode-back" href="../../aqt.html#aqt.main.AnkiQt.closeAllWindows">[docs]</a>    <span class="k">def</span> <span class="nf">closeAllWindows</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">onsuccess</span><span class="p">:</span> <span class="n">Callable</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">aqt</span><span class="o">.</span><span class="n">dialogs</span><span class="o">.</span><span class="n">closeAll</span><span class="p">(</span><span class="n">onsuccess</span><span class="p">)</span></div>

    <span class="c1"># Components</span>
    <span class="c1">##########################################################################</span>

<div class="viewcode-block" id="AnkiQt.setupSignals"><a class="viewcode-back" href="../../aqt.html#aqt.main.AnkiQt.setupSignals">[docs]</a>    <span class="k">def</span> <span class="nf">setupSignals</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGINT</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">onUnixSignal</span><span class="p">)</span>
        <span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGTERM</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">onUnixSignal</span><span class="p">)</span></div>

<div class="viewcode-block" id="AnkiQt.onUnixSignal"><a class="viewcode-back" href="../../aqt.html#aqt.main.AnkiQt.onUnixSignal">[docs]</a>    <span class="k">def</span> <span class="nf">onUnixSignal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">signum</span><span class="p">,</span> <span class="n">frame</span><span class="p">):</span>
        <span class="c1"># schedule a rollback &amp; quit</span>
        <span class="k">def</span> <span class="nf">quit</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">progress</span><span class="o">.</span><span class="n">timer</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="n">quit</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span></div>

<div class="viewcode-block" id="AnkiQt.setupProgress"><a class="viewcode-back" href="../../aqt.html#aqt.main.AnkiQt.setupProgress">[docs]</a>    <span class="k">def</span> <span class="nf">setupProgress</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">progress</span> <span class="o">=</span> <span class="n">aqt</span><span class="o">.</span><span class="n">progress</span><span class="o">.</span><span class="n">ProgressManager</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></div>

<div class="viewcode-block" id="AnkiQt.setupErrorHandler"><a class="viewcode-back" href="../../aqt.html#aqt.main.AnkiQt.setupErrorHandler">[docs]</a>    <span class="k">def</span> <span class="nf">setupErrorHandler</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">aqt.errors</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">errorHandler</span> <span class="o">=</span> <span class="n">aqt</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">ErrorHandler</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></div>

<div class="viewcode-block" id="AnkiQt.setupAddons"><a class="viewcode-back" href="../../aqt.html#aqt.main.AnkiQt.setupAddons">[docs]</a>    <span class="k">def</span> <span class="nf">setupAddons</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">aqt.addons</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">addonManager</span> <span class="o">=</span> <span class="n">aqt</span><span class="o">.</span><span class="n">addons</span><span class="o">.</span><span class="n">AddonManager</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">args</span> <span class="ow">and</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_isAddon</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">installAddon</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">startup</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">safeMode</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">addonManager</span><span class="o">.</span><span class="n">loadAddons</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">maybe_check_for_addon_updates</span><span class="p">()</span></div>

<div class="viewcode-block" id="AnkiQt.maybe_check_for_addon_updates"><a class="viewcode-back" href="../../aqt.html#aqt.main.AnkiQt.maybe_check_for_addon_updates">[docs]</a>    <span class="k">def</span> <span class="nf">maybe_check_for_addon_updates</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">last_check</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pm</span><span class="o">.</span><span class="n">last_addon_update_check</span><span class="p">()</span>
        <span class="n">elap</span> <span class="o">=</span> <span class="n">intTime</span><span class="p">()</span> <span class="o">-</span> <span class="n">last_check</span>

        <span class="k">if</span> <span class="n">elap</span> <span class="o">&gt;</span> <span class="mi">86_400</span><span class="p">:</span>
            <span class="n">check_and_prompt_for_updates</span><span class="p">(</span>
                <span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">addonManager</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">on_updates_installed</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pm</span><span class="o">.</span><span class="n">set_last_addon_update_check</span><span class="p">(</span><span class="n">intTime</span><span class="p">())</span></div>

<div class="viewcode-block" id="AnkiQt.on_updates_installed"><a class="viewcode-back" href="../../aqt.html#aqt.main.AnkiQt.on_updates_installed">[docs]</a>    <span class="k">def</span> <span class="nf">on_updates_installed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">log</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">DownloadLogEntry</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">log</span><span class="p">:</span>
            <span class="n">show_log_to_user</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">log</span><span class="p">)</span></div>

<div class="viewcode-block" id="AnkiQt.setupSpellCheck"><a class="viewcode-back" href="../../aqt.html#aqt.main.AnkiQt.setupSpellCheck">[docs]</a>    <span class="k">def</span> <span class="nf">setupSpellCheck</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;QTWEBENGINE_DICTIONARIES_PATH&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pm</span><span class="o">.</span><span class="n">base</span><span class="p">,</span> <span class="s2">&quot;dictionaries&quot;</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="AnkiQt.setupThreads"><a class="viewcode-back" href="../../aqt.html#aqt.main.AnkiQt.setupThreads">[docs]</a>    <span class="k">def</span> <span class="nf">setupThreads</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_mainThread</span> <span class="o">=</span> <span class="n">QThread</span><span class="o">.</span><span class="n">currentThread</span><span class="p">()</span></div>

<div class="viewcode-block" id="AnkiQt.inMainThread"><a class="viewcode-back" href="../../aqt.html#aqt.main.AnkiQt.inMainThread">[docs]</a>    <span class="k">def</span> <span class="nf">inMainThread</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mainThread</span> <span class="o">==</span> <span class="n">QThread</span><span class="o">.</span><span class="n">currentThread</span><span class="p">()</span></div>

<div class="viewcode-block" id="AnkiQt.setupDeckBrowser"><a class="viewcode-back" href="../../aqt.html#aqt.main.AnkiQt.setupDeckBrowser">[docs]</a>    <span class="k">def</span> <span class="nf">setupDeckBrowser</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">aqt.deckbrowser</span> <span class="kn">import</span> <span class="n">DeckBrowser</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">deckBrowser</span> <span class="o">=</span> <span class="n">DeckBrowser</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></div>

<div class="viewcode-block" id="AnkiQt.setupOverview"><a class="viewcode-back" href="../../aqt.html#aqt.main.AnkiQt.setupOverview">[docs]</a>    <span class="k">def</span> <span class="nf">setupOverview</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">aqt.overview</span> <span class="kn">import</span> <span class="n">Overview</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">overview</span> <span class="o">=</span> <span class="n">Overview</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></div>

<div class="viewcode-block" id="AnkiQt.setupReviewer"><a class="viewcode-back" href="../../aqt.html#aqt.main.AnkiQt.setupReviewer">[docs]</a>    <span class="k">def</span> <span class="nf">setupReviewer</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">aqt.reviewer</span> <span class="kn">import</span> <span class="n">Reviewer</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">reviewer</span> <span class="o">=</span> <span class="n">Reviewer</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></div>

    <span class="c1"># Syncing</span>
    <span class="c1">##########################################################################</span>

<div class="viewcode-block" id="AnkiQt.on_sync_button_clicked"><a class="viewcode-back" href="../../aqt.html#aqt.main.AnkiQt.on_sync_button_clicked">[docs]</a>    <span class="k">def</span> <span class="nf">on_sync_button_clicked</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">media_syncer</span><span class="o">.</span><span class="n">is_syncing</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">media_syncer</span><span class="o">.</span><span class="n">show_sync_log</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">auth</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pm</span><span class="o">.</span><span class="n">sync_auth</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">auth</span><span class="p">:</span>
                <span class="n">sync_login</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sync_collection_and_media</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="kc">None</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_sync_collection_and_media</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="kc">None</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_sync_collection_and_media</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">after_sync</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[],</span> <span class="kc">None</span><span class="p">]):</span>
        <span class="s2">&quot;Caller should ensure auth available.&quot;</span>
        <span class="c1"># start media sync if not already running</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">media_syncer</span><span class="o">.</span><span class="n">is_syncing</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">media_syncer</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

        <span class="k">def</span> <span class="nf">on_collection_sync_finished</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
            <span class="n">after_sync</span><span class="p">()</span>

        <span class="n">sync_collection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">on_done</span><span class="o">=</span><span class="n">on_collection_sync_finished</span><span class="p">)</span>

<div class="viewcode-block" id="AnkiQt.maybe_auto_sync_on_open_close"><a class="viewcode-back" href="../../aqt.html#aqt.main.AnkiQt.maybe_auto_sync_on_open_close">[docs]</a>    <span class="k">def</span> <span class="nf">maybe_auto_sync_on_open_close</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">after_sync</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[],</span> <span class="kc">None</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="s2">&quot;If disabled, after_sync() is called immediately.&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">can_auto_sync</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_sync_collection_and_media</span><span class="p">(</span><span class="n">after_sync</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">after_sync</span><span class="p">()</span></div>

<div class="viewcode-block" id="AnkiQt.maybe_auto_sync_media"><a class="viewcode-back" href="../../aqt.html#aqt.main.AnkiQt.maybe_auto_sync_media">[docs]</a>    <span class="k">def</span> <span class="nf">maybe_auto_sync_media</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">can_auto_sync</span><span class="p">():</span>
            <span class="k">return</span>
        <span class="c1"># media_syncer takes care of media syncing preference check</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">media_syncer</span><span class="o">.</span><span class="n">start</span><span class="p">()</span></div>

<div class="viewcode-block" id="AnkiQt.can_auto_sync"><a class="viewcode-back" href="../../aqt.html#aqt.main.AnkiQt.can_auto_sync">[docs]</a>    <span class="k">def</span> <span class="nf">can_auto_sync</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pm</span><span class="o">.</span><span class="n">auto_syncing_enabled</span><span class="p">()</span>
            <span class="ow">and</span> <span class="nb">bool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pm</span><span class="o">.</span><span class="n">sync_auth</span><span class="p">())</span>
            <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">safeMode</span>
            <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">restoringBackup</span>
        <span class="p">)</span></div>

    <span class="c1"># legacy</span>
    <span class="k">def</span> <span class="nf">_sync</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="n">onSync</span> <span class="o">=</span> <span class="n">on_sync_button_clicked</span>

    <span class="c1"># Tools</span>
    <span class="c1">##########################################################################</span>

<div class="viewcode-block" id="AnkiQt.raiseMain"><a class="viewcode-back" href="../../aqt.html#aqt.main.AnkiQt.raiseMain">[docs]</a>    <span class="k">def</span> <span class="nf">raiseMain</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">activeWindow</span><span class="p">():</span>
            <span class="c1"># make sure window is shown</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">setWindowState</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">windowState</span><span class="p">()</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">Qt</span><span class="o">.</span><span class="n">WindowMinimized</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="AnkiQt.setupStyle"><a class="viewcode-back" href="../../aqt.html#aqt.main.AnkiQt.setupStyle">[docs]</a>    <span class="k">def</span> <span class="nf">setupStyle</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">theme_manager</span><span class="o">.</span><span class="n">night_mode</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pm</span><span class="o">.</span><span class="n">night_mode</span><span class="p">()</span>
        <span class="n">theme_manager</span><span class="o">.</span><span class="n">apply_style</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="p">)</span></div>

    <span class="c1"># Key handling</span>
    <span class="c1">##########################################################################</span>

<div class="viewcode-block" id="AnkiQt.setupKeys"><a class="viewcode-back" href="../../aqt.html#aqt.main.AnkiQt.setupKeys">[docs]</a>    <span class="k">def</span> <span class="nf">setupKeys</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">globalShortcuts</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span><span class="s2">&quot;Ctrl+:&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">onDebug</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;d&quot;</span><span class="p">,</span> <span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">moveToState</span><span class="p">(</span><span class="s2">&quot;deckBrowser&quot;</span><span class="p">)),</span>
            <span class="p">(</span><span class="s2">&quot;s&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">onStudyKey</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">onAddCard</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">onBrowse</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;t&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">onStats</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">on_sync_button_clicked</span><span class="p">),</span>
        <span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">applyShortcuts</span><span class="p">(</span><span class="n">globalShortcuts</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">stateShortcuts</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Callable</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span></div>

<div class="viewcode-block" id="AnkiQt.applyShortcuts"><a class="viewcode-back" href="../../aqt.html#aqt.main.AnkiQt.applyShortcuts">[docs]</a>    <span class="k">def</span> <span class="nf">applyShortcuts</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">shortcuts</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Callable</span><span class="p">]]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">QShortcut</span><span class="p">]:</span>
        <span class="n">qshortcuts</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">fn</span> <span class="ow">in</span> <span class="n">shortcuts</span><span class="p">:</span>
            <span class="n">scut</span> <span class="o">=</span> <span class="n">QShortcut</span><span class="p">(</span><span class="n">QKeySequence</span><span class="p">(</span><span class="n">key</span><span class="p">),</span> <span class="bp">self</span><span class="p">,</span> <span class="n">activated</span><span class="o">=</span><span class="n">fn</span><span class="p">)</span>  <span class="c1"># type: ignore</span>
            <span class="n">scut</span><span class="o">.</span><span class="n">setAutoRepeat</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">qshortcuts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">scut</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">qshortcuts</span></div>

<div class="viewcode-block" id="AnkiQt.setStateShortcuts"><a class="viewcode-back" href="../../aqt.html#aqt.main.AnkiQt.setStateShortcuts">[docs]</a>    <span class="k">def</span> <span class="nf">setStateShortcuts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">shortcuts</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Callable</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">gui_hooks</span><span class="o">.</span><span class="n">state_shortcuts_will_change</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">,</span> <span class="n">shortcuts</span><span class="p">)</span>
        <span class="c1"># legacy hook</span>
        <span class="n">runHook</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">+</span> <span class="s2">&quot;StateShortcuts&quot;</span><span class="p">,</span> <span class="n">shortcuts</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stateShortcuts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">applyShortcuts</span><span class="p">(</span><span class="n">shortcuts</span><span class="p">)</span></div>

<div class="viewcode-block" id="AnkiQt.clearStateShortcuts"><a class="viewcode-back" href="../../aqt.html#aqt.main.AnkiQt.clearStateShortcuts">[docs]</a>    <span class="k">def</span> <span class="nf">clearStateShortcuts</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">qs</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">stateShortcuts</span><span class="p">:</span>
            <span class="n">sip</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">qs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stateShortcuts</span> <span class="o">=</span> <span class="p">[]</span></div>

<div class="viewcode-block" id="AnkiQt.onStudyKey"><a class="viewcode-back" href="../../aqt.html#aqt.main.AnkiQt.onStudyKey">[docs]</a>    <span class="k">def</span> <span class="nf">onStudyKey</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="s2">&quot;overview&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="o">.</span><span class="n">startTimebox</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">moveToState</span><span class="p">(</span><span class="s2">&quot;review&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">moveToState</span><span class="p">(</span><span class="s2">&quot;overview&quot;</span><span class="p">)</span></div>

    <span class="c1"># App exit</span>
    <span class="c1">##########################################################################</span>

<div class="viewcode-block" id="AnkiQt.closeEvent"><a class="viewcode-back" href="../../aqt.html#aqt.main.AnkiQt.closeEvent">[docs]</a>    <span class="k">def</span> <span class="nf">closeEvent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">:</span> <span class="n">QCloseEvent</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="s2">&quot;profileManager&quot;</span><span class="p">:</span>
            <span class="c1"># if profile manager active, this event may fire via OS X menu bar&#39;s</span>
            <span class="c1"># quit option</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">profileDiag</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="n">event</span><span class="o">.</span><span class="n">accept</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># ignore the event for now, as we need time to clean up</span>
            <span class="n">event</span><span class="o">.</span><span class="n">ignore</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">unloadProfileAndExit</span><span class="p">()</span></div>

    <span class="c1"># Undo &amp; autosave</span>
    <span class="c1">##########################################################################</span>

<div class="viewcode-block" id="AnkiQt.onUndo"><a class="viewcode-back" href="../../aqt.html#aqt.main.AnkiQt.onUndo">[docs]</a>    <span class="k">def</span> <span class="nf">onUndo</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">n</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="o">.</span><span class="n">undoName</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">n</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">cid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="o">.</span><span class="n">undo</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">cid</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="s2">&quot;review&quot;</span><span class="p">:</span>
            <span class="n">card</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="o">.</span><span class="n">getCard</span><span class="p">(</span><span class="n">cid</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="o">.</span><span class="n">sched</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reviewer</span><span class="o">.</span><span class="n">cardQueue</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">card</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reviewer</span><span class="o">.</span><span class="n">nextCard</span><span class="p">()</span>
            <span class="n">gui_hooks</span><span class="o">.</span><span class="n">review_did_undo</span><span class="p">(</span><span class="n">cid</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
            <span class="n">tooltip</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;Reverted to state prior to &#39;</span><span class="si">%s</span><span class="s2">&#39;.&quot;</span><span class="p">)</span> <span class="o">%</span> <span class="n">n</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
            <span class="n">gui_hooks</span><span class="o">.</span><span class="n">state_did_revert</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">maybeEnableUndo</span><span class="p">()</span></div>

<div class="viewcode-block" id="AnkiQt.maybeEnableUndo"><a class="viewcode-back" href="../../aqt.html#aqt.main.AnkiQt.maybeEnableUndo">[docs]</a>    <span class="k">def</span> <span class="nf">maybeEnableUndo</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">col</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="o">.</span><span class="n">undoName</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">actionUndo</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;Undo </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">)</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="o">.</span><span class="n">undoName</span><span class="p">())</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">actionUndo</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">gui_hooks</span><span class="o">.</span><span class="n">undo_state_did_change</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">actionUndo</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;Undo&quot;</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">actionUndo</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">gui_hooks</span><span class="o">.</span><span class="n">undo_state_did_change</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span></div>

<div class="viewcode-block" id="AnkiQt.checkpoint"><a class="viewcode-back" href="../../aqt.html#aqt.main.AnkiQt.checkpoint">[docs]</a>    <span class="k">def</span> <span class="nf">checkpoint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">maybeEnableUndo</span><span class="p">()</span></div>

<div class="viewcode-block" id="AnkiQt.autosave"><a class="viewcode-back" href="../../aqt.html#aqt.main.AnkiQt.autosave">[docs]</a>    <span class="k">def</span> <span class="nf">autosave</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">saved</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="o">.</span><span class="n">autosave</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">maybeEnableUndo</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">saved</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">doGC</span><span class="p">()</span></div>

    <span class="c1"># Other menu operations</span>
    <span class="c1">##########################################################################</span>

<div class="viewcode-block" id="AnkiQt.onAddCard"><a class="viewcode-back" href="../../aqt.html#aqt.main.AnkiQt.onAddCard">[docs]</a>    <span class="k">def</span> <span class="nf">onAddCard</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">aqt</span><span class="o">.</span><span class="n">dialogs</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">&quot;AddCards&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span></div>

<div class="viewcode-block" id="AnkiQt.onBrowse"><a class="viewcode-back" href="../../aqt.html#aqt.main.AnkiQt.onBrowse">[docs]</a>    <span class="k">def</span> <span class="nf">onBrowse</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">aqt</span><span class="o">.</span><span class="n">dialogs</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">&quot;Browser&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span></div>

<div class="viewcode-block" id="AnkiQt.onEditCurrent"><a class="viewcode-back" href="../../aqt.html#aqt.main.AnkiQt.onEditCurrent">[docs]</a>    <span class="k">def</span> <span class="nf">onEditCurrent</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">aqt</span><span class="o">.</span><span class="n">dialogs</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">&quot;EditCurrent&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span></div>

<div class="viewcode-block" id="AnkiQt.onDeckConf"><a class="viewcode-back" href="../../aqt.html#aqt.main.AnkiQt.onDeckConf">[docs]</a>    <span class="k">def</span> <span class="nf">onDeckConf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">deck</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">deck</span><span class="p">:</span>
            <span class="n">deck</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="o">.</span><span class="n">decks</span><span class="o">.</span><span class="n">current</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">deck</span><span class="p">[</span><span class="s2">&quot;dyn&quot;</span><span class="p">]:</span>
            <span class="kn">import</span> <span class="nn">aqt.dyndeckconf</span>

            <span class="n">aqt</span><span class="o">.</span><span class="n">dyndeckconf</span><span class="o">.</span><span class="n">DeckConf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">deck</span><span class="o">=</span><span class="n">deck</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">aqt.deckconf</span>

            <span class="n">aqt</span><span class="o">.</span><span class="n">deckconf</span><span class="o">.</span><span class="n">DeckConf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">deck</span><span class="p">)</span></div>

<div class="viewcode-block" id="AnkiQt.onOverview"><a class="viewcode-back" href="../../aqt.html#aqt.main.AnkiQt.onOverview">[docs]</a>    <span class="k">def</span> <span class="nf">onOverview</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">moveToState</span><span class="p">(</span><span class="s2">&quot;overview&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="AnkiQt.onStats"><a class="viewcode-back" href="../../aqt.html#aqt.main.AnkiQt.onStats">[docs]</a>    <span class="k">def</span> <span class="nf">onStats</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">deck</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_selectedDeck</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">deck</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">want_old</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">queryKeyboardModifiers</span><span class="p">()</span> <span class="o">&amp;</span> <span class="n">Qt</span><span class="o">.</span><span class="n">ShiftModifier</span>
        <span class="k">if</span> <span class="n">want_old</span><span class="p">:</span>
            <span class="n">aqt</span><span class="o">.</span><span class="n">dialogs</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">&quot;DeckStats&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">aqt</span><span class="o">.</span><span class="n">dialogs</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">&quot;NewDeckStats&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span></div>

<div class="viewcode-block" id="AnkiQt.onPrefs"><a class="viewcode-back" href="../../aqt.html#aqt.main.AnkiQt.onPrefs">[docs]</a>    <span class="k">def</span> <span class="nf">onPrefs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">aqt</span><span class="o">.</span><span class="n">dialogs</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">&quot;Preferences&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span></div>

<div class="viewcode-block" id="AnkiQt.onNoteTypes"><a class="viewcode-back" href="../../aqt.html#aqt.main.AnkiQt.onNoteTypes">[docs]</a>    <span class="k">def</span> <span class="nf">onNoteTypes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">aqt.models</span>

        <span class="n">aqt</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">Models</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">fromMain</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>

<div class="viewcode-block" id="AnkiQt.onAbout"><a class="viewcode-back" href="../../aqt.html#aqt.main.AnkiQt.onAbout">[docs]</a>    <span class="k">def</span> <span class="nf">onAbout</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">aqt</span><span class="o">.</span><span class="n">dialogs</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">&quot;About&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span></div>

<div class="viewcode-block" id="AnkiQt.onDonate"><a class="viewcode-back" href="../../aqt.html#aqt.main.AnkiQt.onDonate">[docs]</a>    <span class="k">def</span> <span class="nf">onDonate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">openLink</span><span class="p">(</span><span class="n">aqt</span><span class="o">.</span><span class="n">appDonate</span><span class="p">)</span></div>

<div class="viewcode-block" id="AnkiQt.onDocumentation"><a class="viewcode-back" href="../../aqt.html#aqt.main.AnkiQt.onDocumentation">[docs]</a>    <span class="k">def</span> <span class="nf">onDocumentation</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">openHelp</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span></div>

    <span class="c1"># Importing &amp; exporting</span>
    <span class="c1">##########################################################################</span>

<div class="viewcode-block" id="AnkiQt.handleImport"><a class="viewcode-back" href="../../aqt.html#aqt.main.AnkiQt.handleImport">[docs]</a>    <span class="k">def</span> <span class="nf">handleImport</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">aqt.importing</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
            <span class="n">showInfo</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;Please use File&gt;Import to import this file.&quot;</span><span class="p">))</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">aqt</span><span class="o">.</span><span class="n">importing</span><span class="o">.</span><span class="n">importFile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="AnkiQt.onImport"><a class="viewcode-back" href="../../aqt.html#aqt.main.AnkiQt.onImport">[docs]</a>    <span class="k">def</span> <span class="nf">onImport</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">aqt.importing</span>

        <span class="n">aqt</span><span class="o">.</span><span class="n">importing</span><span class="o">.</span><span class="n">onImport</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></div>

<div class="viewcode-block" id="AnkiQt.onExport"><a class="viewcode-back" href="../../aqt.html#aqt.main.AnkiQt.onExport">[docs]</a>    <span class="k">def</span> <span class="nf">onExport</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">did</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">aqt.exporting</span>

        <span class="n">aqt</span><span class="o">.</span><span class="n">exporting</span><span class="o">.</span><span class="n">ExportDialog</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">did</span><span class="o">=</span><span class="n">did</span><span class="p">)</span></div>

    <span class="c1"># Installing add-ons from CLI / mimetype handler</span>
    <span class="c1">##########################################################################</span>

<div class="viewcode-block" id="AnkiQt.installAddon"><a class="viewcode-back" href="../../aqt.html#aqt.main.AnkiQt.installAddon">[docs]</a>    <span class="k">def</span> <span class="nf">installAddon</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">startup</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">aqt.addons</span> <span class="kn">import</span> <span class="n">installAddonPackages</span>

        <span class="n">installAddonPackages</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">addonManager</span><span class="p">,</span>
            <span class="p">[</span><span class="n">path</span><span class="p">],</span>
            <span class="n">warn</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">advise_restart</span><span class="o">=</span><span class="ow">not</span> <span class="n">startup</span><span class="p">,</span>
            <span class="n">strictly_modal</span><span class="o">=</span><span class="n">startup</span><span class="p">,</span>
            <span class="n">parent</span><span class="o">=</span><span class="kc">None</span> <span class="k">if</span> <span class="n">startup</span> <span class="k">else</span> <span class="bp">self</span><span class="p">,</span>
        <span class="p">)</span></div>

    <span class="c1"># Cramming</span>
    <span class="c1">##########################################################################</span>

<div class="viewcode-block" id="AnkiQt.onCram"><a class="viewcode-back" href="../../aqt.html#aqt.main.AnkiQt.onCram">[docs]</a>    <span class="k">def</span> <span class="nf">onCram</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">search</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">aqt.dyndeckconf</span>

        <span class="n">n</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">deck</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="o">.</span><span class="n">decks</span><span class="o">.</span><span class="n">current</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">search</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">deck</span><span class="p">[</span><span class="s2">&quot;dyn&quot;</span><span class="p">]:</span>
                <span class="n">search</span> <span class="o">=</span> <span class="s1">&#39;deck:&quot;</span><span class="si">%s</span><span class="s1">&quot; &#39;</span> <span class="o">%</span> <span class="n">deck</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="o">.</span><span class="n">decks</span><span class="o">.</span><span class="n">id_for_name</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;Filtered Deck </span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">)</span> <span class="o">%</span> <span class="n">n</span><span class="p">):</span>
            <span class="n">n</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Filtered Deck </span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">)</span> <span class="o">%</span> <span class="n">n</span>
        <span class="n">did</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="o">.</span><span class="n">decks</span><span class="o">.</span><span class="n">newDyn</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="n">diag</span> <span class="o">=</span> <span class="n">aqt</span><span class="o">.</span><span class="n">dyndeckconf</span><span class="o">.</span><span class="n">DeckConf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">first</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">search</span><span class="o">=</span><span class="n">search</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">diag</span><span class="o">.</span><span class="n">ok</span><span class="p">:</span>
            <span class="c1"># user cancelled first config</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="o">.</span><span class="n">decks</span><span class="o">.</span><span class="n">rem</span><span class="p">(</span><span class="n">did</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="o">.</span><span class="n">decks</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">deck</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">])</span></div>

    <span class="c1"># Menu, title bar &amp; status</span>
    <span class="c1">##########################################################################</span>

<div class="viewcode-block" id="AnkiQt.setupMenus"><a class="viewcode-back" href="../../aqt.html#aqt.main.AnkiQt.setupMenus">[docs]</a>    <span class="k">def</span> <span class="nf">setupMenus</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">m</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">form</span>
        <span class="n">qconnect</span><span class="p">(</span>
            <span class="n">m</span><span class="o">.</span><span class="n">actionSwitchProfile</span><span class="o">.</span><span class="n">triggered</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">unloadProfileAndShowProfileManager</span>
        <span class="p">)</span>
        <span class="n">qconnect</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">actionImport</span><span class="o">.</span><span class="n">triggered</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">onImport</span><span class="p">)</span>
        <span class="n">qconnect</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">actionExport</span><span class="o">.</span><span class="n">triggered</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">onExport</span><span class="p">)</span>
        <span class="n">qconnect</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">actionExit</span><span class="o">.</span><span class="n">triggered</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">)</span>
        <span class="n">qconnect</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">actionPreferences</span><span class="o">.</span><span class="n">triggered</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">onPrefs</span><span class="p">)</span>
        <span class="n">qconnect</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">actionAbout</span><span class="o">.</span><span class="n">triggered</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">onAbout</span><span class="p">)</span>
        <span class="n">qconnect</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">actionUndo</span><span class="o">.</span><span class="n">triggered</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">onUndo</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">qtminor</span> <span class="o">&lt;</span> <span class="mi">11</span><span class="p">:</span>
            <span class="n">m</span><span class="o">.</span><span class="n">actionUndo</span><span class="o">.</span><span class="n">setShortcut</span><span class="p">(</span><span class="n">QKeySequence</span><span class="p">(</span><span class="s2">&quot;Ctrl+Alt+Z&quot;</span><span class="p">))</span>
        <span class="n">qconnect</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">actionFullDatabaseCheck</span><span class="o">.</span><span class="n">triggered</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">onCheckDB</span><span class="p">)</span>
        <span class="n">qconnect</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">actionCheckMediaDatabase</span><span class="o">.</span><span class="n">triggered</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">on_check_media_db</span><span class="p">)</span>
        <span class="n">qconnect</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">actionDocumentation</span><span class="o">.</span><span class="n">triggered</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">onDocumentation</span><span class="p">)</span>
        <span class="n">qconnect</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">actionDonate</span><span class="o">.</span><span class="n">triggered</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">onDonate</span><span class="p">)</span>
        <span class="n">qconnect</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">actionStudyDeck</span><span class="o">.</span><span class="n">triggered</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">onStudyDeck</span><span class="p">)</span>
        <span class="n">qconnect</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">actionCreateFiltered</span><span class="o">.</span><span class="n">triggered</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">onCram</span><span class="p">)</span>
        <span class="n">qconnect</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">actionEmptyCards</span><span class="o">.</span><span class="n">triggered</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">onEmptyCards</span><span class="p">)</span>
        <span class="n">qconnect</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">actionNoteTypes</span><span class="o">.</span><span class="n">triggered</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">onNoteTypes</span><span class="p">)</span></div>

<div class="viewcode-block" id="AnkiQt.updateTitleBar"><a class="viewcode-back" href="../../aqt.html#aqt.main.AnkiQt.updateTitleBar">[docs]</a>    <span class="k">def</span> <span class="nf">updateTitleBar</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setWindowTitle</span><span class="p">(</span><span class="s2">&quot;Anki&quot;</span><span class="p">)</span></div>

    <span class="c1"># Auto update</span>
    <span class="c1">##########################################################################</span>

<div class="viewcode-block" id="AnkiQt.setupAutoUpdate"><a class="viewcode-back" href="../../aqt.html#aqt.main.AnkiQt.setupAutoUpdate">[docs]</a>    <span class="k">def</span> <span class="nf">setupAutoUpdate</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">aqt.update</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">autoUpdate</span> <span class="o">=</span> <span class="n">aqt</span><span class="o">.</span><span class="n">update</span><span class="o">.</span><span class="n">LatestVersionFinder</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">qconnect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">autoUpdate</span><span class="o">.</span><span class="n">newVerAvail</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">newVerAvail</span><span class="p">)</span>
        <span class="n">qconnect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">autoUpdate</span><span class="o">.</span><span class="n">newMsg</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">newMsg</span><span class="p">)</span>
        <span class="n">qconnect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">autoUpdate</span><span class="o">.</span><span class="n">clockIsOff</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">clockIsOff</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">autoUpdate</span><span class="o">.</span><span class="n">start</span><span class="p">()</span></div>

<div class="viewcode-block" id="AnkiQt.newVerAvail"><a class="viewcode-back" href="../../aqt.html#aqt.main.AnkiQt.newVerAvail">[docs]</a>    <span class="k">def</span> <span class="nf">newVerAvail</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ver</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pm</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;suppressUpdate&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="o">!=</span> <span class="n">ver</span><span class="p">:</span>
            <span class="n">aqt</span><span class="o">.</span><span class="n">update</span><span class="o">.</span><span class="n">askAndUpdate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ver</span><span class="p">)</span></div>

<div class="viewcode-block" id="AnkiQt.newMsg"><a class="viewcode-back" href="../../aqt.html#aqt.main.AnkiQt.newMsg">[docs]</a>    <span class="k">def</span> <span class="nf">newMsg</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="n">aqt</span><span class="o">.</span><span class="n">update</span><span class="o">.</span><span class="n">showMessages</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span></div>

<div class="viewcode-block" id="AnkiQt.clockIsOff"><a class="viewcode-back" href="../../aqt.html#aqt.main.AnkiQt.clockIsOff">[docs]</a>    <span class="k">def</span> <span class="nf">clockIsOff</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">diff</span><span class="p">):</span>
        <span class="n">diffText</span> <span class="o">=</span> <span class="n">ngettext</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> second&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> seconds&quot;</span><span class="p">,</span> <span class="n">diff</span><span class="p">)</span> <span class="o">%</span> <span class="n">diff</span>
        <span class="n">warn</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">_</span><span class="p">(</span>
                <span class="sd">&quot;&quot;&quot;\</span>
<span class="sd">In order to ensure your collection works correctly when moved between \</span>
<span class="sd">devices, Anki requires your computer&#39;s internal clock to be set correctly. \</span>
<span class="sd">The internal clock can be wrong even if your system is showing the correct \</span>
<span class="sd">local time.</span>

<span class="sd">Please go to the time settings on your computer and check the following:</span>

<span class="sd">- AM/PM</span>
<span class="sd">- Clock drift</span>
<span class="sd">- Day, month and year</span>
<span class="sd">- Timezone</span>
<span class="sd">- Daylight savings</span>

<span class="sd">Difference to correct time: %s.&quot;&quot;&quot;</span>
            <span class="p">)</span>
            <span class="o">%</span> <span class="n">diffText</span>
        <span class="p">)</span>
        <span class="n">showWarning</span><span class="p">(</span><span class="n">warn</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">closeAllWindows</span><span class="p">()</span></div>

    <span class="c1"># Timers</span>
    <span class="c1">##########################################################################</span>

<div class="viewcode-block" id="AnkiQt.setup_timers"><a class="viewcode-back" href="../../aqt.html#aqt.main.AnkiQt.setup_timers">[docs]</a>    <span class="k">def</span> <span class="nf">setup_timers</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># refresh decks every 10 minutes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">progress</span><span class="o">.</span><span class="n">timer</span><span class="p">(</span><span class="mi">10</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">onRefreshTimer</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="c1"># check media sync every 5 minutes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">progress</span><span class="o">.</span><span class="n">timer</span><span class="p">(</span><span class="mi">5</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">on_autosync_timer</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="c1"># ensure Python interpreter runs at least once per second, so that</span>
        <span class="c1"># SIGINT/SIGTERM is processed without a long delay</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">progress</span><span class="o">.</span><span class="n">timer</span><span class="p">(</span><span class="mi">1000</span><span class="p">,</span> <span class="k">lambda</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span></div>

<div class="viewcode-block" id="AnkiQt.onRefreshTimer"><a class="viewcode-back" href="../../aqt.html#aqt.main.AnkiQt.onRefreshTimer">[docs]</a>    <span class="k">def</span> <span class="nf">onRefreshTimer</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="s2">&quot;deckBrowser&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">deckBrowser</span><span class="o">.</span><span class="n">refresh</span><span class="p">()</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="s2">&quot;overview&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">overview</span><span class="o">.</span><span class="n">refresh</span><span class="p">()</span></div>

<div class="viewcode-block" id="AnkiQt.on_autosync_timer"><a class="viewcode-back" href="../../aqt.html#aqt.main.AnkiQt.on_autosync_timer">[docs]</a>    <span class="k">def</span> <span class="nf">on_autosync_timer</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">elap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">media_syncer</span><span class="o">.</span><span class="n">seconds_since_last_sync</span><span class="p">()</span>
        <span class="n">minutes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pm</span><span class="o">.</span><span class="n">auto_sync_media_minutes</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">minutes</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">elap</span> <span class="o">&gt;</span> <span class="n">minutes</span> <span class="o">*</span> <span class="mi">60</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">maybe_auto_sync_media</span><span class="p">()</span></div>

    <span class="c1"># Permanent libanki hooks</span>
    <span class="c1">##########################################################################</span>

<div class="viewcode-block" id="AnkiQt.setupHooks"><a class="viewcode-back" href="../../aqt.html#aqt.main.AnkiQt.setupHooks">[docs]</a>    <span class="k">def</span> <span class="nf">setupHooks</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">hooks</span><span class="o">.</span><span class="n">schema_will_change</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">onSchemaMod</span><span class="p">)</span>
        <span class="n">hooks</span><span class="o">.</span><span class="n">notes_will_be_deleted</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">onRemNotes</span><span class="p">)</span>
        <span class="n">hooks</span><span class="o">.</span><span class="n">card_odue_was_invalid</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">onOdueInvalid</span><span class="p">)</span>

        <span class="n">gui_hooks</span><span class="o">.</span><span class="n">av_player_will_play</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">on_av_player_will_play</span><span class="p">)</span>
        <span class="n">gui_hooks</span><span class="o">.</span><span class="n">av_player_did_end_playing</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">on_av_player_did_end_playing</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_activeWindowOnPlay</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">QWidget</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="AnkiQt.onOdueInvalid"><a class="viewcode-back" href="../../aqt.html#aqt.main.AnkiQt.onOdueInvalid">[docs]</a>    <span class="k">def</span> <span class="nf">onOdueInvalid</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">showWarning</span><span class="p">(</span>
            <span class="n">_</span><span class="p">(</span>
                <span class="sd">&quot;&quot;&quot;\</span>
<span class="sd">Invalid property found on card. Please use Tools&gt;Check Database, \</span>
<span class="sd">and if the problem comes up again, please ask on the support site.&quot;&quot;&quot;</span>
            <span class="p">)</span>
        <span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_isVideo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tag</span><span class="p">:</span> <span class="n">AVTag</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tag</span><span class="p">,</span> <span class="n">SoundOrVideoTag</span><span class="p">):</span>
            <span class="n">head</span><span class="p">,</span> <span class="n">ext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">tag</span><span class="o">.</span><span class="n">filename</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
            <span class="k">return</span> <span class="n">ext</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;.mp4&quot;</span><span class="p">,</span> <span class="s2">&quot;.mov&quot;</span><span class="p">,</span> <span class="s2">&quot;.mpg&quot;</span><span class="p">,</span> <span class="s2">&quot;.mpeg&quot;</span><span class="p">,</span> <span class="s2">&quot;.mkv&quot;</span><span class="p">,</span> <span class="s2">&quot;.avi&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="kc">False</span>

<div class="viewcode-block" id="AnkiQt.on_av_player_will_play"><a class="viewcode-back" href="../../aqt.html#aqt.main.AnkiQt.on_av_player_will_play">[docs]</a>    <span class="k">def</span> <span class="nf">on_av_player_will_play</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tag</span><span class="p">:</span> <span class="n">AVTag</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="s2">&quot;Record active window to restore after video playing.&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_isVideo</span><span class="p">(</span><span class="n">tag</span><span class="p">):</span>
            <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_activeWindowOnPlay</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">activeWindow</span><span class="p">()</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_activeWindowOnPlay</span></div>

<div class="viewcode-block" id="AnkiQt.on_av_player_did_end_playing"><a class="viewcode-back" href="../../aqt.html#aqt.main.AnkiQt.on_av_player_did_end_playing">[docs]</a>    <span class="k">def</span> <span class="nf">on_av_player_did_end_playing</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">player</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="s2">&quot;Restore window focus after a video was played.&quot;</span>
        <span class="n">w</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_activeWindowOnPlay</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">activeWindow</span><span class="p">()</span> <span class="ow">and</span> <span class="n">w</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">sip</span><span class="o">.</span><span class="n">isdeleted</span><span class="p">(</span><span class="n">w</span><span class="p">)</span> <span class="ow">and</span> <span class="n">w</span><span class="o">.</span><span class="n">isVisible</span><span class="p">():</span>
            <span class="n">w</span><span class="o">.</span><span class="n">activateWindow</span><span class="p">()</span>
            <span class="n">w</span><span class="o">.</span><span class="n">raise_</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_activeWindowOnPlay</span> <span class="o">=</span> <span class="kc">None</span></div>

    <span class="c1"># Log note deletion</span>
    <span class="c1">##########################################################################</span>

<div class="viewcode-block" id="AnkiQt.onRemNotes"><a class="viewcode-back" href="../../aqt.html#aqt.main.AnkiQt.onRemNotes">[docs]</a>    <span class="k">def</span> <span class="nf">onRemNotes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">col</span><span class="p">:</span> <span class="n">Collection</span><span class="p">,</span> <span class="n">nids</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">int</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pm</span><span class="o">.</span><span class="n">profileFolder</span><span class="p">(),</span> <span class="s2">&quot;deleted.txt&quot;</span><span class="p">)</span>
        <span class="n">existed</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;ab&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">existed</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;nid</span><span class="se">\t</span><span class="s2">mid</span><span class="se">\t</span><span class="s2">fields</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="nb">id</span><span class="p">,</span> <span class="n">mid</span><span class="p">,</span> <span class="n">flds</span> <span class="ow">in</span> <span class="n">col</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
                <span class="s2">&quot;select id, mid, flds from notes where id in </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">ids2str</span><span class="p">(</span><span class="n">nids</span><span class="p">)</span>
            <span class="p">):</span>
                <span class="n">fields</span> <span class="o">=</span> <span class="n">splitFields</span><span class="p">(</span><span class="n">flds</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">((</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="nb">id</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">mid</span><span class="p">)]</span> <span class="o">+</span> <span class="n">fields</span><span class="p">))</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf8&quot;</span><span class="p">))</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span></div>

    <span class="c1"># Schema modifications</span>
    <span class="c1">##########################################################################</span>

    <span class="c1"># this will gradually be phased out</span>
<div class="viewcode-block" id="AnkiQt.onSchemaMod"><a class="viewcode-back" href="../../aqt.html#aqt.main.AnkiQt.onSchemaMod">[docs]</a>    <span class="k">def</span> <span class="nf">onSchemaMod</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg</span><span class="p">):</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">inMainThread</span><span class="p">()</span>
        <span class="n">progress_shown</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">progress</span><span class="o">.</span><span class="n">busy</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">progress_shown</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">progress</span><span class="o">.</span><span class="n">finish</span><span class="p">()</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="n">askUser</span><span class="p">(</span>
            <span class="n">_</span><span class="p">(</span>
                <span class="sd">&quot;&quot;&quot;\</span>
<span class="sd">The requested change will require a full upload of the database when \</span>
<span class="sd">you next synchronize your collection. If you have reviews or other changes \</span>
<span class="sd">waiting on another device that haven&#39;t been synchronized here yet, they \</span>
<span class="sd">will be lost. Continue?&quot;&quot;&quot;</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">progress_shown</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">progress</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">ret</span></div>

    <span class="c1"># in favour of this</span>
<div class="viewcode-block" id="AnkiQt.confirm_schema_modification"><a class="viewcode-back" href="../../aqt.html#aqt.main.AnkiQt.confirm_schema_modification">[docs]</a>    <span class="k">def</span> <span class="nf">confirm_schema_modification</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;If schema unmodified, ask user to confirm change.</span>
<span class="sd">        True if confirmed or already modified.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="o">.</span><span class="n">schemaChanged</span><span class="p">():</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="n">askUser</span><span class="p">(</span>
            <span class="n">_</span><span class="p">(</span>
                <span class="sd">&quot;&quot;&quot;\</span>
<span class="sd">The requested change will require a full upload of the database when \</span>
<span class="sd">you next synchronize your collection. If you have reviews or other changes \</span>
<span class="sd">waiting on another device that haven&#39;t been synchronized here yet, they \</span>
<span class="sd">will be lost. Continue?&quot;&quot;&quot;</span>
            <span class="p">)</span>
        <span class="p">)</span></div>

    <span class="c1"># Advanced features</span>
    <span class="c1">##########################################################################</span>

<div class="viewcode-block" id="AnkiQt.onCheckDB"><a class="viewcode-back" href="../../aqt.html#aqt.main.AnkiQt.onCheckDB">[docs]</a>    <span class="k">def</span> <span class="nf">onCheckDB</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">check_db</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></div>

<div class="viewcode-block" id="AnkiQt.on_check_media_db"><a class="viewcode-back" href="../../aqt.html#aqt.main.AnkiQt.on_check_media_db">[docs]</a>    <span class="k">def</span> <span class="nf">on_check_media_db</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">check_media_db</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></div>

<div class="viewcode-block" id="AnkiQt.onStudyDeck"><a class="viewcode-back" href="../../aqt.html#aqt.main.AnkiQt.onStudyDeck">[docs]</a>    <span class="k">def</span> <span class="nf">onStudyDeck</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">aqt.studydeck</span> <span class="kn">import</span> <span class="n">StudyDeck</span>

        <span class="n">ret</span> <span class="o">=</span> <span class="n">StudyDeck</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dyn</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">current</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="o">.</span><span class="n">decks</span><span class="o">.</span><span class="n">current</span><span class="p">()[</span><span class="s2">&quot;name&quot;</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">ret</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="o">.</span><span class="n">decks</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="o">.</span><span class="n">decks</span><span class="o">.</span><span class="n">id</span><span class="p">(</span><span class="n">ret</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">moveToState</span><span class="p">(</span><span class="s2">&quot;overview&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="AnkiQt.onEmptyCards"><a class="viewcode-back" href="../../aqt.html#aqt.main.AnkiQt.onEmptyCards">[docs]</a>    <span class="k">def</span> <span class="nf">onEmptyCards</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">show_empty_cards</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></div>

    <span class="c1"># Debugging</span>
    <span class="c1">######################################################################</span>

<div class="viewcode-block" id="AnkiQt.onDebug"><a class="viewcode-back" href="../../aqt.html#aqt.main.AnkiQt.onDebug">[docs]</a>    <span class="k">def</span> <span class="nf">onDebug</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">frm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug_diag_form</span> <span class="o">=</span> <span class="n">aqt</span><span class="o">.</span><span class="n">forms</span><span class="o">.</span><span class="n">debug</span><span class="o">.</span><span class="n">Ui_Dialog</span><span class="p">()</span>

        <span class="k">class</span> <span class="nc">DebugDialog</span><span class="p">(</span><span class="n">QDialog</span><span class="p">):</span>
            <span class="k">def</span> <span class="nf">reject</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">reject</span><span class="p">()</span>
                <span class="n">saveSplitter</span><span class="p">(</span><span class="n">frm</span><span class="o">.</span><span class="n">splitter</span><span class="p">,</span> <span class="s2">&quot;DebugConsoleWindow&quot;</span><span class="p">)</span>
                <span class="n">saveGeom</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;DebugConsoleWindow&quot;</span><span class="p">)</span>

        <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">debugDiag</span> <span class="o">=</span> <span class="n">DebugDialog</span><span class="p">()</span>
        <span class="n">d</span><span class="o">.</span><span class="n">silentlyClose</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">frm</span><span class="o">.</span><span class="n">setupUi</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
        <span class="n">restoreGeom</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="s2">&quot;DebugConsoleWindow&quot;</span><span class="p">)</span>
        <span class="n">restoreSplitter</span><span class="p">(</span><span class="n">frm</span><span class="o">.</span><span class="n">splitter</span><span class="p">,</span> <span class="s2">&quot;DebugConsoleWindow&quot;</span><span class="p">)</span>
        <span class="n">font</span> <span class="o">=</span> <span class="n">QFontDatabase</span><span class="o">.</span><span class="n">systemFont</span><span class="p">(</span><span class="n">QFontDatabase</span><span class="o">.</span><span class="n">FixedFont</span><span class="p">)</span>
        <span class="n">font</span><span class="o">.</span><span class="n">setPointSize</span><span class="p">(</span><span class="n">frm</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">font</span><span class="p">()</span><span class="o">.</span><span class="n">pointSize</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">frm</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">setFont</span><span class="p">(</span><span class="n">font</span><span class="p">)</span>
        <span class="n">frm</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">setFont</span><span class="p">(</span><span class="n">font</span><span class="p">)</span>
        <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">debugDiagShort</span> <span class="o">=</span> <span class="n">QShortcut</span><span class="p">(</span><span class="n">QKeySequence</span><span class="p">(</span><span class="s2">&quot;ctrl+return&quot;</span><span class="p">),</span> <span class="n">d</span><span class="p">)</span>
        <span class="n">qconnect</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">activated</span><span class="p">,</span> <span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">onDebugRet</span><span class="p">(</span><span class="n">frm</span><span class="p">))</span>
        <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">debugDiagShort</span> <span class="o">=</span> <span class="n">QShortcut</span><span class="p">(</span><span class="n">QKeySequence</span><span class="p">(</span><span class="s2">&quot;ctrl+shift+return&quot;</span><span class="p">),</span> <span class="n">d</span><span class="p">)</span>
        <span class="n">qconnect</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">activated</span><span class="p">,</span> <span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">onDebugPrint</span><span class="p">(</span><span class="n">frm</span><span class="p">))</span>
        <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">debugDiagShort</span> <span class="o">=</span> <span class="n">QShortcut</span><span class="p">(</span><span class="n">QKeySequence</span><span class="p">(</span><span class="s2">&quot;ctrl+l&quot;</span><span class="p">),</span> <span class="n">d</span><span class="p">)</span>
        <span class="n">qconnect</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">activated</span><span class="p">,</span> <span class="n">frm</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">clear</span><span class="p">)</span>
        <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">debugDiagShort</span> <span class="o">=</span> <span class="n">QShortcut</span><span class="p">(</span><span class="n">QKeySequence</span><span class="p">(</span><span class="s2">&quot;ctrl+shift+l&quot;</span><span class="p">),</span> <span class="n">d</span><span class="p">)</span>
        <span class="n">qconnect</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">activated</span><span class="p">,</span> <span class="n">frm</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">clear</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">addContextMenu</span><span class="p">(</span><span class="n">ev</span><span class="p">:</span> <span class="n">QCloseEvent</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ev</span><span class="o">.</span><span class="n">accept</span><span class="p">()</span>
            <span class="n">menu</span> <span class="o">=</span> <span class="n">frm</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">createStandardContextMenu</span><span class="p">(</span><span class="n">QCursor</span><span class="o">.</span><span class="n">pos</span><span class="p">())</span>
            <span class="n">menu</span><span class="o">.</span><span class="n">addSeparator</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;log&quot;</span><span class="p">:</span>
                <span class="n">a</span> <span class="o">=</span> <span class="n">menu</span><span class="o">.</span><span class="n">addAction</span><span class="p">(</span><span class="s2">&quot;Clear Log&quot;</span><span class="p">)</span>
                <span class="n">a</span><span class="o">.</span><span class="n">setShortcuts</span><span class="p">(</span><span class="n">QKeySequence</span><span class="p">(</span><span class="s2">&quot;ctrl+l&quot;</span><span class="p">))</span>
                <span class="n">qconnect</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">triggered</span><span class="p">,</span> <span class="n">frm</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">clear</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;text&quot;</span><span class="p">:</span>
                <span class="n">a</span> <span class="o">=</span> <span class="n">menu</span><span class="o">.</span><span class="n">addAction</span><span class="p">(</span><span class="s2">&quot;Clear Code&quot;</span><span class="p">)</span>
                <span class="n">a</span><span class="o">.</span><span class="n">setShortcuts</span><span class="p">(</span><span class="n">QKeySequence</span><span class="p">(</span><span class="s2">&quot;ctrl+shift+l&quot;</span><span class="p">))</span>
                <span class="n">qconnect</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">triggered</span><span class="p">,</span> <span class="n">frm</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">clear</span><span class="p">)</span>
            <span class="n">menu</span><span class="o">.</span><span class="n">exec</span><span class="p">(</span><span class="n">QCursor</span><span class="o">.</span><span class="n">pos</span><span class="p">())</span>

        <span class="n">frm</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">contextMenuEvent</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">ev</span><span class="p">:</span> <span class="n">addContextMenu</span><span class="p">(</span><span class="n">ev</span><span class="p">,</span> <span class="s2">&quot;log&quot;</span><span class="p">)</span>
        <span class="n">frm</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">contextMenuEvent</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">ev</span><span class="p">:</span> <span class="n">addContextMenu</span><span class="p">(</span><span class="n">ev</span><span class="p">,</span> <span class="s2">&quot;text&quot;</span><span class="p">)</span>
        <span class="n">gui_hooks</span><span class="o">.</span><span class="n">debug_console_will_show</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
        <span class="n">d</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>

    <span class="k">def</span> <span class="nf">_captureOutput</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">on</span><span class="p">):</span>
        <span class="n">mw</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="k">class</span> <span class="nc">Stream</span><span class="p">:</span>
            <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
                <span class="n">mw</span><span class="o">.</span><span class="n">_output</span> <span class="o">+=</span> <span class="n">data</span>

        <span class="k">if</span> <span class="n">on</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_output</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_oldStderr</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_oldStdout</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">Stream</span><span class="p">()</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span> <span class="o">=</span> <span class="n">s</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span> <span class="o">=</span> <span class="n">s</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_oldStderr</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_oldStdout</span>

    <span class="k">def</span> <span class="nf">_card_repr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">card</span><span class="p">:</span> <span class="n">anki</span><span class="o">.</span><span class="n">cards</span><span class="o">.</span><span class="n">Card</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">pprint</span><span class="o">,</span> <span class="nn">copy</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">card</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;no card&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Front:&quot;</span><span class="p">,</span> <span class="n">card</span><span class="o">.</span><span class="n">question</span><span class="p">())</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Back:&quot;</span><span class="p">,</span> <span class="n">card</span><span class="o">.</span><span class="n">answer</span><span class="p">())</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Note:&quot;</span><span class="p">)</span>
        <span class="n">note</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">card</span><span class="o">.</span><span class="n">note</span><span class="p">())</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">note</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- </span><span class="si">{k}</span><span class="s2">:&quot;</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">del</span> <span class="n">note</span><span class="o">.</span><span class="n">fields</span>
        <span class="k">del</span> <span class="n">note</span><span class="o">.</span><span class="n">_fmap</span>
        <span class="n">pprint</span><span class="o">.</span><span class="n">pprint</span><span class="p">(</span><span class="n">note</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Card:&quot;</span><span class="p">)</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">card</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">_render_output</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">pprint</span><span class="o">.</span><span class="n">pprint</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_debugCard</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">anki</span><span class="o">.</span><span class="n">cards</span><span class="o">.</span><span class="n">Card</span><span class="p">]:</span>
        <span class="n">card</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reviewer</span><span class="o">.</span><span class="n">card</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_card_repr</span><span class="p">(</span><span class="n">card</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">card</span>

    <span class="k">def</span> <span class="nf">_debugBrowserCard</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">anki</span><span class="o">.</span><span class="n">cards</span><span class="o">.</span><span class="n">Card</span><span class="p">]:</span>
        <span class="n">card</span> <span class="o">=</span> <span class="n">aqt</span><span class="o">.</span><span class="n">dialogs</span><span class="o">.</span><span class="n">_dialogs</span><span class="p">[</span><span class="s2">&quot;Browser&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">card</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_card_repr</span><span class="p">(</span><span class="n">card</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">card</span>

<div class="viewcode-block" id="AnkiQt.onDebugPrint"><a class="viewcode-back" href="../../aqt.html#aqt.main.AnkiQt.onDebugPrint">[docs]</a>    <span class="k">def</span> <span class="nf">onDebugPrint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frm</span><span class="p">):</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="n">frm</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">textCursor</span><span class="p">()</span>
        <span class="n">position</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">position</span><span class="p">()</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">QTextCursor</span><span class="o">.</span><span class="n">LineUnderCursor</span><span class="p">)</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">selectedText</span><span class="p">()</span>
        <span class="n">pfx</span><span class="p">,</span> <span class="n">sfx</span> <span class="o">=</span> <span class="s2">&quot;pp(&quot;</span><span class="p">,</span> <span class="s2">&quot;)&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">pfx</span><span class="p">):</span>
            <span class="n">line</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}{}{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pfx</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">sfx</span><span class="p">)</span>
            <span class="n">cursor</span><span class="o">.</span><span class="n">insertText</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
            <span class="n">cursor</span><span class="o">.</span><span class="n">setPosition</span><span class="p">(</span><span class="n">position</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">pfx</span><span class="p">))</span>
            <span class="n">frm</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">setTextCursor</span><span class="p">(</span><span class="n">cursor</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">onDebugRet</span><span class="p">(</span><span class="n">frm</span><span class="p">)</span></div>

<div class="viewcode-block" id="AnkiQt.onDebugRet"><a class="viewcode-back" href="../../aqt.html#aqt.main.AnkiQt.onDebugRet">[docs]</a>    <span class="k">def</span> <span class="nf">onDebugRet</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frm</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">pprint</span><span class="o">,</span> <span class="nn">traceback</span>

        <span class="n">text</span> <span class="o">=</span> <span class="n">frm</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">toPlainText</span><span class="p">()</span>
        <span class="n">card</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_debugCard</span>
        <span class="n">bcard</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_debugBrowserCard</span>
        <span class="n">mw</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">pp</span> <span class="o">=</span> <span class="n">pprint</span><span class="o">.</span><span class="n">pprint</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_captureOutput</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># pylint: disable=exec-used</span>
            <span class="n">exec</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_output</span> <span class="o">+=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_captureOutput</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">buf</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">for</span> <span class="n">c</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">text</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">c</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">buf</span> <span class="o">+=</span> <span class="s2">&quot;&gt;&gt;&gt; </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">line</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">buf</span> <span class="o">+=</span> <span class="s2">&quot;... </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">line</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">to_append</span> <span class="o">=</span> <span class="n">buf</span> <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_output</span> <span class="ow">or</span> <span class="s2">&quot;&lt;no output&gt;&quot;</span><span class="p">)</span>
            <span class="n">to_append</span> <span class="o">=</span> <span class="n">gui_hooks</span><span class="o">.</span><span class="n">debug_console_did_evaluate_python</span><span class="p">(</span>
                <span class="n">to_append</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">frm</span>
            <span class="p">)</span>
            <span class="n">frm</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">appendPlainText</span><span class="p">(</span><span class="n">to_append</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">UnicodeDecodeError</span><span class="p">:</span>
            <span class="n">to_append</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;&lt;non-unicode text&gt;&quot;</span><span class="p">)</span>
            <span class="n">to_append</span> <span class="o">=</span> <span class="n">gui_hooks</span><span class="o">.</span><span class="n">debug_console_did_evaluate_python</span><span class="p">(</span>
                <span class="n">to_append</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">frm</span>
            <span class="p">)</span>
            <span class="n">frm</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">appendPlainText</span><span class="p">(</span><span class="n">to_append</span><span class="p">)</span>
        <span class="n">frm</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">ensureCursorVisible</span><span class="p">()</span></div>

    <span class="c1"># System specific code</span>
    <span class="c1">##########################################################################</span>

<div class="viewcode-block" id="AnkiQt.setupSystemSpecific"><a class="viewcode-back" href="../../aqt.html#aqt.main.AnkiQt.setupSystemSpecific">[docs]</a>    <span class="k">def</span> <span class="nf">setupSystemSpecific</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hideMenuAccels</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">isMac</span><span class="p">:</span>
            <span class="c1"># mac users expect a minimize option</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">minimizeShortcut</span> <span class="o">=</span> <span class="n">QShortcut</span><span class="p">(</span><span class="s2">&quot;Ctrl+M&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
            <span class="n">qconnect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">minimizeShortcut</span><span class="o">.</span><span class="n">activated</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">onMacMinimize</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hideMenuAccels</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">maybeHideAccelerators</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hideStatusTips</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">isWin</span><span class="p">:</span>
            <span class="c1"># make sure ctypes is bundled</span>
            <span class="kn">from</span> <span class="nn">ctypes</span> <span class="kn">import</span> <span class="n">windll</span><span class="p">,</span> <span class="n">wintypes</span>  <span class="c1"># type: ignore</span>

            <span class="n">_dummy1</span> <span class="o">=</span> <span class="n">windll</span>
            <span class="n">_dummy2</span> <span class="o">=</span> <span class="n">wintypes</span></div>

<div class="viewcode-block" id="AnkiQt.maybeHideAccelerators"><a class="viewcode-back" href="../../aqt.html#aqt.main.AnkiQt.maybeHideAccelerators">[docs]</a>    <span class="k">def</span> <span class="nf">maybeHideAccelerators</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tgt</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">hideMenuAccels</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">tgt</span> <span class="o">=</span> <span class="n">tgt</span> <span class="ow">or</span> <span class="bp">self</span>
        <span class="k">for</span> <span class="n">action</span> <span class="ow">in</span> <span class="n">tgt</span><span class="o">.</span><span class="n">findChildren</span><span class="p">(</span><span class="n">QAction</span><span class="p">):</span>
            <span class="n">txt</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">action</span><span class="o">.</span><span class="n">text</span><span class="p">())</span>
            <span class="n">m</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;^(.+)\(&amp;.+\)(.+)?&quot;</span><span class="p">,</span> <span class="n">txt</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">m</span><span class="p">:</span>
                <span class="n">action</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">))</span></div>

<div class="viewcode-block" id="AnkiQt.hideStatusTips"><a class="viewcode-back" href="../../aqt.html#aqt.main.AnkiQt.hideStatusTips">[docs]</a>    <span class="k">def</span> <span class="nf">hideStatusTips</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">action</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">findChildren</span><span class="p">(</span><span class="n">QAction</span><span class="p">):</span>
            <span class="n">action</span><span class="o">.</span><span class="n">setStatusTip</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="AnkiQt.onMacMinimize"><a class="viewcode-back" href="../../aqt.html#aqt.main.AnkiQt.onMacMinimize">[docs]</a>    <span class="k">def</span> <span class="nf">onMacMinimize</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setWindowState</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">windowState</span><span class="p">()</span> <span class="o">|</span> <span class="n">Qt</span><span class="o">.</span><span class="n">WindowMinimized</span><span class="p">)</span></div>

    <span class="c1"># Single instance support</span>
    <span class="c1">##########################################################################</span>

<div class="viewcode-block" id="AnkiQt.setupAppMsg"><a class="viewcode-back" href="../../aqt.html#aqt.main.AnkiQt.setupAppMsg">[docs]</a>    <span class="k">def</span> <span class="nf">setupAppMsg</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">qconnect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">appMsg</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">onAppMsg</span><span class="p">)</span></div>

<div class="viewcode-block" id="AnkiQt.onAppMsg"><a class="viewcode-back" href="../../aqt.html#aqt.main.AnkiQt.onAppMsg">[docs]</a>    <span class="k">def</span> <span class="nf">onAppMsg</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">buf</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">QTimer</span><span class="p">]:</span>
        <span class="n">is_addon</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_isAddon</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="s2">&quot;startup&quot;</span><span class="p">:</span>
            <span class="c1"># try again in a second</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">progress</span><span class="o">.</span><span class="n">timer</span><span class="p">(</span>
                <span class="mi">1000</span><span class="p">,</span> <span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">onAppMsg</span><span class="p">(</span><span class="n">buf</span><span class="p">),</span> <span class="kc">False</span><span class="p">,</span> <span class="n">requiresCollection</span><span class="o">=</span><span class="kc">False</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="s2">&quot;profileManager&quot;</span><span class="p">:</span>
            <span class="c1"># can&#39;t raise window while in profile manager</span>
            <span class="k">if</span> <span class="n">buf</span> <span class="o">==</span> <span class="s2">&quot;raise&quot;</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pendingImport</span> <span class="o">=</span> <span class="n">buf</span>
            <span class="k">if</span> <span class="n">is_addon</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Add-on will be installed when a profile is opened.&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Deck will be imported when a profile is opened.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">tooltip</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">interactiveState</span><span class="p">()</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">progress</span><span class="o">.</span><span class="n">busy</span><span class="p">():</span>
            <span class="c1"># we can&#39;t raise the main window while in profile dialog, syncing, etc</span>
            <span class="k">if</span> <span class="n">buf</span> <span class="o">!=</span> <span class="s2">&quot;raise&quot;</span><span class="p">:</span>
                <span class="n">showInfo</span><span class="p">(</span>
                    <span class="n">_</span><span class="p">(</span>
                        <span class="sd">&quot;&quot;&quot;\</span>
<span class="sd">Please ensure a profile is open and Anki is not busy, then try again.&quot;&quot;&quot;</span>
                    <span class="p">),</span>
                    <span class="n">parent</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="c1"># raise window</span>
        <span class="k">if</span> <span class="n">isWin</span><span class="p">:</span>
            <span class="c1"># on windows we can raise the window by minimizing and restoring</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">showMinimized</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">setWindowState</span><span class="p">(</span><span class="n">Qt</span><span class="o">.</span><span class="n">WindowActive</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">showNormal</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># on osx we can raise the window. on unity the icon in the tray will just flash.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">activateWindow</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">raise_</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">buf</span> <span class="o">==</span> <span class="s2">&quot;raise&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="c1"># import / add-on installation</span>
        <span class="k">if</span> <span class="n">is_addon</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">installAddon</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">handleImport</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span>

        <span class="k">return</span> <span class="kc">None</span></div>

    <span class="k">def</span> <span class="nf">_isAddon</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">buf</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">buf</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">addonManager</span><span class="o">.</span><span class="n">ext</span><span class="p">)</span>

    <span class="c1"># GC</span>
    <span class="c1">##########################################################################</span>
    <span class="c1"># ensure gc runs in main thread</span>

<div class="viewcode-block" id="AnkiQt.setupDialogGC"><a class="viewcode-back" href="../../aqt.html#aqt.main.AnkiQt.setupDialogGC">[docs]</a>    <span class="k">def</span> <span class="nf">setupDialogGC</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">qconnect</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">finished</span><span class="p">,</span> <span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">gcWindow</span><span class="p">(</span><span class="n">obj</span><span class="p">))</span></div>

<div class="viewcode-block" id="AnkiQt.gcWindow"><a class="viewcode-back" href="../../aqt.html#aqt.main.AnkiQt.gcWindow">[docs]</a>    <span class="k">def</span> <span class="nf">gcWindow</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">deleteLater</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">progress</span><span class="o">.</span><span class="n">timer</span><span class="p">(</span><span class="mi">1000</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">doGC</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="n">requiresCollection</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div>

<div class="viewcode-block" id="AnkiQt.disableGC"><a class="viewcode-back" href="../../aqt.html#aqt.main.AnkiQt.disableGC">[docs]</a>    <span class="k">def</span> <span class="nf">disableGC</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
        <span class="n">gc</span><span class="o">.</span><span class="n">disable</span><span class="p">()</span></div>

<div class="viewcode-block" id="AnkiQt.doGC"><a class="viewcode-back" href="../../aqt.html#aqt.main.AnkiQt.doGC">[docs]</a>    <span class="k">def</span> <span class="nf">doGC</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span></div>

    <span class="c1"># Crash log</span>
    <span class="c1">##########################################################################</span>

<div class="viewcode-block" id="AnkiQt.setupCrashLog"><a class="viewcode-back" href="../../aqt.html#aqt.main.AnkiQt.setupCrashLog">[docs]</a>    <span class="k">def</span> <span class="nf">setupCrashLog</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pm</span><span class="o">.</span><span class="n">base</span><span class="p">,</span> <span class="s2">&quot;crash.log&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_crashLog</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s2">&quot;ab&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">faulthandler</span><span class="o">.</span><span class="n">enable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_crashLog</span><span class="p">)</span></div>

    <span class="c1"># Media server</span>
    <span class="c1">##########################################################################</span>

<div class="viewcode-block" id="AnkiQt.setupMediaServer"><a class="viewcode-back" href="../../aqt.html#aqt.main.AnkiQt.setupMediaServer">[docs]</a>    <span class="k">def</span> <span class="nf">setupMediaServer</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mediaServer</span> <span class="o">=</span> <span class="n">aqt</span><span class="o">.</span><span class="n">mediasrv</span><span class="o">.</span><span class="n">MediaServer</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mediaServer</span><span class="o">.</span><span class="n">start</span><span class="p">()</span></div>

<div class="viewcode-block" id="AnkiQt.baseHTML"><a class="viewcode-back" href="../../aqt.html#aqt.main.AnkiQt.baseHTML">[docs]</a>    <span class="k">def</span> <span class="nf">baseHTML</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;&lt;base href=&quot;</span><span class="si">%s</span><span class="s1">&quot;&gt;&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">serverURL</span><span class="p">()</span></div>

<div class="viewcode-block" id="AnkiQt.serverURL"><a class="viewcode-back" href="../../aqt.html#aqt.main.AnkiQt.serverURL">[docs]</a>    <span class="k">def</span> <span class="nf">serverURL</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;http://127.0.0.1:</span><span class="si">%d</span><span class="s2">/&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">mediaServer</span><span class="o">.</span><span class="n">getPort</span><span class="p">()</span></div></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2020, Abdelrahman Hamdy

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>