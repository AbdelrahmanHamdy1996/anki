

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>anki.schedv2 &mdash; Anki  documentation</title>
  

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />

  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home" alt="Documentation Home"> Anki
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../anki.html">anki package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../aqt.html">aqt package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../genhooks_gui.html">genhooks_gui module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tools.html">tools package</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Anki</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>anki.schedv2</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for anki.schedv2</h1><div class="highlight"><pre>
<span></span><span class="c1"># Copyright: Ankitects Pty Ltd and contributors</span>
<span class="c1"># License: GNU AGPL, version 3 or later; http://www.gnu.org/licenses/agpl.html</span>

<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">annotations</span>

<span class="kn">import</span> <span class="nn">pprint</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">heapq</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">,</span> <span class="n">Set</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Union</span>

<span class="kn">import</span> <span class="nn">anki</span>  <span class="c1"># pylint: disable=unused-import</span>
<span class="kn">from</span> <span class="nn">anki</span> <span class="kn">import</span> <span class="n">hooks</span>
<span class="kn">from</span> <span class="nn">anki.cards</span> <span class="kn">import</span> <span class="n">Card</span>
<span class="kn">from</span> <span class="nn">anki.consts</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">anki.lang</span> <span class="kn">import</span> <span class="n">_</span>
<span class="kn">from</span> <span class="nn">anki.rsbackend</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">CountsForDeckToday</span><span class="p">,</span>
    <span class="n">DeckTreeNode</span><span class="p">,</span>
    <span class="n">FormatTimeSpanContext</span><span class="p">,</span>
    <span class="n">SchedTimingToday</span><span class="p">,</span>
    <span class="n">from_json_bytes</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">anki.utils</span> <span class="kn">import</span> <span class="n">ids2str</span><span class="p">,</span> <span class="n">intTime</span>

<span class="c1"># card types: 0=new, 1=lrn, 2=rev, 3=relrn</span>
<span class="c1"># queue types: 0=new, 1=(re)lrn, 2=rev, 3=day (re)lrn,</span>
<span class="c1">#   4=preview, -1=suspended, -2=sibling buried, -3=manually buried</span>

<span class="c1"># revlog types: 0=lrn, 1=rev, 2=relrn, 3=early review</span>
<span class="c1"># positive revlog intervals are in days (rev), negative in seconds (lrn)</span>
<span class="c1"># odue/odid store original due/did when cards moved to filtered deck</span>


<div class="viewcode-block" id="Scheduler"><a class="viewcode-back" href="../../anki.html#anki.schedv2.Scheduler">[docs]</a><span class="k">class</span> <span class="nc">Scheduler</span><span class="p">:</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;std2&quot;</span>
    <span class="n">haveCustomStudy</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">_burySiblingsOnAnswer</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">revCount</span><span class="p">:</span> <span class="nb">int</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">col</span><span class="p">:</span> <span class="n">anki</span><span class="o">.</span><span class="n">collection</span><span class="o">.</span><span class="n">Collection</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">col</span> <span class="o">=</span> <span class="n">col</span><span class="o">.</span><span class="n">weakref</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">queueLimit</span> <span class="o">=</span> <span class="mi">50</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reportLimit</span> <span class="o">=</span> <span class="mi">1000</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dynReportLimit</span> <span class="o">=</span> <span class="mi">99999</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reps</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">today</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_haveQueues</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_lrnCutoff</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_updateCutoff</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">d</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">)</span>
        <span class="k">del</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;col&quot;</span><span class="p">]</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;{super().__repr__()} {pprint.pformat(d, width=300)}&quot;</span>

<div class="viewcode-block" id="Scheduler.getCard"><a class="viewcode-back" href="../../anki.html#anki.schedv2.Scheduler.getCard">[docs]</a>    <span class="k">def</span> <span class="nf">getCard</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Card</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Pop the next card from the queue. None if finished.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_checkDay</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_haveQueues</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
        <span class="n">card</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getCard</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">card</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">card</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_burySiblingsOnAnswer</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_burySiblings</span><span class="p">(</span><span class="n">card</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reps</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">card</span><span class="o">.</span><span class="n">startTimer</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">card</span>
        <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="Scheduler.reset"><a class="viewcode-back" href="../../anki.html#anki.schedv2.Scheduler.reset">[docs]</a>    <span class="k">def</span> <span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="o">.</span><span class="n">decks</span><span class="o">.</span><span class="n">update_active</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_updateCutoff</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_reset_counts</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_resetLrn</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_resetRev</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_resetNew</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_haveQueues</span> <span class="o">=</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="Scheduler.answerCard"><a class="viewcode-back" href="../../anki.html#anki.schedv2.Scheduler.answerCard">[docs]</a>    <span class="k">def</span> <span class="nf">answerCard</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">card</span><span class="p">:</span> <span class="n">Card</span><span class="p">,</span> <span class="n">ease</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="o">.</span><span class="n">log</span><span class="p">()</span>
        <span class="k">assert</span> <span class="mi">1</span> <span class="o">&lt;=</span> <span class="n">ease</span> <span class="o">&lt;=</span> <span class="mi">4</span>
        <span class="k">assert</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">card</span><span class="o">.</span><span class="n">queue</span> <span class="o">&lt;=</span> <span class="mi">4</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="o">.</span><span class="n">markReview</span><span class="p">(</span><span class="n">card</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_burySiblingsOnAnswer</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_burySiblings</span><span class="p">(</span><span class="n">card</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_answerCard</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">ease</span><span class="p">)</span>

        <span class="n">card</span><span class="o">.</span><span class="n">mod</span> <span class="o">=</span> <span class="n">intTime</span><span class="p">()</span>
        <span class="n">card</span><span class="o">.</span><span class="n">usn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="o">.</span><span class="n">usn</span><span class="p">()</span>
        <span class="n">card</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span></div>

    <span class="k">def</span> <span class="nf">_answerCard</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">card</span><span class="p">:</span> <span class="n">Card</span><span class="p">,</span> <span class="n">ease</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_previewingCard</span><span class="p">(</span><span class="n">card</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_answerCardPreview</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">ease</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">card</span><span class="o">.</span><span class="n">reps</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="n">new_delta</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">review_delta</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">if</span> <span class="n">card</span><span class="o">.</span><span class="n">queue</span> <span class="o">==</span> <span class="n">QUEUE_TYPE_NEW</span><span class="p">:</span>
            <span class="c1"># came from the new queue, move to learning</span>
            <span class="n">card</span><span class="o">.</span><span class="n">queue</span> <span class="o">=</span> <span class="n">QUEUE_TYPE_LRN</span>
            <span class="n">card</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">CARD_TYPE_LRN</span>
            <span class="c1"># init reps to graduation</span>
            <span class="n">card</span><span class="o">.</span><span class="n">left</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_startingLeft</span><span class="p">(</span><span class="n">card</span><span class="p">)</span>
            <span class="n">new_delta</span> <span class="o">=</span> <span class="o">+</span><span class="mi">1</span>

        <span class="k">if</span> <span class="n">card</span><span class="o">.</span><span class="n">queue</span> <span class="ow">in</span> <span class="p">(</span><span class="n">QUEUE_TYPE_LRN</span><span class="p">,</span> <span class="n">QUEUE_TYPE_DAY_LEARN_RELEARN</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_answerLrnCard</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">ease</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">card</span><span class="o">.</span><span class="n">queue</span> <span class="o">==</span> <span class="n">QUEUE_TYPE_REV</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_answerRevCard</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">ease</span><span class="p">)</span>
            <span class="n">review_delta</span> <span class="o">=</span> <span class="o">+</span><span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Invalid queue &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="n">card</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">update_stats</span><span class="p">(</span>
            <span class="n">card</span><span class="o">.</span><span class="n">did</span><span class="p">,</span>
            <span class="n">new_delta</span><span class="o">=</span><span class="n">new_delta</span><span class="p">,</span>
            <span class="n">review_delta</span><span class="o">=</span><span class="n">review_delta</span><span class="p">,</span>
            <span class="n">milliseconds_delta</span><span class="o">=+</span><span class="n">card</span><span class="o">.</span><span class="n">timeTaken</span><span class="p">(),</span>
        <span class="p">)</span>

        <span class="c1"># once a card has been answered once, the original due date</span>
        <span class="c1"># no longer applies</span>
        <span class="k">if</span> <span class="n">card</span><span class="o">.</span><span class="n">odue</span><span class="p">:</span>
            <span class="n">card</span><span class="o">.</span><span class="n">odue</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">_answerCardPreview</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">card</span><span class="p">:</span> <span class="n">Card</span><span class="p">,</span> <span class="n">ease</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">assert</span> <span class="mi">1</span> <span class="o">&lt;=</span> <span class="n">ease</span> <span class="o">&lt;=</span> <span class="mi">2</span>

        <span class="k">if</span> <span class="n">ease</span> <span class="o">==</span> <span class="n">BUTTON_ONE</span><span class="p">:</span>
            <span class="c1"># repeat after delay</span>
            <span class="n">card</span><span class="o">.</span><span class="n">queue</span> <span class="o">=</span> <span class="n">QUEUE_TYPE_PREVIEW</span>
            <span class="n">card</span><span class="o">.</span><span class="n">due</span> <span class="o">=</span> <span class="n">intTime</span><span class="p">()</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_previewDelay</span><span class="p">(</span><span class="n">card</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lrnCount</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># BUTTON_TWO</span>
            <span class="c1"># restore original card state and remove from filtered deck</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_restorePreviewCard</span><span class="p">(</span><span class="n">card</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_removeFromFiltered</span><span class="p">(</span><span class="n">card</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_reset_counts</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">tree</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">deck_due_tree</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="o">.</span><span class="n">decks</span><span class="o">.</span><span class="n">selected</span><span class="p">())</span>
        <span class="n">node</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="o">.</span><span class="n">decks</span><span class="o">.</span><span class="n">find_deck_in_tree</span><span class="p">(</span><span class="n">tree</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="o">.</span><span class="n">conf</span><span class="p">[</span><span class="s2">&quot;curDeck&quot;</span><span class="p">]))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">node</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;invalid current deck&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">newCount</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">revCount</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">newCount</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">new_count</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">revCount</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">review_count</span>

<div class="viewcode-block" id="Scheduler.counts"><a class="viewcode-back" href="../../anki.html#anki.schedv2.Scheduler.counts">[docs]</a>    <span class="k">def</span> <span class="nf">counts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">card</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Card</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
        <span class="n">counts</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">newCount</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lrnCount</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">revCount</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">card</span><span class="p">:</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">countIdx</span><span class="p">(</span><span class="n">card</span><span class="p">)</span>
            <span class="n">counts</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">new</span><span class="p">,</span> <span class="n">lrn</span><span class="p">,</span> <span class="n">rev</span> <span class="o">=</span> <span class="n">counts</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">new</span><span class="p">,</span> <span class="n">lrn</span><span class="p">,</span> <span class="n">rev</span><span class="p">)</span></div>

<div class="viewcode-block" id="Scheduler.dueForecast"><a class="viewcode-back" href="../../anki.html#anki.schedv2.Scheduler.dueForecast">[docs]</a>    <span class="k">def</span> <span class="nf">dueForecast</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">days</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">7</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Any</span><span class="p">]:</span>
        <span class="s2">&quot;Return counts over next DAYS. Includes today.&quot;</span>
        <span class="n">daysd</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">all</span><span class="p">(</span>  <span class="c1"># type: ignore</span>
                <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">select due, count() from cards</span>
<span class="s2">where did in </span><span class="si">%s</span><span class="s2"> and queue = </span><span class="si">{QUEUE_TYPE_REV}</span><span class="s2"></span>
<span class="s2">and due between ? and ?</span>
<span class="s2">group by due</span>
<span class="s2">order by due&quot;&quot;&quot;</span>
                <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_deckLimit</span><span class="p">(),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">today</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">today</span> <span class="o">+</span> <span class="n">days</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">days</span><span class="p">):</span>
            <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">today</span> <span class="o">+</span> <span class="n">d</span>
            <span class="k">if</span> <span class="n">d</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">daysd</span><span class="p">:</span>
                <span class="n">daysd</span><span class="p">[</span><span class="n">d</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c1"># return in sorted order</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">daysd</span><span class="o">.</span><span class="n">items</span><span class="p">())]</span>
        <span class="k">return</span> <span class="n">ret</span></div>

<div class="viewcode-block" id="Scheduler.countIdx"><a class="viewcode-back" href="../../anki.html#anki.schedv2.Scheduler.countIdx">[docs]</a>    <span class="k">def</span> <span class="nf">countIdx</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">card</span><span class="p">:</span> <span class="n">Card</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">card</span><span class="o">.</span><span class="n">queue</span> <span class="ow">in</span> <span class="p">(</span><span class="n">QUEUE_TYPE_DAY_LEARN_RELEARN</span><span class="p">,</span> <span class="n">QUEUE_TYPE_PREVIEW</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">QUEUE_TYPE_LRN</span>
        <span class="k">return</span> <span class="n">card</span><span class="o">.</span><span class="n">queue</span></div>

<div class="viewcode-block" id="Scheduler.answerButtons"><a class="viewcode-back" href="../../anki.html#anki.schedv2.Scheduler.answerButtons">[docs]</a>    <span class="k">def</span> <span class="nf">answerButtons</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">card</span><span class="p">:</span> <span class="n">Card</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="n">conf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cardConf</span><span class="p">(</span><span class="n">card</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">card</span><span class="o">.</span><span class="n">odid</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">conf</span><span class="p">[</span><span class="s2">&quot;resched&quot;</span><span class="p">]:</span>
            <span class="k">return</span> <span class="mi">2</span>
        <span class="k">return</span> <span class="mi">4</span></div>

    <span class="c1"># Rev/lrn/time daily stats</span>
    <span class="c1">##########################################################################</span>

<div class="viewcode-block" id="Scheduler.update_stats"><a class="viewcode-back" href="../../anki.html#anki.schedv2.Scheduler.update_stats">[docs]</a>    <span class="k">def</span> <span class="nf">update_stats</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">deck_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">new_delta</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">review_delta</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">milliseconds_delta</span><span class="o">=</span><span class="mi">0</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="o">.</span><span class="n">backend</span><span class="o">.</span><span class="n">update_stats</span><span class="p">(</span>
            <span class="n">deck_id</span><span class="o">=</span><span class="n">deck_id</span><span class="p">,</span>
            <span class="n">new_delta</span><span class="o">=</span><span class="n">new_delta</span><span class="p">,</span>
            <span class="n">review_delta</span><span class="o">=</span><span class="n">review_delta</span><span class="p">,</span>
            <span class="n">millisecond_delta</span><span class="o">=</span><span class="n">milliseconds_delta</span><span class="p">,</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="Scheduler.counts_for_deck_today"><a class="viewcode-back" href="../../anki.html#anki.schedv2.Scheduler.counts_for_deck_today">[docs]</a>    <span class="k">def</span> <span class="nf">counts_for_deck_today</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">deck_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">CountsForDeckToday</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="o">.</span><span class="n">backend</span><span class="o">.</span><span class="n">counts_for_deck_today</span><span class="p">(</span><span class="n">deck_id</span><span class="p">)</span></div>

<div class="viewcode-block" id="Scheduler.extendLimits"><a class="viewcode-back" href="../../anki.html#anki.schedv2.Scheduler.extendLimits">[docs]</a>    <span class="k">def</span> <span class="nf">extendLimits</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">rev</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">did</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="o">.</span><span class="n">decks</span><span class="o">.</span><span class="n">current</span><span class="p">()[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="o">.</span><span class="n">backend</span><span class="o">.</span><span class="n">extend_limits</span><span class="p">(</span><span class="n">deck_id</span><span class="o">=</span><span class="n">did</span><span class="p">,</span> <span class="n">new_delta</span><span class="o">=</span><span class="n">new</span><span class="p">,</span> <span class="n">review_delta</span><span class="o">=</span><span class="n">rev</span><span class="p">)</span></div>

    <span class="c1"># legacy</span>

    <span class="k">def</span> <span class="nf">_updateStats</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">card</span><span class="p">:</span> <span class="n">Card</span><span class="p">,</span> <span class="nb">type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">cnt</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">did</span> <span class="o">=</span> <span class="n">card</span><span class="o">.</span><span class="n">did</span>
        <span class="k">if</span> <span class="nb">type</span> <span class="o">==</span> <span class="s2">&quot;new&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update_stats</span><span class="p">(</span><span class="n">did</span><span class="p">,</span> <span class="n">new_delta</span><span class="o">=</span><span class="n">cnt</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">type</span> <span class="o">==</span> <span class="s2">&quot;rev&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update_stats</span><span class="p">(</span><span class="n">did</span><span class="p">,</span> <span class="n">review_delta</span><span class="o">=</span><span class="n">cnt</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">type</span> <span class="o">==</span> <span class="s2">&quot;time&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update_stats</span><span class="p">(</span><span class="n">did</span><span class="p">,</span> <span class="n">milliseconds_delta</span><span class="o">=</span><span class="n">cnt</span><span class="p">)</span>

    <span class="c1"># Deck list</span>
    <span class="c1">##########################################################################</span>

<div class="viewcode-block" id="Scheduler.deckDueTree"><a class="viewcode-back" href="../../anki.html#anki.schedv2.Scheduler.deckDueTree">[docs]</a>    <span class="k">def</span> <span class="nf">deckDueTree</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">:</span>
        <span class="s2">&quot;List of (base name, did, rev, lrn, new, children)&quot;</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="s2">&quot;deckDueTree() is deprecated; use decks.deck_tree() for a tree without counts, or sched.deck_due_tree()&quot;</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">from_json_bytes</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="o">.</span><span class="n">backend</span><span class="o">.</span><span class="n">deck_tree_legacy</span><span class="p">())[</span><span class="mi">5</span><span class="p">]</span></div>

<div class="viewcode-block" id="Scheduler.deck_due_tree"><a class="viewcode-back" href="../../anki.html#anki.schedv2.Scheduler.deck_due_tree">[docs]</a>    <span class="k">def</span> <span class="nf">deck_due_tree</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">top_deck_id</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DeckTreeNode</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Returns a tree of decks with counts.</span>
<span class="sd">        If top_deck_id provided, counts are limited to that node.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="o">.</span><span class="n">backend</span><span class="o">.</span><span class="n">deck_tree</span><span class="p">(</span><span class="n">top_deck_id</span><span class="o">=</span><span class="n">top_deck_id</span><span class="p">,</span> <span class="n">now</span><span class="o">=</span><span class="n">intTime</span><span class="p">())</span></div>

    <span class="c1"># Getting the next card</span>
    <span class="c1">##########################################################################</span>

    <span class="k">def</span> <span class="nf">_getCard</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Card</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Return the next due card, or None.&quot;&quot;&quot;</span>
        <span class="c1"># learning card due?</span>
        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getLrnCard</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">c</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">c</span>

        <span class="c1"># new first, or time for one?</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_timeForNewCard</span><span class="p">():</span>
            <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getNewCard</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">c</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">c</span>

        <span class="c1"># day learning first and card due?</span>
        <span class="n">dayLearnFirst</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;dayLearnFirst&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dayLearnFirst</span><span class="p">:</span>
            <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getLrnDayCard</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">c</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">c</span>

        <span class="c1"># card due for review?</span>
        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getRevCard</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">c</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">c</span>

        <span class="c1"># day learning card due?</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">dayLearnFirst</span><span class="p">:</span>
            <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getLrnDayCard</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">c</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">c</span>

        <span class="c1"># new cards left?</span>
        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getNewCard</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">c</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">c</span>

        <span class="c1"># collapse or finish</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getLrnCard</span><span class="p">(</span><span class="n">collapse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># New cards</span>
    <span class="c1">##########################################################################</span>

    <span class="k">def</span> <span class="nf">_resetNew</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_newDids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="o">.</span><span class="n">decks</span><span class="o">.</span><span class="n">active</span><span class="p">()[:]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_newQueue</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_updateNewCardRatio</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_fillNew</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">recursing</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_newQueue</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">newCount</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">_newDids</span><span class="p">:</span>
            <span class="n">did</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_newDids</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">lim</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">queueLimit</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_deckNewLimit</span><span class="p">(</span><span class="n">did</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">lim</span><span class="p">:</span>
                <span class="c1"># fill the queue with the current did</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_newQueue</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">list</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                select id from cards where did = ? and queue = </span><span class="si">{QUEUE_TYPE_NEW}</span><span class="s2"> order by due,ord limit ?&quot;&quot;&quot;</span><span class="p">,</span>
                    <span class="n">did</span><span class="p">,</span>
                    <span class="n">lim</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_newQueue</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_newQueue</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>
                    <span class="k">return</span> <span class="kc">True</span>
            <span class="c1"># nothing left in the deck; move to next</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_newDids</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1"># if we didn&#39;t get a card but the count is non-zero,</span>
        <span class="c1"># we need to check again for any cards that were</span>
        <span class="c1"># removed from the queue but not buried</span>
        <span class="k">if</span> <span class="n">recursing</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;bug: fillNew()&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_resetNew</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fillNew</span><span class="p">(</span><span class="n">recursing</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_getNewCard</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Card</span><span class="p">]:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fillNew</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">newCount</span> <span class="o">-=</span> <span class="mi">1</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="o">.</span><span class="n">getCard</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_newQueue</span><span class="o">.</span><span class="n">pop</span><span class="p">())</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">_updateNewCardRatio</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="o">.</span><span class="n">conf</span><span class="p">[</span><span class="s2">&quot;newSpread&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">NEW_CARDS_DISTRIBUTE</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">newCount</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">newCardModulus</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">newCount</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">revCount</span><span class="p">)</span> <span class="o">//</span> <span class="bp">self</span><span class="o">.</span><span class="n">newCount</span>
                <span class="c1"># if there are cards to review, ensure modulo &gt;= 2</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">revCount</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">newCardModulus</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">newCardModulus</span><span class="p">)</span>
                <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">newCardModulus</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">_timeForNewCard</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]:</span>
        <span class="s2">&quot;True if it&#39;s time to display a new card when distributing.&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">newCount</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="o">.</span><span class="n">conf</span><span class="p">[</span><span class="s2">&quot;newSpread&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">NEW_CARDS_LAST</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="o">.</span><span class="n">conf</span><span class="p">[</span><span class="s2">&quot;newSpread&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">NEW_CARDS_FIRST</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">newCardModulus</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">reps</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">reps</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">newCardModulus</span> <span class="o">==</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># shouldn&#39;t reach</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">_deckNewLimit</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">did</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">fn</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">[[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span> <span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">fn</span><span class="p">:</span>
            <span class="n">fn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_deckNewLimitSingle</span>
        <span class="n">sel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="o">.</span><span class="n">decks</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">did</span><span class="p">)</span>
        <span class="n">lim</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="c1"># for the deck and each of its parents</span>
        <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="p">[</span><span class="n">sel</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="o">.</span><span class="n">decks</span><span class="o">.</span><span class="n">parents</span><span class="p">(</span><span class="n">did</span><span class="p">):</span>
            <span class="n">rem</span> <span class="o">=</span> <span class="n">fn</span><span class="p">(</span><span class="n">g</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">lim</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">lim</span> <span class="o">=</span> <span class="n">rem</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">lim</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">rem</span><span class="p">,</span> <span class="n">lim</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">lim</span>

    <span class="k">def</span> <span class="nf">_newForDeck</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">did</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">lim</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="s2">&quot;New count for a single deck.&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">lim</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span>
        <span class="n">lim</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">lim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">reportLimit</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">scalar</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">select count() from</span>
<span class="s2">(select 1 from cards where did = ? and queue = </span><span class="si">{QUEUE_TYPE_NEW}</span><span class="s2"> limit ?)&quot;&quot;&quot;</span><span class="p">,</span>
            <span class="n">did</span><span class="p">,</span>
            <span class="n">lim</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_deckNewLimitSingle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">g</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="s2">&quot;Limit for deck without parent limits.&quot;</span>
        <span class="k">if</span> <span class="n">g</span><span class="p">[</span><span class="s2">&quot;dyn&quot;</span><span class="p">]:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dynReportLimit</span>
        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="o">.</span><span class="n">decks</span><span class="o">.</span><span class="n">confForDid</span><span class="p">(</span><span class="n">g</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">])</span>
        <span class="n">limit</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">c</span><span class="p">[</span><span class="s2">&quot;new&quot;</span><span class="p">][</span><span class="s2">&quot;perDay&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">counts_for_deck_today</span><span class="p">(</span><span class="n">g</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">new</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">hooks</span><span class="o">.</span><span class="n">scheduler_new_limit_for_single_deck</span><span class="p">(</span><span class="n">limit</span><span class="p">,</span> <span class="n">g</span><span class="p">)</span>

<div class="viewcode-block" id="Scheduler.totalNewForCurrentDeck"><a class="viewcode-back" href="../../anki.html#anki.schedv2.Scheduler.totalNewForCurrentDeck">[docs]</a>    <span class="k">def</span> <span class="nf">totalNewForCurrentDeck</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">scalar</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">select count() from cards where id in (</span>
<span class="s2">select id from cards where did in </span><span class="si">%s</span><span class="s2"> and queue = </span><span class="si">{QUEUE_TYPE_NEW}</span><span class="s2"> limit ?)&quot;&quot;&quot;</span>
            <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_deckLimit</span><span class="p">(),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reportLimit</span><span class="p">,</span>
        <span class="p">)</span></div>

    <span class="c1"># Learning queues</span>
    <span class="c1">##########################################################################</span>

    <span class="c1"># scan for any newly due learning cards every minute</span>
    <span class="k">def</span> <span class="nf">_updateLrnCutoff</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">force</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="n">nextCutoff</span> <span class="o">=</span> <span class="n">intTime</span><span class="p">()</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="o">.</span><span class="n">conf</span><span class="p">[</span><span class="s2">&quot;collapseTime&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">nextCutoff</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lrnCutoff</span> <span class="o">&gt;</span> <span class="mi">60</span> <span class="ow">or</span> <span class="n">force</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_lrnCutoff</span> <span class="o">=</span> <span class="n">nextCutoff</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">_maybeResetLrn</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">force</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_updateLrnCutoff</span><span class="p">(</span><span class="n">force</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_resetLrn</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_resetLrnCount</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># sub-day</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lrnCount</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">scalar</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">select count() from cards where did in </span><span class="si">%s</span><span class="s2"> and queue = </span><span class="si">{QUEUE_TYPE_LRN}</span><span class="s2"></span>
<span class="s2">and due &lt; ?&quot;&quot;&quot;</span>
                <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_deckLimit</span><span class="p">()),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_lrnCutoff</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="ow">or</span> <span class="mi">0</span>
        <span class="p">)</span>
        <span class="c1"># day</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lrnCount</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">scalar</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">select count() from cards where did in </span><span class="si">%s</span><span class="s2"> and queue = </span><span class="si">{QUEUE_TYPE_DAY_LEARN_RELEARN}</span><span class="s2"></span>
<span class="s2">and due &lt;= ?&quot;&quot;&quot;</span>
            <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_deckLimit</span><span class="p">()),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">today</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="c1"># previews</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lrnCount</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">scalar</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">select count() from cards where did in </span><span class="si">%s</span><span class="s2"> and queue = </span><span class="si">{QUEUE_TYPE_PREVIEW}</span><span class="s2"></span>
<span class="s2">&quot;&quot;&quot;</span>
            <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_deckLimit</span><span class="p">())</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_resetLrn</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_updateLrnCutoff</span><span class="p">(</span><span class="n">force</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_resetLrnCount</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_lrnQueue</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_lrnDayQueue</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_lrnDids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="o">.</span><span class="n">decks</span><span class="o">.</span><span class="n">active</span><span class="p">()[:]</span>

    <span class="c1"># sub-day learning</span>
    <span class="k">def</span> <span class="nf">_fillLrn</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Any</span><span class="p">]]:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">lrnCount</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lrnQueue</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="n">cutoff</span> <span class="o">=</span> <span class="n">intTime</span><span class="p">()</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="o">.</span><span class="n">conf</span><span class="p">[</span><span class="s2">&quot;collapseTime&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_lrnQueue</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">all</span><span class="p">(</span>  <span class="c1"># type: ignore</span>
            <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">select due, id from cards where</span>
<span class="s2">did in </span><span class="si">%s</span><span class="s2"> and queue in (</span><span class="si">{QUEUE_TYPE_LRN}</span><span class="s2">,</span><span class="si">{QUEUE_TYPE_PREVIEW}</span><span class="s2">) and due &lt; ?</span>
<span class="s2">limit </span><span class="si">%d</span><span class="s2">&quot;&quot;&quot;</span>
            <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_deckLimit</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">reportLimit</span><span class="p">),</span>
            <span class="n">cutoff</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_lrnQueue</span><span class="p">)):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_lrnQueue</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_lrnQueue</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lrnQueue</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
        <span class="c1"># as it arrives sorted by did first, we need to sort it</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_lrnQueue</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lrnQueue</span>

    <span class="k">def</span> <span class="nf">_getLrnCard</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">collapse</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Card</span><span class="p">]:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_maybeResetLrn</span><span class="p">(</span><span class="n">force</span><span class="o">=</span><span class="n">collapse</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">lrnCount</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fillLrn</span><span class="p">():</span>
            <span class="n">cutoff</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">collapse</span><span class="p">:</span>
                <span class="n">cutoff</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="o">.</span><span class="n">conf</span><span class="p">[</span><span class="s2">&quot;collapseTime&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lrnQueue</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">cutoff</span><span class="p">:</span>
                <span class="nb">id</span> <span class="o">=</span> <span class="n">heappop</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_lrnQueue</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">card</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="o">.</span><span class="n">getCard</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lrnCount</span> <span class="o">-=</span> <span class="mi">1</span>
                <span class="k">return</span> <span class="n">card</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="c1"># daily learning</span>
    <span class="k">def</span> <span class="nf">_fillLrnDay</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">lrnCount</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lrnDayQueue</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lrnDids</span><span class="p">:</span>
            <span class="n">did</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lrnDids</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="c1"># fill the queue with the current did</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_lrnDayQueue</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">list</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">select id from cards where</span>
<span class="s2">did = ? and queue = </span><span class="si">{QUEUE_TYPE_DAY_LEARN_RELEARN}</span><span class="s2"> and due &lt;= ? limit ?&quot;&quot;&quot;</span><span class="p">,</span>
                <span class="n">did</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">today</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">queueLimit</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lrnDayQueue</span><span class="p">:</span>
                <span class="c1"># order</span>
                <span class="n">r</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">Random</span><span class="p">()</span>
                <span class="n">r</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">today</span><span class="p">)</span>
                <span class="n">r</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_lrnDayQueue</span><span class="p">)</span>
                <span class="c1"># is the current did empty?</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_lrnDayQueue</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">queueLimit</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_lrnDids</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">True</span>
            <span class="c1"># nothing left in the deck; move to next</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_lrnDids</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="c1"># shouldn&#39;t reach here</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">_getLrnDayCard</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Card</span><span class="p">]:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fillLrnDay</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lrnCount</span> <span class="o">-=</span> <span class="mi">1</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="o">.</span><span class="n">getCard</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_lrnDayQueue</span><span class="o">.</span><span class="n">pop</span><span class="p">())</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">_answerLrnCard</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">card</span><span class="p">:</span> <span class="n">Card</span><span class="p">,</span> <span class="n">ease</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">conf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lrnConf</span><span class="p">(</span><span class="n">card</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">card</span><span class="o">.</span><span class="n">type</span> <span class="ow">in</span> <span class="p">(</span><span class="n">CARD_TYPE_REV</span><span class="p">,</span> <span class="n">CARD_TYPE_RELEARNING</span><span class="p">):</span>
            <span class="nb">type</span> <span class="o">=</span> <span class="n">REVLOG_RELRN</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">type</span> <span class="o">=</span> <span class="n">REVLOG_LRN</span>
        <span class="c1"># lrnCount was decremented once when card was fetched</span>
        <span class="n">lastLeft</span> <span class="o">=</span> <span class="n">card</span><span class="o">.</span><span class="n">left</span>

        <span class="n">leaving</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># immediate graduate?</span>
        <span class="k">if</span> <span class="n">ease</span> <span class="o">==</span> <span class="n">BUTTON_FOUR</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_rescheduleAsRev</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">conf</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
            <span class="n">leaving</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="c1"># next step?</span>
        <span class="k">elif</span> <span class="n">ease</span> <span class="o">==</span> <span class="n">BUTTON_THREE</span><span class="p">:</span>
            <span class="c1"># graduation time?</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">.</span><span class="n">left</span> <span class="o">%</span> <span class="mi">1000</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_rescheduleAsRev</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">conf</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
                <span class="n">leaving</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_moveToNextStep</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">conf</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">ease</span> <span class="o">==</span> <span class="n">BUTTON_TWO</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_repeatStep</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">conf</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># back to first step</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_moveToFirstStep</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">conf</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_logLrn</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">ease</span><span class="p">,</span> <span class="n">conf</span><span class="p">,</span> <span class="n">leaving</span><span class="p">,</span> <span class="nb">type</span><span class="p">,</span> <span class="n">lastLeft</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_updateRevIvlOnFail</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">card</span><span class="p">:</span> <span class="n">Card</span><span class="p">,</span> <span class="n">conf</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">card</span><span class="o">.</span><span class="n">lastIvl</span> <span class="o">=</span> <span class="n">card</span><span class="o">.</span><span class="n">ivl</span>
        <span class="n">card</span><span class="o">.</span><span class="n">ivl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lapseIvl</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">conf</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_moveToFirstStep</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">card</span><span class="p">:</span> <span class="n">Card</span><span class="p">,</span> <span class="n">conf</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
        <span class="n">card</span><span class="o">.</span><span class="n">left</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_startingLeft</span><span class="p">(</span><span class="n">card</span><span class="p">)</span>

        <span class="c1"># relearning card?</span>
        <span class="k">if</span> <span class="n">card</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">CARD_TYPE_RELEARNING</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_updateRevIvlOnFail</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">conf</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rescheduleLrnCard</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">conf</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_moveToNextStep</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">card</span><span class="p">:</span> <span class="n">Card</span><span class="p">,</span> <span class="n">conf</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># decrement real left count and recalculate left today</span>
        <span class="n">left</span> <span class="o">=</span> <span class="p">(</span><span class="n">card</span><span class="o">.</span><span class="n">left</span> <span class="o">%</span> <span class="mi">1000</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="n">card</span><span class="o">.</span><span class="n">left</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_leftToday</span><span class="p">(</span><span class="n">conf</span><span class="p">[</span><span class="s2">&quot;delays&quot;</span><span class="p">],</span> <span class="n">left</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000</span> <span class="o">+</span> <span class="n">left</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_rescheduleLrnCard</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">conf</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_repeatStep</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">card</span><span class="p">:</span> <span class="n">Card</span><span class="p">,</span> <span class="n">conf</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">delay</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_delayForRepeatingGrade</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">card</span><span class="o">.</span><span class="n">left</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_rescheduleLrnCard</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">conf</span><span class="p">,</span> <span class="n">delay</span><span class="o">=</span><span class="n">delay</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_rescheduleLrnCard</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">card</span><span class="p">:</span> <span class="n">Card</span><span class="p">,</span> <span class="n">conf</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">delay</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
        <span class="c1"># normal delay for the current step?</span>
        <span class="k">if</span> <span class="n">delay</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">delay</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_delayForGrade</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">card</span><span class="o">.</span><span class="n">left</span><span class="p">)</span>

        <span class="n">card</span><span class="o">.</span><span class="n">due</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">+</span> <span class="n">delay</span><span class="p">)</span>
        <span class="c1"># due today?</span>
        <span class="k">if</span> <span class="n">card</span><span class="o">.</span><span class="n">due</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">dayCutoff</span><span class="p">:</span>
            <span class="c1"># add some randomness, up to 5 minutes or 25%</span>
            <span class="n">maxExtra</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mi">300</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">delay</span> <span class="o">*</span> <span class="mf">0.25</span><span class="p">))</span>
            <span class="n">fuzz</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randrange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">maxExtra</span><span class="p">))</span>
            <span class="n">card</span><span class="o">.</span><span class="n">due</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dayCutoff</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">card</span><span class="o">.</span><span class="n">due</span> <span class="o">+</span> <span class="n">fuzz</span><span class="p">)</span>
            <span class="n">card</span><span class="o">.</span><span class="n">queue</span> <span class="o">=</span> <span class="n">QUEUE_TYPE_LRN</span>
            <span class="k">if</span> <span class="n">card</span><span class="o">.</span><span class="n">due</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">intTime</span><span class="p">()</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="o">.</span><span class="n">conf</span><span class="p">[</span><span class="s2">&quot;collapseTime&quot;</span><span class="p">]):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lrnCount</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="c1"># if the queue is not empty and there&#39;s nothing else to do, make</span>
                <span class="c1"># sure we don&#39;t put it at the head of the queue and end up showing</span>
                <span class="c1"># it twice in a row</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lrnQueue</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">revCount</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">newCount</span><span class="p">:</span>
                    <span class="n">smallestDue</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lrnQueue</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">card</span><span class="o">.</span><span class="n">due</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">card</span><span class="o">.</span><span class="n">due</span><span class="p">,</span> <span class="n">smallestDue</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">heappush</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_lrnQueue</span><span class="p">,</span> <span class="p">(</span><span class="n">card</span><span class="o">.</span><span class="n">due</span><span class="p">,</span> <span class="n">card</span><span class="o">.</span><span class="n">id</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># the card is due in one or more days, so we need to use the</span>
            <span class="c1"># day learn queue</span>
            <span class="n">ahead</span> <span class="o">=</span> <span class="p">((</span><span class="n">card</span><span class="o">.</span><span class="n">due</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">dayCutoff</span><span class="p">)</span> <span class="o">//</span> <span class="mi">86400</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="n">card</span><span class="o">.</span><span class="n">due</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">today</span> <span class="o">+</span> <span class="n">ahead</span>
            <span class="n">card</span><span class="o">.</span><span class="n">queue</span> <span class="o">=</span> <span class="n">QUEUE_TYPE_DAY_LEARN_RELEARN</span>
        <span class="k">return</span> <span class="n">delay</span>

    <span class="k">def</span> <span class="nf">_delayForGrade</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conf</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">left</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="n">left</span> <span class="o">=</span> <span class="n">left</span> <span class="o">%</span> <span class="mi">1000</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">delay</span> <span class="o">=</span> <span class="n">conf</span><span class="p">[</span><span class="s2">&quot;delays&quot;</span><span class="p">][</span><span class="o">-</span><span class="n">left</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">conf</span><span class="p">[</span><span class="s2">&quot;delays&quot;</span><span class="p">]:</span>
                <span class="n">delay</span> <span class="o">=</span> <span class="n">conf</span><span class="p">[</span><span class="s2">&quot;delays&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># user deleted final step; use dummy value</span>
                <span class="n">delay</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">delay</span> <span class="o">*</span> <span class="mi">60</span>

    <span class="k">def</span> <span class="nf">_delayForRepeatingGrade</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conf</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">left</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
        <span class="c1"># halfway between last and next</span>
        <span class="n">delay1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_delayForGrade</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">left</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">conf</span><span class="p">[</span><span class="s2">&quot;delays&quot;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">delay2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_delayForGrade</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">left</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">delay2</span> <span class="o">=</span> <span class="n">delay1</span> <span class="o">*</span> <span class="mi">2</span>
        <span class="n">avg</span> <span class="o">=</span> <span class="p">(</span><span class="n">delay1</span> <span class="o">+</span> <span class="nb">max</span><span class="p">(</span><span class="n">delay1</span><span class="p">,</span> <span class="n">delay2</span><span class="p">))</span> <span class="o">//</span> <span class="mi">2</span>
        <span class="k">return</span> <span class="n">avg</span>

    <span class="k">def</span> <span class="nf">_lrnConf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">card</span><span class="p">:</span> <span class="n">Card</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">card</span><span class="o">.</span><span class="n">type</span> <span class="ow">in</span> <span class="p">(</span><span class="n">CARD_TYPE_REV</span><span class="p">,</span> <span class="n">CARD_TYPE_RELEARNING</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lapseConf</span><span class="p">(</span><span class="n">card</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_newConf</span><span class="p">(</span><span class="n">card</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_rescheduleAsRev</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">card</span><span class="p">:</span> <span class="n">Card</span><span class="p">,</span> <span class="n">conf</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">early</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">lapse</span> <span class="o">=</span> <span class="n">card</span><span class="o">.</span><span class="n">type</span> <span class="ow">in</span> <span class="p">(</span><span class="n">CARD_TYPE_REV</span><span class="p">,</span> <span class="n">CARD_TYPE_RELEARNING</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">lapse</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_rescheduleGraduatingLapse</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">early</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_rescheduleNew</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">conf</span><span class="p">,</span> <span class="n">early</span><span class="p">)</span>

        <span class="c1"># if we were dynamic, graduating means moving back to the old deck</span>
        <span class="k">if</span> <span class="n">card</span><span class="o">.</span><span class="n">odid</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_removeFromFiltered</span><span class="p">(</span><span class="n">card</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_rescheduleGraduatingLapse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">card</span><span class="p">:</span> <span class="n">Card</span><span class="p">,</span> <span class="n">early</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">early</span><span class="p">:</span>
            <span class="n">card</span><span class="o">.</span><span class="n">ivl</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">card</span><span class="o">.</span><span class="n">due</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">today</span> <span class="o">+</span> <span class="n">card</span><span class="o">.</span><span class="n">ivl</span>
        <span class="n">card</span><span class="o">.</span><span class="n">queue</span> <span class="o">=</span> <span class="n">QUEUE_TYPE_REV</span>
        <span class="n">card</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">CARD_TYPE_REV</span>

    <span class="k">def</span> <span class="nf">_startingLeft</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">card</span><span class="p">:</span> <span class="n">Card</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">card</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">CARD_TYPE_RELEARNING</span><span class="p">:</span>
            <span class="n">conf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lapseConf</span><span class="p">(</span><span class="n">card</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">conf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lrnConf</span><span class="p">(</span><span class="n">card</span><span class="p">)</span>
        <span class="n">tot</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">conf</span><span class="p">[</span><span class="s2">&quot;delays&quot;</span><span class="p">])</span>
        <span class="n">tod</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_leftToday</span><span class="p">(</span><span class="n">conf</span><span class="p">[</span><span class="s2">&quot;delays&quot;</span><span class="p">],</span> <span class="n">tot</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">tot</span> <span class="o">+</span> <span class="n">tod</span> <span class="o">*</span> <span class="mi">1000</span>

    <span class="k">def</span> <span class="nf">_leftToday</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">delays</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">left</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">now</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="s2">&quot;The number of steps that can be completed by the day cutoff.&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">now</span><span class="p">:</span>
            <span class="n">now</span> <span class="o">=</span> <span class="n">intTime</span><span class="p">()</span>
        <span class="n">delays</span> <span class="o">=</span> <span class="n">delays</span><span class="p">[</span><span class="o">-</span><span class="n">left</span><span class="p">:]</span>
        <span class="n">ok</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">delays</span><span class="p">)):</span>
            <span class="n">now</span> <span class="o">+=</span> <span class="nb">int</span><span class="p">(</span><span class="n">delays</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">now</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">dayCutoff</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="n">ok</span> <span class="o">=</span> <span class="n">i</span>
        <span class="k">return</span> <span class="n">ok</span> <span class="o">+</span> <span class="mi">1</span>

    <span class="k">def</span> <span class="nf">_graduatingIvl</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">card</span><span class="p">:</span> <span class="n">Card</span><span class="p">,</span> <span class="n">conf</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">early</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">fuzz</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">card</span><span class="o">.</span><span class="n">type</span> <span class="ow">in</span> <span class="p">(</span><span class="n">CARD_TYPE_REV</span><span class="p">,</span> <span class="n">CARD_TYPE_RELEARNING</span><span class="p">):</span>
            <span class="n">bonus</span> <span class="o">=</span> <span class="n">early</span> <span class="ow">and</span> <span class="mi">1</span> <span class="ow">or</span> <span class="mi">0</span>
            <span class="k">return</span> <span class="n">card</span><span class="o">.</span><span class="n">ivl</span> <span class="o">+</span> <span class="n">bonus</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">early</span><span class="p">:</span>
            <span class="c1"># graduate</span>
            <span class="n">ideal</span> <span class="o">=</span> <span class="n">conf</span><span class="p">[</span><span class="s2">&quot;ints&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># early remove</span>
            <span class="n">ideal</span> <span class="o">=</span> <span class="n">conf</span><span class="p">[</span><span class="s2">&quot;ints&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">fuzz</span><span class="p">:</span>
            <span class="n">ideal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fuzzedIvl</span><span class="p">(</span><span class="n">ideal</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ideal</span>

    <span class="k">def</span> <span class="nf">_rescheduleNew</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">card</span><span class="p">:</span> <span class="n">Card</span><span class="p">,</span> <span class="n">conf</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">early</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="s2">&quot;Reschedule a new card that&#39;s graduated for the first time.&quot;</span>
        <span class="n">card</span><span class="o">.</span><span class="n">ivl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_graduatingIvl</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">conf</span><span class="p">,</span> <span class="n">early</span><span class="p">)</span>
        <span class="n">card</span><span class="o">.</span><span class="n">due</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">today</span> <span class="o">+</span> <span class="n">card</span><span class="o">.</span><span class="n">ivl</span>
        <span class="n">card</span><span class="o">.</span><span class="n">factor</span> <span class="o">=</span> <span class="n">conf</span><span class="p">[</span><span class="s2">&quot;initialFactor&quot;</span><span class="p">]</span>
        <span class="n">card</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">card</span><span class="o">.</span><span class="n">queue</span> <span class="o">=</span> <span class="n">QUEUE_TYPE_REV</span>

    <span class="k">def</span> <span class="nf">_logLrn</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">card</span><span class="p">:</span> <span class="n">Card</span><span class="p">,</span>
        <span class="n">ease</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">conf</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
        <span class="n">leaving</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
        <span class="nb">type</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">lastLeft</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">lastIvl</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_delayForGrade</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">lastLeft</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">leaving</span><span class="p">:</span>
            <span class="n">ivl</span> <span class="o">=</span> <span class="n">card</span><span class="o">.</span><span class="n">ivl</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">ease</span> <span class="o">==</span> <span class="n">BUTTON_TWO</span><span class="p">:</span>
                <span class="n">ivl</span> <span class="o">=</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">_delayForRepeatingGrade</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">card</span><span class="o">.</span><span class="n">left</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ivl</span> <span class="o">=</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">_delayForGrade</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">card</span><span class="o">.</span><span class="n">left</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">log</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
                <span class="s2">&quot;insert into revlog values (?,?,?,?,?,?,?,?,?)&quot;</span><span class="p">,</span>
                <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">),</span>
                <span class="n">card</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="o">.</span><span class="n">usn</span><span class="p">(),</span>
                <span class="n">ease</span><span class="p">,</span>
                <span class="n">ivl</span><span class="p">,</span>
                <span class="n">lastIvl</span><span class="p">,</span>
                <span class="n">card</span><span class="o">.</span><span class="n">factor</span><span class="p">,</span>
                <span class="n">card</span><span class="o">.</span><span class="n">timeTaken</span><span class="p">(),</span>
                <span class="nb">type</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">log</span><span class="p">()</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="c1"># duplicate pk; retry in 10ms</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)</span>
            <span class="n">log</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_lrnForDeck</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">did</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="n">cnt</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">scalar</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">select count() from</span>
<span class="s2">(select null from cards where did = ? and queue = </span><span class="si">{QUEUE_TYPE_LRN}</span><span class="s2"> and due &lt; ? limit ?)&quot;&quot;&quot;</span><span class="p">,</span>
                <span class="n">did</span><span class="p">,</span>
                <span class="n">intTime</span><span class="p">()</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="o">.</span><span class="n">conf</span><span class="p">[</span><span class="s2">&quot;collapseTime&quot;</span><span class="p">],</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">reportLimit</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="ow">or</span> <span class="mi">0</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">cnt</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">scalar</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">select count() from</span>
<span class="s2">(select null from cards where did = ? and queue = </span><span class="si">{QUEUE_TYPE_DAY_LEARN_RELEARN}</span><span class="s2"></span>
<span class="s2">and due &lt;= ? limit ?)&quot;&quot;&quot;</span><span class="p">,</span>
            <span class="n">did</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">today</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reportLimit</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="c1"># Reviews</span>
    <span class="c1">##########################################################################</span>

    <span class="k">def</span> <span class="nf">_currentRevLimit</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="o">.</span><span class="n">decks</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="o">.</span><span class="n">decks</span><span class="o">.</span><span class="n">selected</span><span class="p">(),</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_deckRevLimitSingle</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_deckRevLimitSingle</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">d</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">parentLimit</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="c1"># invalid deck selected?</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">d</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span>

        <span class="k">if</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;dyn&quot;</span><span class="p">]:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dynReportLimit</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="o">.</span><span class="n">decks</span><span class="o">.</span><span class="n">confForDid</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">])</span>
        <span class="n">lim</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">c</span><span class="p">[</span><span class="s2">&quot;rev&quot;</span><span class="p">][</span><span class="s2">&quot;perDay&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">counts_for_deck_today</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">review</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">parentLimit</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">lim</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">parentLimit</span><span class="p">,</span> <span class="n">lim</span><span class="p">)</span>
        <span class="k">elif</span> <span class="s2">&quot;::&quot;</span> <span class="ow">in</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]:</span>
            <span class="k">for</span> <span class="n">parent</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="o">.</span><span class="n">decks</span><span class="o">.</span><span class="n">parents</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]):</span>
                <span class="c1"># pass in dummy parentLimit so we don&#39;t do parent lookup again</span>
                <span class="n">lim</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">lim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_deckRevLimitSingle</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="n">parentLimit</span><span class="o">=</span><span class="n">lim</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">hooks</span><span class="o">.</span><span class="n">scheduler_review_limit_for_single_deck</span><span class="p">(</span><span class="n">lim</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_revForDeck</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">did</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">lim</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">childMap</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
        <span class="n">dids</span> <span class="o">=</span> <span class="p">[</span><span class="n">did</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="o">.</span><span class="n">decks</span><span class="o">.</span><span class="n">childDids</span><span class="p">(</span><span class="n">did</span><span class="p">,</span> <span class="n">childMap</span><span class="p">)</span>
        <span class="n">lim</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">lim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">reportLimit</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">scalar</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">select count() from</span>
<span class="s2">(select 1 from cards where did in </span><span class="si">%s</span><span class="s2"> and queue = </span><span class="si">{QUEUE_TYPE_REV}</span><span class="s2"></span>
<span class="s2">and due &lt;= ? limit ?)&quot;&quot;&quot;</span>
            <span class="o">%</span> <span class="n">ids2str</span><span class="p">(</span><span class="n">dids</span><span class="p">),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">today</span><span class="p">,</span>
            <span class="n">lim</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_resetRev</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_revQueue</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">_fillRev</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">recursing</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="s2">&quot;True if a review card can be fetched.&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_revQueue</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">revCount</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="n">lim</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">queueLimit</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_currentRevLimit</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">lim</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_revQueue</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">list</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">select id from cards where</span>
<span class="s2">did in </span><span class="si">%s</span><span class="s2"> and queue = </span><span class="si">{QUEUE_TYPE_REV}</span><span class="s2"> and due &lt;= ?</span>
<span class="s2">order by due, random()</span>
<span class="s2">limit ?&quot;&quot;&quot;</span>
                <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_deckLimit</span><span class="p">(),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">today</span><span class="p">,</span>
                <span class="n">lim</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_revQueue</span><span class="p">:</span>
                <span class="c1"># preserve order</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_revQueue</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>
                <span class="k">return</span> <span class="kc">True</span>

        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">_getRevCard</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Card</span><span class="p">]:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fillRev</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">revCount</span> <span class="o">-=</span> <span class="mi">1</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="o">.</span><span class="n">getCard</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_revQueue</span><span class="o">.</span><span class="n">pop</span><span class="p">())</span>
        <span class="k">return</span> <span class="kc">None</span>

<div class="viewcode-block" id="Scheduler.totalRevForCurrentDeck"><a class="viewcode-back" href="../../anki.html#anki.schedv2.Scheduler.totalRevForCurrentDeck">[docs]</a>    <span class="k">def</span> <span class="nf">totalRevForCurrentDeck</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">scalar</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">select count() from cards where id in (</span>
<span class="s2">select id from cards where did in </span><span class="si">%s</span><span class="s2"> and queue = </span><span class="si">{QUEUE_TYPE_REV}</span><span class="s2"> and due &lt;= ? limit ?)&quot;&quot;&quot;</span>
            <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_deckLimit</span><span class="p">(),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">today</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reportLimit</span><span class="p">,</span>
        <span class="p">)</span></div>

    <span class="c1"># Answering a review card</span>
    <span class="c1">##########################################################################</span>

    <span class="k">def</span> <span class="nf">_answerRevCard</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">card</span><span class="p">:</span> <span class="n">Card</span><span class="p">,</span> <span class="n">ease</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">delay</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">early</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">card</span><span class="o">.</span><span class="n">odid</span> <span class="ow">and</span> <span class="p">(</span><span class="n">card</span><span class="o">.</span><span class="n">odue</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">today</span><span class="p">))</span>
        <span class="nb">type</span> <span class="o">=</span> <span class="n">early</span> <span class="ow">and</span> <span class="n">REVLOG_CRAM</span> <span class="ow">or</span> <span class="n">REVLOG_REV</span>

        <span class="k">if</span> <span class="n">ease</span> <span class="o">==</span> <span class="n">BUTTON_ONE</span><span class="p">:</span>
            <span class="n">delay</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rescheduleLapse</span><span class="p">(</span><span class="n">card</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_rescheduleRev</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">ease</span><span class="p">,</span> <span class="n">early</span><span class="p">)</span>

        <span class="n">hooks</span><span class="o">.</span><span class="n">schedv2_did_answer_review_card</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">ease</span><span class="p">,</span> <span class="n">early</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logRev</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">ease</span><span class="p">,</span> <span class="n">delay</span><span class="p">,</span> <span class="nb">type</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_rescheduleLapse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">card</span><span class="p">:</span> <span class="n">Card</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
        <span class="n">conf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lapseConf</span><span class="p">(</span><span class="n">card</span><span class="p">)</span>

        <span class="n">card</span><span class="o">.</span><span class="n">lapses</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">card</span><span class="o">.</span><span class="n">factor</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1300</span><span class="p">,</span> <span class="n">card</span><span class="o">.</span><span class="n">factor</span> <span class="o">-</span> <span class="mi">200</span><span class="p">)</span>

        <span class="n">suspended</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_checkLeech</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">conf</span><span class="p">)</span> <span class="ow">and</span> <span class="n">card</span><span class="o">.</span><span class="n">queue</span> <span class="o">==</span> <span class="n">QUEUE_TYPE_SUSPENDED</span>

        <span class="k">if</span> <span class="n">conf</span><span class="p">[</span><span class="s2">&quot;delays&quot;</span><span class="p">]</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">suspended</span><span class="p">:</span>
            <span class="n">card</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">CARD_TYPE_RELEARNING</span>
            <span class="n">delay</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_moveToFirstStep</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">conf</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># no relearning steps</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_updateRevIvlOnFail</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">conf</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_rescheduleAsRev</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">conf</span><span class="p">,</span> <span class="n">early</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="c1"># need to reset the queue after rescheduling</span>
            <span class="k">if</span> <span class="n">suspended</span><span class="p">:</span>
                <span class="n">card</span><span class="o">.</span><span class="n">queue</span> <span class="o">=</span> <span class="n">QUEUE_TYPE_SUSPENDED</span>
            <span class="n">delay</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">return</span> <span class="n">delay</span>

    <span class="k">def</span> <span class="nf">_lapseIvl</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">card</span><span class="p">:</span> <span class="n">Card</span><span class="p">,</span> <span class="n">conf</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
        <span class="n">ivl</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">conf</span><span class="p">[</span><span class="s2">&quot;minInt&quot;</span><span class="p">],</span> <span class="nb">int</span><span class="p">(</span><span class="n">card</span><span class="o">.</span><span class="n">ivl</span> <span class="o">*</span> <span class="n">conf</span><span class="p">[</span><span class="s2">&quot;mult&quot;</span><span class="p">]))</span>
        <span class="k">return</span> <span class="n">ivl</span>

    <span class="k">def</span> <span class="nf">_rescheduleRev</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">card</span><span class="p">:</span> <span class="n">Card</span><span class="p">,</span> <span class="n">ease</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">early</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># update interval</span>
        <span class="n">card</span><span class="o">.</span><span class="n">lastIvl</span> <span class="o">=</span> <span class="n">card</span><span class="o">.</span><span class="n">ivl</span>
        <span class="k">if</span> <span class="n">early</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_updateEarlyRevIvl</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">ease</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_updateRevIvl</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">ease</span><span class="p">)</span>

        <span class="c1"># then the rest</span>
        <span class="n">card</span><span class="o">.</span><span class="n">factor</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1300</span><span class="p">,</span> <span class="n">card</span><span class="o">.</span><span class="n">factor</span> <span class="o">+</span> <span class="p">[</span><span class="o">-</span><span class="mi">150</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">150</span><span class="p">][</span><span class="n">ease</span> <span class="o">-</span> <span class="mi">2</span><span class="p">])</span>
        <span class="n">card</span><span class="o">.</span><span class="n">due</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">today</span> <span class="o">+</span> <span class="n">card</span><span class="o">.</span><span class="n">ivl</span>

        <span class="c1"># card leaves filtered deck</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_removeFromFiltered</span><span class="p">(</span><span class="n">card</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_logRev</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">card</span><span class="p">:</span> <span class="n">Card</span><span class="p">,</span> <span class="n">ease</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">delay</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">type</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">def</span> <span class="nf">log</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
                <span class="s2">&quot;insert into revlog values (?,?,?,?,?,?,?,?,?)&quot;</span><span class="p">,</span>
                <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">),</span>
                <span class="n">card</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="o">.</span><span class="n">usn</span><span class="p">(),</span>
                <span class="n">ease</span><span class="p">,</span>
                <span class="o">-</span><span class="n">delay</span> <span class="ow">or</span> <span class="n">card</span><span class="o">.</span><span class="n">ivl</span><span class="p">,</span>
                <span class="n">card</span><span class="o">.</span><span class="n">lastIvl</span><span class="p">,</span>
                <span class="n">card</span><span class="o">.</span><span class="n">factor</span><span class="p">,</span>
                <span class="n">card</span><span class="o">.</span><span class="n">timeTaken</span><span class="p">(),</span>
                <span class="nb">type</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">log</span><span class="p">()</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="c1"># duplicate pk; retry in 10ms</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)</span>
            <span class="n">log</span><span class="p">()</span>

    <span class="c1"># Interval management</span>
    <span class="c1">##########################################################################</span>

    <span class="k">def</span> <span class="nf">_nextRevIvl</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">card</span><span class="p">:</span> <span class="n">Card</span><span class="p">,</span> <span class="n">ease</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">fuzz</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="s2">&quot;Next review interval for CARD, given EASE.&quot;</span>
        <span class="n">delay</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_daysLate</span><span class="p">(</span><span class="n">card</span><span class="p">)</span>
        <span class="n">conf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_revConf</span><span class="p">(</span><span class="n">card</span><span class="p">)</span>
        <span class="n">fct</span> <span class="o">=</span> <span class="n">card</span><span class="o">.</span><span class="n">factor</span> <span class="o">/</span> <span class="mi">1000</span>
        <span class="n">hardFactor</span> <span class="o">=</span> <span class="n">conf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;hardFactor&quot;</span><span class="p">,</span> <span class="mf">1.2</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">hardFactor</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">hardMin</span> <span class="o">=</span> <span class="n">card</span><span class="o">.</span><span class="n">ivl</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">hardMin</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">ivl2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_constrainedIvl</span><span class="p">(</span><span class="n">card</span><span class="o">.</span><span class="n">ivl</span> <span class="o">*</span> <span class="n">hardFactor</span><span class="p">,</span> <span class="n">conf</span><span class="p">,</span> <span class="n">hardMin</span><span class="p">,</span> <span class="n">fuzz</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ease</span> <span class="o">==</span> <span class="n">BUTTON_TWO</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">ivl2</span>

        <span class="n">ivl3</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_constrainedIvl</span><span class="p">((</span><span class="n">card</span><span class="o">.</span><span class="n">ivl</span> <span class="o">+</span> <span class="n">delay</span> <span class="o">//</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">fct</span><span class="p">,</span> <span class="n">conf</span><span class="p">,</span> <span class="n">ivl2</span><span class="p">,</span> <span class="n">fuzz</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ease</span> <span class="o">==</span> <span class="n">BUTTON_THREE</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">ivl3</span>

        <span class="n">ivl4</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_constrainedIvl</span><span class="p">(</span>
            <span class="p">(</span><span class="n">card</span><span class="o">.</span><span class="n">ivl</span> <span class="o">+</span> <span class="n">delay</span><span class="p">)</span> <span class="o">*</span> <span class="n">fct</span> <span class="o">*</span> <span class="n">conf</span><span class="p">[</span><span class="s2">&quot;ease4&quot;</span><span class="p">],</span> <span class="n">conf</span><span class="p">,</span> <span class="n">ivl3</span><span class="p">,</span> <span class="n">fuzz</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">ivl4</span>

    <span class="k">def</span> <span class="nf">_fuzzedIvl</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ivl</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="nb">min</span><span class="p">,</span> <span class="nb">max</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fuzzIvlRange</span><span class="p">(</span><span class="n">ivl</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="nb">min</span><span class="p">,</span> <span class="nb">max</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_fuzzIvlRange</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ivl</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">ivl</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">ivl</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">ivl</span> <span class="o">&lt;</span> <span class="mi">7</span><span class="p">:</span>
            <span class="n">fuzz</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ivl</span> <span class="o">*</span> <span class="mf">0.25</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">ivl</span> <span class="o">&lt;</span> <span class="mi">30</span><span class="p">:</span>
            <span class="n">fuzz</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">ivl</span> <span class="o">*</span> <span class="mf">0.15</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fuzz</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">ivl</span> <span class="o">*</span> <span class="mf">0.05</span><span class="p">))</span>
        <span class="c1"># fuzz at least a day</span>
        <span class="n">fuzz</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">fuzz</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">ivl</span> <span class="o">-</span> <span class="n">fuzz</span><span class="p">,</span> <span class="n">ivl</span> <span class="o">+</span> <span class="n">fuzz</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_constrainedIvl</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">ivl</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">conf</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">prev</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">fuzz</span><span class="p">:</span> <span class="nb">bool</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="n">ivl</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ivl</span> <span class="o">*</span> <span class="n">conf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;ivlFct&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">fuzz</span><span class="p">:</span>
            <span class="n">ivl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fuzzedIvl</span><span class="p">(</span><span class="n">ivl</span><span class="p">)</span>
        <span class="n">ivl</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">ivl</span><span class="p">,</span> <span class="n">prev</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">ivl</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">ivl</span><span class="p">,</span> <span class="n">conf</span><span class="p">[</span><span class="s2">&quot;maxIvl&quot;</span><span class="p">])</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">ivl</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_daysLate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">card</span><span class="p">:</span> <span class="n">Card</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="s2">&quot;Number of days later than scheduled.&quot;</span>
        <span class="n">due</span> <span class="o">=</span> <span class="n">card</span><span class="o">.</span><span class="n">odue</span> <span class="k">if</span> <span class="n">card</span><span class="o">.</span><span class="n">odid</span> <span class="k">else</span> <span class="n">card</span><span class="o">.</span><span class="n">due</span>
        <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">today</span> <span class="o">-</span> <span class="n">due</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_updateRevIvl</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">card</span><span class="p">:</span> <span class="n">Card</span><span class="p">,</span> <span class="n">ease</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">card</span><span class="o">.</span><span class="n">ivl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nextRevIvl</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">ease</span><span class="p">,</span> <span class="n">fuzz</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_updateEarlyRevIvl</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">card</span><span class="p">:</span> <span class="n">Card</span><span class="p">,</span> <span class="n">ease</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">card</span><span class="o">.</span><span class="n">ivl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_earlyReviewIvl</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">ease</span><span class="p">)</span>

    <span class="c1"># next interval for card when answered early+correctly</span>
    <span class="k">def</span> <span class="nf">_earlyReviewIvl</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">card</span><span class="p">:</span> <span class="n">Card</span><span class="p">,</span> <span class="n">ease</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">card</span><span class="o">.</span><span class="n">odid</span> <span class="ow">and</span> <span class="n">card</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">CARD_TYPE_REV</span>
        <span class="k">assert</span> <span class="n">card</span><span class="o">.</span><span class="n">factor</span>
        <span class="k">assert</span> <span class="n">ease</span> <span class="o">&gt;</span> <span class="mi">1</span>

        <span class="n">elapsed</span> <span class="o">=</span> <span class="n">card</span><span class="o">.</span><span class="n">ivl</span> <span class="o">-</span> <span class="p">(</span><span class="n">card</span><span class="o">.</span><span class="n">odue</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">today</span><span class="p">)</span>

        <span class="n">conf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_revConf</span><span class="p">(</span><span class="n">card</span><span class="p">)</span>

        <span class="n">easyBonus</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="c1"># early 3/4 reviews shouldn&#39;t decrease previous interval</span>
        <span class="n">minNewIvl</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="n">ease</span> <span class="o">==</span> <span class="n">BUTTON_TWO</span><span class="p">:</span>
            <span class="n">factor</span> <span class="o">=</span> <span class="n">conf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;hardFactor&quot;</span><span class="p">,</span> <span class="mf">1.2</span><span class="p">)</span>
            <span class="c1"># hard cards shouldn&#39;t have their interval decreased by more than 50%</span>
            <span class="c1"># of the normal factor</span>
            <span class="n">minNewIvl</span> <span class="o">=</span> <span class="n">factor</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="k">elif</span> <span class="n">ease</span> <span class="o">==</span> <span class="n">BUTTON_THREE</span><span class="p">:</span>
            <span class="n">factor</span> <span class="o">=</span> <span class="n">card</span><span class="o">.</span><span class="n">factor</span> <span class="o">/</span> <span class="mi">1000</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># ease == BUTTON_FOUR:</span>
            <span class="n">factor</span> <span class="o">=</span> <span class="n">card</span><span class="o">.</span><span class="n">factor</span> <span class="o">/</span> <span class="mi">1000</span>
            <span class="n">ease4</span> <span class="o">=</span> <span class="n">conf</span><span class="p">[</span><span class="s2">&quot;ease4&quot;</span><span class="p">]</span>
            <span class="c1"># 1.3 -&gt; 1.15</span>
            <span class="n">easyBonus</span> <span class="o">=</span> <span class="n">ease4</span> <span class="o">-</span> <span class="p">(</span><span class="n">ease4</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>

        <span class="n">ivl</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">elapsed</span> <span class="o">*</span> <span class="n">factor</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="c1"># cap interval decreases</span>
        <span class="n">ivl</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">card</span><span class="o">.</span><span class="n">ivl</span> <span class="o">*</span> <span class="n">minNewIvl</span><span class="p">,</span> <span class="n">ivl</span><span class="p">)</span> <span class="o">*</span> <span class="n">easyBonus</span>

        <span class="n">ivl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_constrainedIvl</span><span class="p">(</span><span class="n">ivl</span><span class="p">,</span> <span class="n">conf</span><span class="p">,</span> <span class="n">prev</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">fuzz</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">ivl</span>

    <span class="c1"># Dynamic deck handling</span>
    <span class="c1">##########################################################################</span>

    <span class="n">_restoreQueueWhenEmptyingSnippet</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">queue = (case when queue &lt; 0 then queue</span>
<span class="s2">              when type in (1,</span><span class="si">{CARD_TYPE_RELEARNING}</span><span class="s2">) then</span>
<span class="s2">  (case when (case when odue then odue else due end) &gt; 1000000000 then 1 else</span>
<span class="s2">  </span><span class="si">{QUEUE_TYPE_DAY_LEARN_RELEARN}</span><span class="s2"> end)</span>
<span class="s2">else</span>
<span class="s2">  type</span>
<span class="s2">end)</span>
<span class="s2">&quot;&quot;&quot;</span>

<div class="viewcode-block" id="Scheduler.rebuildDyn"><a class="viewcode-back" href="../../anki.html#anki.schedv2.Scheduler.rebuildDyn">[docs]</a>    <span class="k">def</span> <span class="nf">rebuildDyn</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">did</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
        <span class="s2">&quot;Rebuild a dynamic deck.&quot;</span>
        <span class="n">did</span> <span class="o">=</span> <span class="n">did</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="o">.</span><span class="n">decks</span><span class="o">.</span><span class="n">selected</span><span class="p">()</span>
        <span class="n">deck</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="o">.</span><span class="n">decks</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">did</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">deck</span><span class="p">[</span><span class="s2">&quot;dyn&quot;</span><span class="p">]</span>
        <span class="c1"># move any existing cards back first, then fill</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">emptyDyn</span><span class="p">(</span><span class="n">did</span><span class="p">)</span>
        <span class="n">cnt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fillDyn</span><span class="p">(</span><span class="n">deck</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">cnt</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="c1"># and change to our new deck</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="o">.</span><span class="n">decks</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">did</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">cnt</span></div>

    <span class="k">def</span> <span class="nf">_fillDyn</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">deck</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="n">start</span> <span class="o">=</span> <span class="o">-</span><span class="mi">100000</span>
        <span class="n">total</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">search</span><span class="p">,</span> <span class="n">limit</span><span class="p">,</span> <span class="n">order</span> <span class="ow">in</span> <span class="n">deck</span><span class="p">[</span><span class="s2">&quot;terms&quot;</span><span class="p">]:</span>
            <span class="n">orderlimit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dynOrder</span><span class="p">(</span><span class="n">order</span><span class="p">,</span> <span class="n">limit</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">search</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
                <span class="n">search</span> <span class="o">=</span> <span class="s2">&quot;(</span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="n">search</span>
            <span class="n">search</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> -is:suspended -is:buried -deck:filtered&quot;</span> <span class="o">%</span> <span class="n">search</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="o">.</span><span class="n">findCards</span><span class="p">(</span><span class="n">search</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="n">orderlimit</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">total</span>
            <span class="c1"># move the cards over</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">deck</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">],</span> <span class="n">ids</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_moveToDyn</span><span class="p">(</span><span class="n">deck</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">],</span> <span class="n">ids</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="n">start</span> <span class="o">+</span> <span class="n">total</span><span class="p">)</span>
            <span class="n">total</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ids</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">total</span>

<div class="viewcode-block" id="Scheduler.emptyDyn"><a class="viewcode-back" href="../../anki.html#anki.schedv2.Scheduler.emptyDyn">[docs]</a>    <span class="k">def</span> <span class="nf">emptyDyn</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">did</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">lim</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">lim</span><span class="p">:</span>
            <span class="n">lim</span> <span class="o">=</span> <span class="s2">&quot;did = </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">did</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">list</span><span class="p">(</span><span class="s2">&quot;select id from cards where </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">lim</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">update cards set did = odid, %s,</span>
<span class="sd">due = (case when odue&gt;0 then odue else due end), odue = 0, odid = 0, usn = ? where %s&quot;&quot;&quot;</span>
            <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_restoreQueueWhenEmptyingSnippet</span><span class="p">,</span> <span class="n">lim</span><span class="p">),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="o">.</span><span class="n">usn</span><span class="p">(),</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="Scheduler.remFromDyn"><a class="viewcode-back" href="../../anki.html#anki.schedv2.Scheduler.remFromDyn">[docs]</a>    <span class="k">def</span> <span class="nf">remFromDyn</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cids</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">emptyDyn</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;id in </span><span class="si">%s</span><span class="s2"> and odid&quot;</span> <span class="o">%</span> <span class="n">ids2str</span><span class="p">(</span><span class="n">cids</span><span class="p">))</span></div>

    <span class="k">def</span> <span class="nf">_dynOrder</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">o</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">l</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">o</span> <span class="o">==</span> <span class="n">DYN_OLDEST</span><span class="p">:</span>
            <span class="n">t</span> <span class="o">=</span> <span class="s2">&quot;(select max(id) from revlog where cid=c.id)&quot;</span>
        <span class="k">elif</span> <span class="n">o</span> <span class="o">==</span> <span class="n">DYN_RANDOM</span><span class="p">:</span>
            <span class="n">t</span> <span class="o">=</span> <span class="s2">&quot;random()&quot;</span>
        <span class="k">elif</span> <span class="n">o</span> <span class="o">==</span> <span class="n">DYN_SMALLINT</span><span class="p">:</span>
            <span class="n">t</span> <span class="o">=</span> <span class="s2">&quot;ivl&quot;</span>
        <span class="k">elif</span> <span class="n">o</span> <span class="o">==</span> <span class="n">DYN_BIGINT</span><span class="p">:</span>
            <span class="n">t</span> <span class="o">=</span> <span class="s2">&quot;ivl desc&quot;</span>
        <span class="k">elif</span> <span class="n">o</span> <span class="o">==</span> <span class="n">DYN_LAPSES</span><span class="p">:</span>
            <span class="n">t</span> <span class="o">=</span> <span class="s2">&quot;lapses desc&quot;</span>
        <span class="k">elif</span> <span class="n">o</span> <span class="o">==</span> <span class="n">DYN_ADDED</span><span class="p">:</span>
            <span class="n">t</span> <span class="o">=</span> <span class="s2">&quot;n.id&quot;</span>
        <span class="k">elif</span> <span class="n">o</span> <span class="o">==</span> <span class="n">DYN_REVADDED</span><span class="p">:</span>
            <span class="n">t</span> <span class="o">=</span> <span class="s2">&quot;n.id desc&quot;</span>
        <span class="k">elif</span> <span class="n">o</span> <span class="o">==</span> <span class="n">DYN_DUEPRIORITY</span><span class="p">:</span>
            <span class="n">t</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;(case when queue=</span><span class="si">{QUEUE_TYPE_REV}</span><span class="s2"> and due &lt;= </span><span class="si">%d</span><span class="s2"> then (ivl / cast(</span><span class="si">%d</span><span class="s2">-due+0.001 as real)) else 100000+due end)&quot;</span>
                <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">today</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">today</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># DYN_DUE or unknown</span>
            <span class="n">t</span> <span class="o">=</span> <span class="s2">&quot;c.due, c.ord&quot;</span>
        <span class="k">return</span> <span class="n">t</span> <span class="o">+</span> <span class="s2">&quot; limit </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">l</span>

    <span class="k">def</span> <span class="nf">_moveToDyn</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">did</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">ids</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">start</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="o">-</span><span class="mi">100000</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">deck</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="o">.</span><span class="n">decks</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">did</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">u</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="o">.</span><span class="n">usn</span><span class="p">()</span>
        <span class="n">due</span> <span class="o">=</span> <span class="n">start</span>
        <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="n">ids</span><span class="p">:</span>
            <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">did</span><span class="p">,</span> <span class="n">due</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="nb">id</span><span class="p">))</span>
            <span class="n">due</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="n">queue</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">deck</span><span class="p">[</span><span class="s2">&quot;resched&quot;</span><span class="p">]:</span>
            <span class="n">queue</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;,queue=</span><span class="si">{QUEUE_TYPE_REV}</span><span class="s2">&quot;</span>

        <span class="n">query</span> <span class="o">=</span> <span class="p">(</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">update cards set</span>
<span class="sd">odid = did, odue = due,</span>
<span class="sd">did = ?,</span>
<span class="sd">due = (case when due &lt;= 0 then due else ? end),</span>
<span class="sd">usn = ?</span>
<span class="sd">%s</span>
<span class="sd">where id = ?</span>
<span class="sd">&quot;&quot;&quot;</span>
            <span class="o">%</span> <span class="n">queue</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">executemany</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_removeFromFiltered</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">card</span><span class="p">:</span> <span class="n">Card</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">card</span><span class="o">.</span><span class="n">odid</span><span class="p">:</span>
            <span class="n">card</span><span class="o">.</span><span class="n">did</span> <span class="o">=</span> <span class="n">card</span><span class="o">.</span><span class="n">odid</span>
            <span class="n">card</span><span class="o">.</span><span class="n">odue</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">card</span><span class="o">.</span><span class="n">odid</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">_restorePreviewCard</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">card</span><span class="p">:</span> <span class="n">Card</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">card</span><span class="o">.</span><span class="n">odid</span>

        <span class="n">card</span><span class="o">.</span><span class="n">due</span> <span class="o">=</span> <span class="n">card</span><span class="o">.</span><span class="n">odue</span>

        <span class="c1"># learning and relearning cards may be seconds-based or day-based;</span>
        <span class="c1"># other types map directly to queues</span>
        <span class="k">if</span> <span class="n">card</span><span class="o">.</span><span class="n">type</span> <span class="ow">in</span> <span class="p">(</span><span class="n">CARD_TYPE_LRN</span><span class="p">,</span> <span class="n">CARD_TYPE_RELEARNING</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">card</span><span class="o">.</span><span class="n">odue</span> <span class="o">&gt;</span> <span class="mi">1000000000</span><span class="p">:</span>
                <span class="n">card</span><span class="o">.</span><span class="n">queue</span> <span class="o">=</span> <span class="n">QUEUE_TYPE_LRN</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">card</span><span class="o">.</span><span class="n">queue</span> <span class="o">=</span> <span class="n">QUEUE_TYPE_DAY_LEARN_RELEARN</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">card</span><span class="o">.</span><span class="n">queue</span> <span class="o">=</span> <span class="n">card</span><span class="o">.</span><span class="n">type</span>

    <span class="c1"># Leeches</span>
    <span class="c1">##########################################################################</span>

    <span class="k">def</span> <span class="nf">_checkLeech</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">card</span><span class="p">:</span> <span class="n">Card</span><span class="p">,</span> <span class="n">conf</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="s2">&quot;Leech handler. True if card was a leech.&quot;</span>
        <span class="n">lf</span> <span class="o">=</span> <span class="n">conf</span><span class="p">[</span><span class="s2">&quot;leechFails&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">lf</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="c1"># if over threshold or every half threshold reps after that</span>
        <span class="k">if</span> <span class="n">card</span><span class="o">.</span><span class="n">lapses</span> <span class="o">&gt;=</span> <span class="n">lf</span> <span class="ow">and</span> <span class="p">(</span><span class="n">card</span><span class="o">.</span><span class="n">lapses</span> <span class="o">-</span> <span class="n">lf</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">lf</span> <span class="o">//</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># add a leech tag</span>
            <span class="n">f</span> <span class="o">=</span> <span class="n">card</span><span class="o">.</span><span class="n">note</span><span class="p">()</span>
            <span class="n">f</span><span class="o">.</span><span class="n">addTag</span><span class="p">(</span><span class="s2">&quot;leech&quot;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
            <span class="c1"># handle</span>
            <span class="n">a</span> <span class="o">=</span> <span class="n">conf</span><span class="p">[</span><span class="s2">&quot;leechAction&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">a</span> <span class="o">==</span> <span class="n">LEECH_SUSPEND</span><span class="p">:</span>
                <span class="n">card</span><span class="o">.</span><span class="n">queue</span> <span class="o">=</span> <span class="n">QUEUE_TYPE_SUSPENDED</span>
            <span class="c1"># notify UI</span>
            <span class="n">hooks</span><span class="o">.</span><span class="n">card_did_leech</span><span class="p">(</span><span class="n">card</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="c1"># Tools</span>
    <span class="c1">##########################################################################</span>

    <span class="k">def</span> <span class="nf">_cardConf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">card</span><span class="p">:</span> <span class="n">Card</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="o">.</span><span class="n">decks</span><span class="o">.</span><span class="n">confForDid</span><span class="p">(</span><span class="n">card</span><span class="o">.</span><span class="n">did</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_newConf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">card</span><span class="p">:</span> <span class="n">Card</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
        <span class="n">conf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cardConf</span><span class="p">(</span><span class="n">card</span><span class="p">)</span>
        <span class="c1"># normal deck</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">card</span><span class="o">.</span><span class="n">odid</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">conf</span><span class="p">[</span><span class="s2">&quot;new&quot;</span><span class="p">]</span>
        <span class="c1"># dynamic deck; override some attributes, use original deck for others</span>
        <span class="n">oconf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="o">.</span><span class="n">decks</span><span class="o">.</span><span class="n">confForDid</span><span class="p">(</span><span class="n">card</span><span class="o">.</span><span class="n">odid</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="c1"># original deck</span>
            <span class="n">ints</span><span class="o">=</span><span class="n">oconf</span><span class="p">[</span><span class="s2">&quot;new&quot;</span><span class="p">][</span><span class="s2">&quot;ints&quot;</span><span class="p">],</span>
            <span class="n">initialFactor</span><span class="o">=</span><span class="n">oconf</span><span class="p">[</span><span class="s2">&quot;new&quot;</span><span class="p">][</span><span class="s2">&quot;initialFactor&quot;</span><span class="p">],</span>
            <span class="n">bury</span><span class="o">=</span><span class="n">oconf</span><span class="p">[</span><span class="s2">&quot;new&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;bury&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">),</span>
            <span class="n">delays</span><span class="o">=</span><span class="n">oconf</span><span class="p">[</span><span class="s2">&quot;new&quot;</span><span class="p">][</span><span class="s2">&quot;delays&quot;</span><span class="p">],</span>
            <span class="c1"># overrides</span>
            <span class="n">order</span><span class="o">=</span><span class="n">NEW_CARDS_DUE</span><span class="p">,</span>
            <span class="n">perDay</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">reportLimit</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_lapseConf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">card</span><span class="p">:</span> <span class="n">Card</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
        <span class="n">conf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cardConf</span><span class="p">(</span><span class="n">card</span><span class="p">)</span>
        <span class="c1"># normal deck</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">card</span><span class="o">.</span><span class="n">odid</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">conf</span><span class="p">[</span><span class="s2">&quot;lapse&quot;</span><span class="p">]</span>
        <span class="c1"># dynamic deck; override some attributes, use original deck for others</span>
        <span class="n">oconf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="o">.</span><span class="n">decks</span><span class="o">.</span><span class="n">confForDid</span><span class="p">(</span><span class="n">card</span><span class="o">.</span><span class="n">odid</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="c1"># original deck</span>
            <span class="n">minInt</span><span class="o">=</span><span class="n">oconf</span><span class="p">[</span><span class="s2">&quot;lapse&quot;</span><span class="p">][</span><span class="s2">&quot;minInt&quot;</span><span class="p">],</span>
            <span class="n">leechFails</span><span class="o">=</span><span class="n">oconf</span><span class="p">[</span><span class="s2">&quot;lapse&quot;</span><span class="p">][</span><span class="s2">&quot;leechFails&quot;</span><span class="p">],</span>
            <span class="n">leechAction</span><span class="o">=</span><span class="n">oconf</span><span class="p">[</span><span class="s2">&quot;lapse&quot;</span><span class="p">][</span><span class="s2">&quot;leechAction&quot;</span><span class="p">],</span>
            <span class="n">mult</span><span class="o">=</span><span class="n">oconf</span><span class="p">[</span><span class="s2">&quot;lapse&quot;</span><span class="p">][</span><span class="s2">&quot;mult&quot;</span><span class="p">],</span>
            <span class="n">delays</span><span class="o">=</span><span class="n">oconf</span><span class="p">[</span><span class="s2">&quot;lapse&quot;</span><span class="p">][</span><span class="s2">&quot;delays&quot;</span><span class="p">],</span>
            <span class="c1"># overrides</span>
            <span class="n">resched</span><span class="o">=</span><span class="n">conf</span><span class="p">[</span><span class="s2">&quot;resched&quot;</span><span class="p">],</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_revConf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">card</span><span class="p">:</span> <span class="n">Card</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="n">conf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cardConf</span><span class="p">(</span><span class="n">card</span><span class="p">)</span>
        <span class="c1"># normal deck</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">card</span><span class="o">.</span><span class="n">odid</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">conf</span><span class="p">[</span><span class="s2">&quot;rev&quot;</span><span class="p">]</span>
        <span class="c1"># dynamic deck</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="o">.</span><span class="n">decks</span><span class="o">.</span><span class="n">confForDid</span><span class="p">(</span><span class="n">card</span><span class="o">.</span><span class="n">odid</span><span class="p">)[</span><span class="s2">&quot;rev&quot;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_deckLimit</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">ids2str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="o">.</span><span class="n">decks</span><span class="o">.</span><span class="n">active</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">_previewingCard</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">card</span><span class="p">:</span> <span class="n">Card</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
        <span class="n">conf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cardConf</span><span class="p">(</span><span class="n">card</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">conf</span><span class="p">[</span><span class="s2">&quot;dyn&quot;</span><span class="p">]</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">conf</span><span class="p">[</span><span class="s2">&quot;resched&quot;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_previewDelay</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">card</span><span class="p">:</span> <span class="n">Card</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cardConf</span><span class="p">(</span><span class="n">card</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;previewDelay&quot;</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span> <span class="o">*</span> <span class="mi">60</span>

    <span class="c1"># Daily cutoff</span>
    <span class="c1">##########################################################################</span>

    <span class="k">def</span> <span class="nf">_updateCutoff</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">oldToday</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">today</span>
        <span class="n">timing</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_timing_today</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">today</span> <span class="o">=</span> <span class="n">timing</span><span class="o">.</span><span class="n">days_elapsed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dayCutoff</span> <span class="o">=</span> <span class="n">timing</span><span class="o">.</span><span class="n">next_day_at</span>

        <span class="c1"># unbury if the day has rolled over</span>
        <span class="n">unburied</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;lastUnburied&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">unburied</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">today</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">today</span> <span class="o">+</span> <span class="mi">7</span> <span class="o">&lt;</span> <span class="n">unburied</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">unburyCards</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="o">.</span><span class="n">conf</span><span class="p">[</span><span class="s2">&quot;lastUnburied&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">today</span>

    <span class="k">def</span> <span class="nf">_checkDay</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># check if the day has rolled over</span>
        <span class="k">if</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">dayCutoff</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_timing_today</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SchedTimingToday</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="o">.</span><span class="n">backend</span><span class="o">.</span><span class="n">sched_timing_today</span><span class="p">()</span>

    <span class="c1"># Deck finished state</span>
    <span class="c1">##########################################################################</span>

<div class="viewcode-block" id="Scheduler.finishedMsg"><a class="viewcode-back" href="../../anki.html#anki.schedv2.Scheduler.finishedMsg">[docs]</a>    <span class="k">def</span> <span class="nf">finishedMsg</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="s2">&quot;&lt;b&gt;&quot;</span>
            <span class="o">+</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Congratulations! You have finished this deck for now.&quot;</span><span class="p">)</span>
            <span class="o">+</span> <span class="s2">&quot;&lt;/b&gt;&lt;br&gt;&lt;br&gt;&quot;</span>
            <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nextDueMsg</span><span class="p">()</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="Scheduler.next_learn_msg"><a class="viewcode-back" href="../../anki.html#anki.schedv2.Scheduler.next_learn_msg">[docs]</a>    <span class="k">def</span> <span class="nf">next_learn_msg</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">dids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_deckLimit</span><span class="p">()</span>
        <span class="p">(</span><span class="nb">next</span><span class="p">,</span> <span class="n">remaining</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">first</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">select min(due), count(*)</span>
<span class="s2">from cards where did in </span><span class="si">{dids}</span><span class="s2"> and queue = </span><span class="si">{QUEUE_TYPE_LRN}</span><span class="s2"></span>
<span class="s2">&quot;&quot;&quot;</span>
        <span class="p">)</span>
        <span class="nb">next</span> <span class="o">=</span> <span class="nb">next</span> <span class="ow">or</span> <span class="mi">0</span>
        <span class="n">remaining</span> <span class="o">=</span> <span class="n">remaining</span> <span class="ow">or</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="nb">next</span> <span class="ow">and</span> <span class="nb">next</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">dayCutoff</span><span class="p">:</span>
            <span class="nb">next</span> <span class="o">-=</span> <span class="n">intTime</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="o">.</span><span class="n">conf</span><span class="p">[</span><span class="s2">&quot;collapseTime&quot;</span><span class="p">]</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="o">.</span><span class="n">backend</span><span class="o">.</span><span class="n">congrats_learn_message</span><span class="p">(</span>
                <span class="n">next_due</span><span class="o">=</span><span class="nb">abs</span><span class="p">(</span><span class="nb">next</span><span class="p">),</span> <span class="n">remaining</span><span class="o">=</span><span class="n">remaining</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;&quot;</span></div>

    <span class="k">def</span> <span class="nf">_nextDueMsg</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">line</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">learn_msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">next_learn_msg</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">learn_msg</span><span class="p">:</span>
            <span class="n">line</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">learn_msg</span><span class="p">)</span>

        <span class="c1"># the new line replacements are so we don&#39;t break translations</span>
        <span class="c1"># in a point release</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">revDue</span><span class="p">():</span>
            <span class="n">line</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">_</span><span class="p">(</span>
                    <span class="sd">&quot;&quot;&quot;\</span>
<span class="sd">Today&#39;s review limit has been reached, but there are still cards</span>
<span class="sd">waiting to be reviewed. For optimum memory, consider increasing</span>
<span class="sd">the daily limit in the options.&quot;&quot;&quot;</span>
                <span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">newDue</span><span class="p">():</span>
            <span class="n">line</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">_</span><span class="p">(</span>
                    <span class="sd">&quot;&quot;&quot;\</span>
<span class="sd">There are more new cards available, but the daily limit has been</span>
<span class="sd">reached. You can increase the limit in the options, but please</span>
<span class="sd">bear in mind that the more new cards you introduce, the higher</span>
<span class="sd">your short-term review workload will become.&quot;&quot;&quot;</span>
                <span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">haveBuried</span><span class="p">():</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">haveCustomStudy</span><span class="p">:</span>
                <span class="n">now</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;To see them now, click the Unbury button below.&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">now</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="n">line</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">_</span><span class="p">(</span>
                    <span class="sd">&quot;&quot;&quot;\</span>
<span class="sd">Some related or buried cards were delayed until a later session.&quot;&quot;&quot;</span>
                <span class="p">)</span>
                <span class="o">+</span> <span class="n">now</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">haveCustomStudy</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="o">.</span><span class="n">decks</span><span class="o">.</span><span class="n">current</span><span class="p">()[</span><span class="s2">&quot;dyn&quot;</span><span class="p">]:</span>
            <span class="n">line</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">_</span><span class="p">(</span>
                    <span class="sd">&quot;&quot;&quot;\</span>
<span class="sd">To study outside of the normal schedule, click the Custom Study button below.&quot;&quot;&quot;</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="s2">&quot;&lt;p&gt;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

<div class="viewcode-block" id="Scheduler.revDue"><a class="viewcode-back" href="../../anki.html#anki.schedv2.Scheduler.revDue">[docs]</a>    <span class="k">def</span> <span class="nf">revDue</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
        <span class="s2">&quot;True if there are any rev cards due.&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">scalar</span><span class="p">(</span>
            <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;select 1 from cards where did in </span><span class="si">%s</span><span class="s2"> and queue = </span><span class="si">{QUEUE_TYPE_REV}</span><span class="s2"> &quot;</span>
                <span class="s2">&quot;and due &lt;= ? limit 1&quot;</span>
            <span class="p">)</span>
            <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_deckLimit</span><span class="p">(),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">today</span><span class="p">,</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="Scheduler.newDue"><a class="viewcode-back" href="../../anki.html#anki.schedv2.Scheduler.newDue">[docs]</a>    <span class="k">def</span> <span class="nf">newDue</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
        <span class="s2">&quot;True if there are any new cards due.&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">scalar</span><span class="p">(</span>
            <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;select 1 from cards where did in </span><span class="si">%s</span><span class="s2"> and queue = </span><span class="si">{QUEUE_TYPE_NEW}</span><span class="s2"> &quot;</span>
                <span class="s2">&quot;limit 1&quot;</span>
            <span class="p">)</span>
            <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_deckLimit</span><span class="p">()</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="Scheduler.haveBuriedSiblings"><a class="viewcode-back" href="../../anki.html#anki.schedv2.Scheduler.haveBuriedSiblings">[docs]</a>    <span class="k">def</span> <span class="nf">haveBuriedSiblings</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="n">cnt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">scalar</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;select 1 from cards where queue = </span><span class="si">{QUEUE_TYPE_SIBLING_BURIED}</span><span class="s2"> and did in </span><span class="si">%s</span><span class="s2"> limit 1&quot;</span>
            <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_deckLimit</span><span class="p">()</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="ow">not</span> <span class="ow">not</span> <span class="n">cnt</span></div>

<div class="viewcode-block" id="Scheduler.haveManuallyBuried"><a class="viewcode-back" href="../../anki.html#anki.schedv2.Scheduler.haveManuallyBuried">[docs]</a>    <span class="k">def</span> <span class="nf">haveManuallyBuried</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="n">cnt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">scalar</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;select 1 from cards where queue = </span><span class="si">{QUEUE_TYPE_MANUALLY_BURIED}</span><span class="s2"> and did in </span><span class="si">%s</span><span class="s2"> limit 1&quot;</span>
            <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_deckLimit</span><span class="p">()</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="ow">not</span> <span class="ow">not</span> <span class="n">cnt</span></div>

<div class="viewcode-block" id="Scheduler.haveBuried"><a class="viewcode-back" href="../../anki.html#anki.schedv2.Scheduler.haveBuried">[docs]</a>    <span class="k">def</span> <span class="nf">haveBuried</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">haveManuallyBuried</span><span class="p">()</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">haveBuriedSiblings</span><span class="p">()</span></div>

    <span class="c1"># Next time reports</span>
    <span class="c1">##########################################################################</span>

<div class="viewcode-block" id="Scheduler.nextIvlStr"><a class="viewcode-back" href="../../anki.html#anki.schedv2.Scheduler.nextIvlStr">[docs]</a>    <span class="k">def</span> <span class="nf">nextIvlStr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">card</span><span class="p">:</span> <span class="n">Card</span><span class="p">,</span> <span class="n">ease</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">short</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="s2">&quot;Return the next interval for CARD as a string.&quot;</span>
        <span class="n">ivl_secs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nextIvl</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">ease</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ivl_secs</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;(end)&quot;</span><span class="p">)</span>
        <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="o">.</span><span class="n">format_timespan</span><span class="p">(</span><span class="n">ivl_secs</span><span class="p">,</span> <span class="n">FormatTimeSpanContext</span><span class="o">.</span><span class="n">ANSWER_BUTTONS</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ivl_secs</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="o">.</span><span class="n">conf</span><span class="p">[</span><span class="s2">&quot;collapseTime&quot;</span><span class="p">]:</span>
            <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;&lt;&quot;</span> <span class="o">+</span> <span class="n">s</span>
        <span class="k">return</span> <span class="n">s</span></div>

<div class="viewcode-block" id="Scheduler.nextIvl"><a class="viewcode-back" href="../../anki.html#anki.schedv2.Scheduler.nextIvl">[docs]</a>    <span class="k">def</span> <span class="nf">nextIvl</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">card</span><span class="p">:</span> <span class="n">Card</span><span class="p">,</span> <span class="n">ease</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
        <span class="s2">&quot;Return the next interval for CARD, in seconds.&quot;</span>
        <span class="c1"># preview mode?</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_previewingCard</span><span class="p">(</span><span class="n">card</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">ease</span> <span class="o">==</span> <span class="n">BUTTON_ONE</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_previewDelay</span><span class="p">(</span><span class="n">card</span><span class="p">)</span>
            <span class="k">return</span> <span class="mi">0</span>

        <span class="c1"># (re)learning?</span>
        <span class="k">if</span> <span class="n">card</span><span class="o">.</span><span class="n">queue</span> <span class="ow">in</span> <span class="p">(</span><span class="n">QUEUE_TYPE_NEW</span><span class="p">,</span> <span class="n">QUEUE_TYPE_LRN</span><span class="p">,</span> <span class="n">QUEUE_TYPE_DAY_LEARN_RELEARN</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nextLrnIvl</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">ease</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">ease</span> <span class="o">==</span> <span class="n">BUTTON_ONE</span><span class="p">:</span>
            <span class="c1"># lapse</span>
            <span class="n">conf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lapseConf</span><span class="p">(</span><span class="n">card</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">conf</span><span class="p">[</span><span class="s2">&quot;delays&quot;</span><span class="p">]:</span>
                <span class="k">return</span> <span class="n">conf</span><span class="p">[</span><span class="s2">&quot;delays&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">60</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lapseIvl</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">conf</span><span class="p">)</span> <span class="o">*</span> <span class="mi">86400</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># review</span>
            <span class="n">early</span> <span class="o">=</span> <span class="n">card</span><span class="o">.</span><span class="n">odid</span> <span class="ow">and</span> <span class="p">(</span><span class="n">card</span><span class="o">.</span><span class="n">odue</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">today</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">early</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_earlyReviewIvl</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">ease</span><span class="p">)</span> <span class="o">*</span> <span class="mi">86400</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nextRevIvl</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">ease</span><span class="p">,</span> <span class="n">fuzz</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="o">*</span> <span class="mi">86400</span></div>

    <span class="c1"># this isn&#39;t easily extracted from the learn code</span>
    <span class="k">def</span> <span class="nf">_nextLrnIvl</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">card</span><span class="p">:</span> <span class="n">Card</span><span class="p">,</span> <span class="n">ease</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">card</span><span class="o">.</span><span class="n">queue</span> <span class="o">==</span> <span class="n">QUEUE_TYPE_NEW</span><span class="p">:</span>
            <span class="n">card</span><span class="o">.</span><span class="n">left</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_startingLeft</span><span class="p">(</span><span class="n">card</span><span class="p">)</span>
        <span class="n">conf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lrnConf</span><span class="p">(</span><span class="n">card</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ease</span> <span class="o">==</span> <span class="n">BUTTON_ONE</span><span class="p">:</span>
            <span class="c1"># fail</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_delayForGrade</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">conf</span><span class="p">[</span><span class="s2">&quot;delays&quot;</span><span class="p">]))</span>
        <span class="k">elif</span> <span class="n">ease</span> <span class="o">==</span> <span class="n">BUTTON_TWO</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_delayForRepeatingGrade</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">card</span><span class="o">.</span><span class="n">left</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">ease</span> <span class="o">==</span> <span class="n">BUTTON_FOUR</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_graduatingIvl</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">conf</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="n">fuzz</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="o">*</span> <span class="mi">86400</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># ease == BUTTON_THREE</span>
            <span class="n">left</span> <span class="o">=</span> <span class="n">card</span><span class="o">.</span><span class="n">left</span> <span class="o">%</span> <span class="mi">1000</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">left</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># graduate</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_graduatingIvl</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">conf</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="n">fuzz</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="o">*</span> <span class="mi">86400</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_delayForGrade</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">left</span><span class="p">)</span>

    <span class="c1"># Suspending &amp; burying</span>
    <span class="c1">##########################################################################</span>

    <span class="c1"># learning and relearning cards may be seconds-based or day-based;</span>
    <span class="c1"># other types map directly to queues</span>
    <span class="n">_restoreQueueSnippet</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">queue = (case when type in (</span><span class="si">{CARD_TYPE_LRN}</span><span class="s2">,</span><span class="si">{CARD_TYPE_RELEARNING}</span><span class="s2">) then</span>
<span class="s2">  (case when (case when odue then odue else due end) &gt; 1000000000 then 1 else</span>
<span class="s2">  </span><span class="si">{QUEUE_TYPE_DAY_LEARN_RELEARN}</span><span class="s2"> end)</span>
<span class="s2">else</span>
<span class="s2">  type</span>
<span class="s2">end)</span>
<span class="s2">&quot;&quot;&quot;</span>

<div class="viewcode-block" id="Scheduler.suspendCards"><a class="viewcode-back" href="../../anki.html#anki.schedv2.Scheduler.suspendCards">[docs]</a>    <span class="k">def</span> <span class="nf">suspendCards</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ids</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="s2">&quot;Suspend cards.&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">ids</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;update cards set queue=</span><span class="si">{QUEUE_TYPE_SUSPENDED}</span><span class="s2">,mod=?,usn=? where id in &quot;</span>
            <span class="o">+</span> <span class="n">ids2str</span><span class="p">(</span><span class="n">ids</span><span class="p">),</span>
            <span class="n">intTime</span><span class="p">(),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="o">.</span><span class="n">usn</span><span class="p">(),</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="Scheduler.unsuspendCards"><a class="viewcode-back" href="../../anki.html#anki.schedv2.Scheduler.unsuspendCards">[docs]</a>    <span class="k">def</span> <span class="nf">unsuspendCards</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ids</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="s2">&quot;Unsuspend cards.&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">ids</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
            <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;update cards set </span><span class="si">%s</span><span class="s2">,mod=?,usn=? where queue = </span><span class="si">{QUEUE_TYPE_SUSPENDED}</span><span class="s2"> and id in </span><span class="si">%s</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_restoreQueueSnippet</span><span class="p">,</span> <span class="n">ids2str</span><span class="p">(</span><span class="n">ids</span><span class="p">)),</span>
            <span class="n">intTime</span><span class="p">(),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="o">.</span><span class="n">usn</span><span class="p">(),</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="Scheduler.buryCards"><a class="viewcode-back" href="../../anki.html#anki.schedv2.Scheduler.buryCards">[docs]</a>    <span class="k">def</span> <span class="nf">buryCards</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cids</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">manual</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">queue</span> <span class="o">=</span> <span class="n">manual</span> <span class="ow">and</span> <span class="n">QUEUE_TYPE_MANUALLY_BURIED</span> <span class="ow">or</span> <span class="n">QUEUE_TYPE_SIBLING_BURIED</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">cids</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">update cards set queue=?,mod=?,usn=? where id in &quot;&quot;&quot;</span>
            <span class="o">+</span> <span class="n">ids2str</span><span class="p">(</span><span class="n">cids</span><span class="p">),</span>
            <span class="n">queue</span><span class="p">,</span>
            <span class="n">intTime</span><span class="p">(),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="o">.</span><span class="n">usn</span><span class="p">(),</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="Scheduler.buryNote"><a class="viewcode-back" href="../../anki.html#anki.schedv2.Scheduler.buryNote">[docs]</a>    <span class="k">def</span> <span class="nf">buryNote</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nid</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="s2">&quot;Bury all cards for note until next session.&quot;</span>
        <span class="n">cids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">list</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;select id from cards where nid = ? and queue &gt;= </span><span class="si">{QUEUE_TYPE_NEW}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">nid</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">buryCards</span><span class="p">(</span><span class="n">cids</span><span class="p">)</span></div>

<div class="viewcode-block" id="Scheduler.unburyCards"><a class="viewcode-back" href="../../anki.html#anki.schedv2.Scheduler.unburyCards">[docs]</a>    <span class="k">def</span> <span class="nf">unburyCards</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="s2">&quot;Unbury all buried cards in all decks.&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">list</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;select id from cards where queue in (</span><span class="si">{QUEUE_TYPE_SIBLING_BURIED}</span><span class="s2">, </span><span class="si">{QUEUE_TYPE_MANUALLY_BURIED}</span><span class="s2">)&quot;</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;update cards set </span><span class="si">%s</span><span class="s2"> where queue in (</span><span class="si">{QUEUE_TYPE_SIBLING_BURIED}</span><span class="s2">, </span><span class="si">{QUEUE_TYPE_MANUALLY_BURIED}</span><span class="s2">)&quot;</span>
            <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_restoreQueueSnippet</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="Scheduler.unburyCardsForDeck"><a class="viewcode-back" href="../../anki.html#anki.schedv2.Scheduler.unburyCardsForDeck">[docs]</a>    <span class="k">def</span> <span class="nf">unburyCardsForDeck</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;all&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">type</span> <span class="o">==</span> <span class="s2">&quot;all&quot;</span><span class="p">:</span>
            <span class="n">queue</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;queue in (</span><span class="si">{QUEUE_TYPE_SIBLING_BURIED}</span><span class="s2">, </span><span class="si">{QUEUE_TYPE_MANUALLY_BURIED}</span><span class="s2">)&quot;</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="nb">type</span> <span class="o">==</span> <span class="s2">&quot;manual&quot;</span><span class="p">:</span>
            <span class="n">queue</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;queue = </span><span class="si">{QUEUE_TYPE_MANUALLY_BURIED}</span><span class="s2">&quot;</span>
        <span class="k">elif</span> <span class="nb">type</span> <span class="o">==</span> <span class="s2">&quot;siblings&quot;</span><span class="p">:</span>
            <span class="n">queue</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;queue = </span><span class="si">{QUEUE_TYPE_SIBLING_BURIED}</span><span class="s2">&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;unknown type&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">list</span><span class="p">(</span>
                <span class="s2">&quot;select id from cards where </span><span class="si">%s</span><span class="s2"> and did in </span><span class="si">%s</span><span class="s2">&quot;</span>
                <span class="o">%</span> <span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_deckLimit</span><span class="p">())</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
            <span class="s2">&quot;update cards set mod=?,usn=?,</span><span class="si">%s</span><span class="s2"> where </span><span class="si">%s</span><span class="s2"> and did in </span><span class="si">%s</span><span class="s2">&quot;</span>
            <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_restoreQueueSnippet</span><span class="p">,</span> <span class="n">queue</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_deckLimit</span><span class="p">()),</span>
            <span class="n">intTime</span><span class="p">(),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="o">.</span><span class="n">usn</span><span class="p">(),</span>
        <span class="p">)</span></div>

    <span class="c1"># Sibling spacing</span>
    <span class="c1">##########################################################################</span>

    <span class="k">def</span> <span class="nf">_burySiblings</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">card</span><span class="p">:</span> <span class="n">Card</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">toBury</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">nconf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_newConf</span><span class="p">(</span><span class="n">card</span><span class="p">)</span>
        <span class="n">buryNew</span> <span class="o">=</span> <span class="n">nconf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;bury&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">rconf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_revConf</span><span class="p">(</span><span class="n">card</span><span class="p">)</span>
        <span class="n">buryRev</span> <span class="o">=</span> <span class="n">rconf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;bury&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="c1"># loop through and remove from queues</span>
        <span class="k">for</span> <span class="n">cid</span><span class="p">,</span> <span class="n">queue</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">select id, queue from cards where nid=? and id!=?</span>
<span class="s2">and (queue=</span><span class="si">{QUEUE_TYPE_NEW}</span><span class="s2"> or (queue=</span><span class="si">{QUEUE_TYPE_REV}</span><span class="s2"> and due&lt;=?))&quot;&quot;&quot;</span><span class="p">,</span>
            <span class="n">card</span><span class="o">.</span><span class="n">nid</span><span class="p">,</span>
            <span class="n">card</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">today</span><span class="p">,</span>
        <span class="p">):</span>
            <span class="k">if</span> <span class="n">queue</span> <span class="o">==</span> <span class="n">QUEUE_TYPE_REV</span><span class="p">:</span>
                <span class="n">queue_obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_revQueue</span>
                <span class="k">if</span> <span class="n">buryRev</span><span class="p">:</span>
                    <span class="n">toBury</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cid</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">queue_obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_newQueue</span>
                <span class="k">if</span> <span class="n">buryNew</span><span class="p">:</span>
                    <span class="n">toBury</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cid</span><span class="p">)</span>

            <span class="c1"># even if burying disabled, we still discard to give same-day spacing</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">queue_obj</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">cid</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="c1"># then bury</span>
        <span class="k">if</span> <span class="n">toBury</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">buryCards</span><span class="p">(</span><span class="n">toBury</span><span class="p">,</span> <span class="n">manual</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="c1"># Resetting</span>
    <span class="c1">##########################################################################</span>

<div class="viewcode-block" id="Scheduler.forgetCards"><a class="viewcode-back" href="../../anki.html#anki.schedv2.Scheduler.forgetCards">[docs]</a>    <span class="k">def</span> <span class="nf">forgetCards</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ids</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="s2">&quot;Put cards at the end of the new queue.&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">remFromDyn</span><span class="p">(</span><span class="n">ids</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;update cards set type=</span><span class="si">{CARD_TYPE_NEW}</span><span class="s2">,queue=</span><span class="si">{QUEUE_TYPE_NEW}</span><span class="s2">,ivl=0,due=0,odue=0,factor=?&quot;</span>
            <span class="s2">&quot; where id in &quot;</span> <span class="o">+</span> <span class="n">ids2str</span><span class="p">(</span><span class="n">ids</span><span class="p">),</span>
            <span class="n">STARTING_FACTOR</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">pmax</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">scalar</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;select max(due) from cards where type=</span><span class="si">{CARD_TYPE_NEW}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="ow">or</span> <span class="mi">0</span>
        <span class="p">)</span>
        <span class="c1"># takes care of mod + usn</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sortCards</span><span class="p">(</span><span class="n">ids</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="n">pmax</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">ids</span><span class="p">)</span></div>

<div class="viewcode-block" id="Scheduler.reschedCards"><a class="viewcode-back" href="../../anki.html#anki.schedv2.Scheduler.reschedCards">[docs]</a>    <span class="k">def</span> <span class="nf">reschedCards</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ids</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">imin</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">imax</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="s2">&quot;Put cards in review queue with a new interval in days (min, max).&quot;</span>
        <span class="n">d</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">today</span>
        <span class="n">mod</span> <span class="o">=</span> <span class="n">intTime</span><span class="p">()</span>
        <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="n">ids</span><span class="p">:</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="n">imin</span><span class="p">,</span> <span class="n">imax</span><span class="p">)</span>
            <span class="n">d</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">r</span><span class="p">),</span> <span class="n">r</span> <span class="o">+</span> <span class="n">t</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="o">.</span><span class="n">usn</span><span class="p">(),</span> <span class="n">mod</span><span class="p">,</span> <span class="n">STARTING_FACTOR</span><span class="p">,</span> <span class="nb">id</span><span class="p">,))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">remFromDyn</span><span class="p">(</span><span class="n">ids</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">executemany</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">update cards set type=</span><span class="si">{CARD_TYPE_REV}</span><span class="s2">,queue=</span><span class="si">{QUEUE_TYPE_REV}</span><span class="s2">,ivl=?,due=?,odue=0,</span>
<span class="s2">usn=?,mod=?,factor=? where id=?&quot;&quot;&quot;</span><span class="p">,</span>
            <span class="n">d</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">ids</span><span class="p">)</span></div>

<div class="viewcode-block" id="Scheduler.resetCards"><a class="viewcode-back" href="../../anki.html#anki.schedv2.Scheduler.resetCards">[docs]</a>    <span class="k">def</span> <span class="nf">resetCards</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ids</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="s2">&quot;Completely reset cards for export.&quot;</span>
        <span class="n">sids</span> <span class="o">=</span> <span class="n">ids2str</span><span class="p">(</span><span class="n">ids</span><span class="p">)</span>
        <span class="c1"># we want to avoid resetting due number of existing new cards on export</span>
        <span class="n">nonNew</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">list</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;select id from cards where id in </span><span class="si">%s</span><span class="s2"> and (queue != </span><span class="si">{QUEUE_TYPE_NEW}</span><span class="s2"> or type != </span><span class="si">{CARD_TYPE_NEW}</span><span class="s2">)&quot;</span>
            <span class="o">%</span> <span class="n">sids</span>
        <span class="p">)</span>
        <span class="c1"># reset all cards</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;update cards set reps=0,lapses=0,odid=0,odue=0,queue=</span><span class="si">{QUEUE_TYPE_NEW}</span><span class="s2">&quot;</span>
            <span class="s2">&quot; where id in </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">sids</span>
        <span class="p">)</span>
        <span class="c1"># and forget any non-new cards, changing their due numbers</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">forgetCards</span><span class="p">(</span><span class="n">nonNew</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">ids</span><span class="p">)</span></div>

    <span class="c1"># Repositioning new cards</span>
    <span class="c1">##########################################################################</span>

<div class="viewcode-block" id="Scheduler.sortCards"><a class="viewcode-back" href="../../anki.html#anki.schedv2.Scheduler.sortCards">[docs]</a>    <span class="k">def</span> <span class="nf">sortCards</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">cids</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span>
        <span class="n">start</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
        <span class="n">step</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
        <span class="n">shuffle</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">shift</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">scids</span> <span class="o">=</span> <span class="n">ids2str</span><span class="p">(</span><span class="n">cids</span><span class="p">)</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">intTime</span><span class="p">()</span>
        <span class="n">nids</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">nidsSet</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="n">cids</span><span class="p">:</span>
            <span class="n">nid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">scalar</span><span class="p">(</span><span class="s2">&quot;select nid from cards where id = ?&quot;</span><span class="p">,</span> <span class="nb">id</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">nid</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">nidsSet</span><span class="p">:</span>
                <span class="n">nids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nid</span><span class="p">)</span>
                <span class="n">nidsSet</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">nid</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">nids</span><span class="p">:</span>
            <span class="c1"># no new cards</span>
            <span class="k">return</span>
        <span class="c1"># determine nid ordering</span>
        <span class="n">due</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">shuffle</span><span class="p">:</span>
            <span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">nids</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">c</span><span class="p">,</span> <span class="n">nid</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">nids</span><span class="p">):</span>
            <span class="n">due</span><span class="p">[</span><span class="n">nid</span><span class="p">]</span> <span class="o">=</span> <span class="n">start</span> <span class="o">+</span> <span class="n">c</span> <span class="o">*</span> <span class="n">step</span>
        <span class="c1"># pylint: disable=undefined-loop-variable</span>
        <span class="n">high</span> <span class="o">=</span> <span class="n">start</span> <span class="o">+</span> <span class="n">c</span> <span class="o">*</span> <span class="n">step</span>
        <span class="c1"># shift?</span>
        <span class="k">if</span> <span class="n">shift</span><span class="p">:</span>
            <span class="n">low</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">scalar</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;select min(due) from cards where due &gt;= ? and type = </span><span class="si">{CARD_TYPE_NEW}</span><span class="s2"> &quot;</span>
                <span class="s2">&quot;and id not in </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">scids</span><span class="p">,</span>
                <span class="n">start</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">low</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">shiftby</span> <span class="o">=</span> <span class="n">high</span> <span class="o">-</span> <span class="n">low</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">update cards set mod=?, usn=?, due=due+? where id not in </span><span class="si">%s</span><span class="s2"></span>
<span class="s2">and due &gt;= ? and queue = </span><span class="si">{QUEUE_TYPE_NEW}</span><span class="s2">&quot;&quot;&quot;</span>
                    <span class="o">%</span> <span class="n">scids</span><span class="p">,</span>
                    <span class="n">now</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="o">.</span><span class="n">usn</span><span class="p">(),</span>
                    <span class="n">shiftby</span><span class="p">,</span>
                    <span class="n">low</span><span class="p">,</span>
                <span class="p">)</span>
        <span class="c1"># reorder cards</span>
        <span class="n">d</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="nb">id</span><span class="p">,</span> <span class="n">nid</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;select id, nid from cards where type = </span><span class="si">{CARD_TYPE_NEW}</span><span class="s2"> and id in &quot;</span> <span class="o">+</span> <span class="n">scids</span>
        <span class="p">):</span>
            <span class="n">d</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">due</span><span class="p">[</span><span class="n">nid</span><span class="p">],</span> <span class="n">now</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="o">.</span><span class="n">usn</span><span class="p">(),</span> <span class="nb">id</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">executemany</span><span class="p">(</span><span class="s2">&quot;update cards set due=?,mod=?,usn=? where id = ?&quot;</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span></div>

<div class="viewcode-block" id="Scheduler.randomizeCards"><a class="viewcode-back" href="../../anki.html#anki.schedv2.Scheduler.randomizeCards">[docs]</a>    <span class="k">def</span> <span class="nf">randomizeCards</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">did</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">cids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">list</span><span class="p">(</span><span class="s2">&quot;select id from cards where did = ?&quot;</span><span class="p">,</span> <span class="n">did</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sortCards</span><span class="p">(</span><span class="n">cids</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>

<div class="viewcode-block" id="Scheduler.orderCards"><a class="viewcode-back" href="../../anki.html#anki.schedv2.Scheduler.orderCards">[docs]</a>    <span class="k">def</span> <span class="nf">orderCards</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">did</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">cids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">list</span><span class="p">(</span><span class="s2">&quot;select id from cards where did = ? order by nid&quot;</span><span class="p">,</span> <span class="n">did</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sortCards</span><span class="p">(</span><span class="n">cids</span><span class="p">)</span></div>

<div class="viewcode-block" id="Scheduler.resortConf"><a class="viewcode-back" href="../../anki.html#anki.schedv2.Scheduler.resortConf">[docs]</a>    <span class="k">def</span> <span class="nf">resortConf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conf</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">did</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="o">.</span><span class="n">decks</span><span class="o">.</span><span class="n">didsForConf</span><span class="p">(</span><span class="n">conf</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">conf</span><span class="p">[</span><span class="s2">&quot;new&quot;</span><span class="p">][</span><span class="s2">&quot;order&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">randomizeCards</span><span class="p">(</span><span class="n">did</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">orderCards</span><span class="p">(</span><span class="n">did</span><span class="p">)</span></div>

    <span class="c1"># for post-import</span>
<div class="viewcode-block" id="Scheduler.maybeRandomizeDeck"><a class="viewcode-back" href="../../anki.html#anki.schedv2.Scheduler.maybeRandomizeDeck">[docs]</a>    <span class="k">def</span> <span class="nf">maybeRandomizeDeck</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">did</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">did</span><span class="p">:</span>
            <span class="n">did</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="o">.</span><span class="n">decks</span><span class="o">.</span><span class="n">selected</span><span class="p">()</span>
        <span class="n">conf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="o">.</span><span class="n">decks</span><span class="o">.</span><span class="n">confForDid</span><span class="p">(</span><span class="n">did</span><span class="p">)</span>
        <span class="c1"># in order due?</span>
        <span class="k">if</span> <span class="n">conf</span><span class="p">[</span><span class="s2">&quot;new&quot;</span><span class="p">][</span><span class="s2">&quot;order&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">NEW_CARDS_RANDOM</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">randomizeCards</span><span class="p">(</span><span class="n">did</span><span class="p">)</span></div>

    <span class="c1"># Changing scheduler versions</span>
    <span class="c1">##########################################################################</span>

    <span class="k">def</span> <span class="nf">_emptyAllFiltered</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">update cards set did = odid, queue = (case</span>
<span class="s2">when type = </span><span class="si">{CARD_TYPE_LRN}</span><span class="s2"> then </span><span class="si">{QUEUE_TYPE_NEW}</span><span class="s2"></span>
<span class="s2">when type = </span><span class="si">{CARD_TYPE_RELEARNING}</span><span class="s2"> then </span><span class="si">{QUEUE_TYPE_REV}</span><span class="s2"></span>
<span class="s2">else type end), type = (case</span>
<span class="s2">when type = </span><span class="si">{CARD_TYPE_LRN}</span><span class="s2"> then </span><span class="si">{CARD_TYPE_NEW}</span><span class="s2"></span>
<span class="s2">when type = </span><span class="si">{CARD_TYPE_RELEARNING}</span><span class="s2"> then </span><span class="si">{CARD_TYPE_REV}</span><span class="s2"></span>
<span class="s2">else type end),</span>
<span class="s2">due = odue, odue = 0, odid = 0, usn = ? where odid != 0&quot;&quot;&quot;</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="o">.</span><span class="n">usn</span><span class="p">(),</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_removeAllFromLearning</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">schedVer</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># remove review cards from relearning</span>
        <span class="k">if</span> <span class="n">schedVer</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    update cards set</span>
<span class="s2">    due = odue, queue = </span><span class="si">{QUEUE_TYPE_REV}</span><span class="s2">, type = </span><span class="si">{CARD_TYPE_REV}</span><span class="s2">, mod = </span><span class="si">%d</span><span class="s2">, usn = </span><span class="si">%d</span><span class="s2">, odue = 0</span>
<span class="s2">    where queue in (</span><span class="si">{QUEUE_TYPE_LRN}</span><span class="s2">,</span><span class="si">{QUEUE_TYPE_DAY_LEARN_RELEARN}</span><span class="s2">) and type in (</span><span class="si">{CARD_TYPE_REV}</span><span class="s2">, </span><span class="si">{CARD_TYPE_RELEARNING}</span><span class="s2">)</span>
<span class="s2">    &quot;&quot;&quot;</span>
                <span class="o">%</span> <span class="p">(</span><span class="n">intTime</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="o">.</span><span class="n">usn</span><span class="p">())</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    update cards set</span>
<span class="s2">    due = </span><span class="si">%d</span><span class="s2">+ivl, queue = </span><span class="si">{QUEUE_TYPE_REV}</span><span class="s2">, type = </span><span class="si">{CARD_TYPE_REV}</span><span class="s2">, mod = </span><span class="si">%d</span><span class="s2">, usn = </span><span class="si">%d</span><span class="s2">, odue = 0</span>
<span class="s2">    where queue in (</span><span class="si">{QUEUE_TYPE_LRN}</span><span class="s2">,</span><span class="si">{QUEUE_TYPE_DAY_LEARN_RELEARN}</span><span class="s2">) and type in (</span><span class="si">{CARD_TYPE_REV}</span><span class="s2">, </span><span class="si">{CARD_TYPE_RELEARNING}</span><span class="s2">)</span>
<span class="s2">    &quot;&quot;&quot;</span>
                <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">today</span><span class="p">,</span> <span class="n">intTime</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="o">.</span><span class="n">usn</span><span class="p">())</span>
            <span class="p">)</span>
        <span class="c1"># remove new cards from learning</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">forgetCards</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">list</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;select id from cards where queue in (</span><span class="si">{QUEUE_TYPE_LRN}</span><span class="s2">,</span><span class="si">{QUEUE_TYPE_DAY_LEARN_RELEARN}</span><span class="s2">)&quot;</span>
            <span class="p">)</span>
        <span class="p">)</span>

    <span class="c1"># v1 doesn&#39;t support buried/suspended (re)learning cards</span>
    <span class="k">def</span> <span class="nf">_resetSuspendedLearning</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">update cards set type = (case</span>
<span class="s2">when type = </span><span class="si">{CARD_TYPE_LRN}</span><span class="s2"> then </span><span class="si">{CARD_TYPE_NEW}</span><span class="s2"></span>
<span class="s2">when type in (</span><span class="si">{CARD_TYPE_REV}</span><span class="s2">, </span><span class="si">{CARD_TYPE_RELEARNING}</span><span class="s2">) then </span><span class="si">{CARD_TYPE_REV}</span><span class="s2"></span>
<span class="s2">else type end),</span>
<span class="s2">due = (case when odue then odue else due end),</span>
<span class="s2">odue = 0,</span>
<span class="s2">mod = </span><span class="si">%d</span><span class="s2">, usn = </span><span class="si">%d</span><span class="s2"></span>
<span class="s2">where queue &lt; </span><span class="si">{QUEUE_TYPE_NEW}</span><span class="s2">&quot;&quot;&quot;</span>
            <span class="o">%</span> <span class="p">(</span><span class="n">intTime</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="o">.</span><span class="n">usn</span><span class="p">())</span>
        <span class="p">)</span>

    <span class="c1"># no &#39;manually buried&#39; queue in v1</span>
    <span class="k">def</span> <span class="nf">_moveManuallyBuried</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;update cards set queue=</span><span class="si">{QUEUE_TYPE_SIBLING_BURIED}</span><span class="s2">,mod=</span><span class="si">%d</span><span class="s2"> where queue=</span><span class="si">{QUEUE_TYPE_MANUALLY_BURIED}</span><span class="s2">&quot;</span>
            <span class="o">%</span> <span class="n">intTime</span><span class="p">()</span>
        <span class="p">)</span>

    <span class="c1"># adding &#39;hard&#39; in v2 scheduler means old ease entries need shifting</span>
    <span class="c1"># up or down</span>
    <span class="k">def</span> <span class="nf">_remapLearningAnswers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sql</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;update revlog set </span><span class="si">%s</span><span class="s2"> and type in (</span><span class="si">{CARD_TYPE_NEW}</span><span class="s2">,</span><span class="si">{CARD_TYPE_REV}</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="n">sql</span>
        <span class="p">)</span>

<div class="viewcode-block" id="Scheduler.moveToV1"><a class="viewcode-back" href="../../anki.html#anki.schedv2.Scheduler.moveToV1">[docs]</a>    <span class="k">def</span> <span class="nf">moveToV1</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_emptyAllFiltered</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_removeAllFromLearning</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_moveManuallyBuried</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_resetSuspendedLearning</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_remapLearningAnswers</span><span class="p">(</span><span class="s2">&quot;ease=ease-1 where ease in (3,4)&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Scheduler.moveToV2"><a class="viewcode-back" href="../../anki.html#anki.schedv2.Scheduler.moveToV2">[docs]</a>    <span class="k">def</span> <span class="nf">moveToV2</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_emptyAllFiltered</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_removeAllFromLearning</span><span class="p">(</span><span class="n">schedVer</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_remapLearningAnswers</span><span class="p">(</span><span class="s2">&quot;ease=ease+1 where ease in (2,3)&quot;</span><span class="p">)</span></div></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2020, Abdelrahman Hamdy

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>